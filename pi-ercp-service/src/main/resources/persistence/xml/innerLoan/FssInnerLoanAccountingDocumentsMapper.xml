<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.personnel.ercp.pi.persistence.mapper.innerLoan.FssInnerLoanAccountingDocumentsMapper">
    <resultMap id="BaseResultMap" type="cn.com.personnel.ercp.pi.persistence.entity.innerLoan.FssInnerLoanAccountingDocuments">
        <!--
          WARNING - @mbg.generated
        -->
        <id column="documents_id" jdbcType="VARCHAR" property="documentsId" />
        <result column="sub_id" jdbcType="VARCHAR" property="subId" />
        <result column="main_id" jdbcType="VARCHAR" property="mainId" />
        <result column="rule_id" jdbcType="VARCHAR" property="ruleId" />
        <result column="contract_name" jdbcType="VARCHAR" property="contractName" />
        <result column="contract_num" jdbcType="VARCHAR" property="contractNum" />
        <result column="organ_id" jdbcType="VARCHAR" property="organId" />
        <result column="organ_name" jdbcType="VARCHAR" property="organName" />
        <result column="summary" jdbcType="VARCHAR" property="summary" />
        <result column="currency_code" jdbcType="VARCHAR" property="currencyCode" />
        <result column="currency" jdbcType="VARCHAR" property="currency" />
        <result column="credit_date" jdbcType="VARCHAR" property="creditDate" />
        <result column="commercian_unit_id" jdbcType="VARCHAR" property="commercianUnitId" />
        <result column="commercian_unit" jdbcType="VARCHAR" property="commercianUnit" />
        <result column="business_module_id" jdbcType="VARCHAR" property="businessModuleId" />
        <result column="business_module" jdbcType="VARCHAR" property="businessModule" />
        <result column="business_type" jdbcType="VARCHAR" property="businessType" />
        <result column="borrow_loan" jdbcType="VARCHAR" property="borrowLoan" />
        <result column="subject" jdbcType="VARCHAR" property="subject" />
        <result column="subject_text" jdbcType="VARCHAR" property="subjectText" />
        <result column="lifnr" jdbcType="VARCHAR" property="lifnr" />
        <result column="lifnr_text" jdbcType="VARCHAR" property="lifnrText" />
        <result column="loan_term" jdbcType="VARCHAR" property="loanTerm" />
        <result column="project_stage" jdbcType="VARCHAR" property="projectStage" />
        <result column="subject_type" jdbcType="VARCHAR" property="subjectType" />
        <result column="project_code" jdbcType="VARCHAR" property="projectCode" />
        <result column="project_name" jdbcType="VARCHAR" property="projectName" />
        <result column="profit_center_code" jdbcType="VARCHAR" property="profitCenterCode" />
        <result column="profit_center" jdbcType="VARCHAR" property="profitCenter" />
        <result column="cost_center_code" jdbcType="VARCHAR" property="costCenterCode" />
        <result column="cost_center" jdbcType="VARCHAR" property="costCenter" />
        <result column="wbs_element_code" jdbcType="VARCHAR" property="wbsElementCode" />
        <result column="wbs_element" jdbcType="VARCHAR" property="wbsElement" />
        <result column="reason_code" jdbcType="VARCHAR" property="reasonCode" />
        <result column="reason_code_text" jdbcType="VARCHAR" property="reasonCodeText" />
        <result column="assigned_number" jdbcType="VARCHAR" property="assignedNumber" />
        <result column="amount" jdbcType="NUMERIC" property="amount" />
        <result column="entry_status" jdbcType="VARCHAR" property="entryStatus" />
        <result column="document_no" jdbcType="VARCHAR" property="documentNo" />
        <result column="message_number" jdbcType="VARCHAR" property="messageNumber" />
        <result column="internal_order" jdbcType="VARCHAR" property="internalOrder" />
        <result column="is_clear" jdbcType="VARCHAR" property="isClear" />
        <result column="type" jdbcType="VARCHAR" property="type" />
        <result column="remarks" jdbcType="VARCHAR" property="remarks" />
        <result column="status" jdbcType="VARCHAR" property="status" />
        <result column="reserve" jdbcType="VARCHAR" property="reserve" />
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
        <result column="creator" jdbcType="VARCHAR" property="creator" />
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
        <result column="updater" jdbcType="VARCHAR" property="updater" />
        <result column="deleted" jdbcType="VARCHAR" property="deleted" />
        <result column="business_type_list" jdbcType="VARCHAR" property="businessTypeList" />
        <result column="subject_type_list" jdbcType="VARCHAR" property="subjectTypeList" />
        <result column="entry_number" jdbcType="VARCHAR" property="entryNumber" />
        <result column="group_no" jdbcType="VARCHAR" property="groupNo" />
        <result column="entry_type" jdbcType="VARCHAR" property="entryType" />
        <result column="expiry_date" jdbcType="VARCHAR" property="expiryDate" />
        <result column="opposite_profit_center_code" jdbcType="VARCHAR" property="oppositeProfitCenterCode" />
        <result column="opposite_profit_center" jdbcType="VARCHAR" property="oppositeProfitCenter" />
        <result column="reversal_sap_no" jdbcType="VARCHAR" property="reversalSapNo" />
        <result column="reversal_status" jdbcType="VARCHAR" property="reversalStatus" />
        <result column="reversal_error_message" jdbcType="VARCHAR" property="reversalErrorMessage" />
        <result column="i_guid" jdbcType="VARCHAR" property="iGuid" />
        <result column="business_partner_id" jdbcType="VARCHAR" property="businessPartnerId" />
        <result column="business_partner" jdbcType="VARCHAR" property="businessPartner" />
        <result column="value_date" jdbcType="VARCHAR" property="valueDate" />
        <result column="anti_accounting_indicator" jdbcType="VARCHAR" property="antiAccountingIndicator" />
        <result column="is_edit" jdbcType="VARCHAR" property="isEdit" />
    </resultMap>
    <select id="queryWithdrawAccounting" resultMap="BaseResultMap">
        select '未入账'                       as entry_status,--入账状态,
               (select cskt.ltext from csks join cskt on csks.kostl =cskt.kostl where csks.kostl =rru.cost_center_code and csks.bukrs =rru.organ_id and csks.datbi >=to_char(current_date,'YYYYMMDD') limit 1 ) as cost_center,--成本中心,
               (select t053s.txt40
                from t053s
                where t053s.bukrs = rru.organ_id
                  and t053s.rstgr = rru.reason_code limit 1) as reason_code_text,--原因码描述,
               case when (rru.lifnr is not null and rru.lifnr != '') then (select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=rru.lifnr limit 1) else
                   case when rru.organ_id=rru.company_id then rru.lender_company_id
                        when rru.organ_id=rru.lender_company_id then rru.company_id end end as business_partner_id,
               case when (rru.lifnr is not null and rru.lifnr != '') then (select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=rru.lifnr limit 1) else
                   case when rru.organ_id=rru.company_id then rru.lender_company_name
                        when rru.organ_id=rru.lender_company_id then rru.company_name end end as business_partner,
               rru.withdraw_amount                   as amount,
               rru.subject_type,
               rru.organ_id,rru.company_id,rru.lender_company_id,
               rru.*
        from (select case when rule.subject_type='财务费用科目' or rule.subject_type='项目费用科目'
                              then case when (select ska1.glaccount_type from t001 join ska1 on t001.ktopl=ska1.ktopl where t001.bukrs=rule.organ_id and ska1.saknr=rule.subject limit 1) ='P'
                                            then case when ((select cost_center_code from fss_accounting_rule where organ_id=rule.organ_id and type='2' limit 1) != ''
                    and (select cost_center_code from fss_accounting_rule where organ_id=rule.organ_id and type='2' limit 1) is not null)
                                                          then (select cost_center_code from fss_accounting_rule where organ_id=rule.organ_id and type='2' limit 1)
                                                      when (rule.cost_center_code !='' and rule.cost_center_code is not null) then
                                                          case when length(rule.cost_center_code)=6 then concat(rule.organ_id,rule.cost_center_code)
                                                               when length(rule.cost_center_code)=4 then concat(ltrim((rule.profit_center_code), '0'),rule.cost_center_code)
                                                               when length(rule.cost_center_code)=10 then rule.cost_center_code end
                                                      else '' end
                                        else '' end
                          else '' end as cost_center_code,    --成本中心编码
                     case
                         when (select skb1.mitkz
                               from skb1
                               where skb1.bukrs = rule.organ_id
                                 and skb1.saknr = rule.subject limit 1) in ('D', 'K')
                             then case when rule.organ_id=rule.company_id then rule.lender_company_id
                                       when rule.organ_id=rule.lender_company_id then rule.company_id
                                       else '' end
                         else '' end    as lifnr,
                     case
                         when (select skb1.mitkz
                               from skb1
                               where skb1.bukrs = rule.organ_id
                                 and skb1.saknr = rule.subject limit 1) in ('D', 'K')
                             then case when rule.organ_id=rule.company_id then rule.lender_company_name
                                       when rule.organ_id=rule.lender_company_id then rule.company_name
                                       else '' end
                         else '' end              as lifnr_text,
                     case
                         when (select skb1.mitkz
                               from skb1
                               where skb1.bukrs = rule.organ_id
                                 and skb1.saknr = rule.subject limit 1) in ('D', 'K')
                             then rule.contract_repayment_date
                         else '' end    as expiry_date,
                     rule.organ_id,
                     rule.organ_name,
                     rule.subject,--科目
--                      rule.subject_text,--科目名称
                     (select skat.txt50
                      from t001 join skat on t001.ktopl=skat.ktopl and skat.spras='1'
                                join skb1 on skat.saknr=skb1.saknr
                      where skb1.saknr=rule.subject and t001.bukrs =rule.organ_id
                      group by skb1.saknr,t001.bukrs,t001.ktopl,skat.txt50
                      order by t001.ktopl
                      limit 1) as subject_text,
                     rule.profit_center_code,--利润中心编码
                     rule.profit_center,--利润中心文本
                     rule.opposite_profit_center_code,
                     rule.opposite_profit_center,
                     rule.rule_id,
                     rule.commercian_unit_id,
                     rule.commercian_unit,
                     rule.business_module_id,
                     rule.business_module,
                     rule.business_type,
                     rule.loan_term,
                     rule.project_stage,
                     rule.borrow_loan,
                     rule.subject_type,
                     rule.project_code,
                     rule.project_name,
                     rule.wbs_element_code,
                     case when rule.wbs_element_code !='' and rule.wbs_element_code is not null then (select post1 from prps p where p.pspnr =rule.wbs_element_code limit 1) else '' end as wbs_element,
                     rule.reason_code,
                     rule.internal_order,
                     rule.is_clear,
                     rule.type,
                     rule.remarks,
                     rule.status,
                     rule.reserve,
                     rule.create_time,
                     rule.creator,
                     rule.update_time,
                     rule.updater,
                     rule.deleted,
                     rule.business_type_list,
                     rule.subject_type_list,
                     rule.tran_type,
                     rule.fw_id,
                     rule.drawer_amount           as withdraw_amount,
                     rule.assigned_number,
                     rule.sub_id,
                     rule.main_id,rule.contract_name,rule.contract_num,
                     rule.summary,rule.project_nature,
                     rule.currency_id,rule.currency_code,rule.currency,rule.credit_date,rule.company_id,rule.lender_company_id,rule.company_name,rule.lender_company_name,rule.value_date
              from (SELECT rr.business_module, -- 业务模块,
                           rr.business_type,   -- 业务类型,
                           rr.borrow_loan,     -- 借或贷,
                           case when rr.subject_type = '银行科目' then to_char(fbto.withdraw_date,'YYYY-MM-DD') else '' end as value_date,
                           case
                               when rr.subject_type = '银行科目'
                                   then case
                                            when (rr.subject = '' or rr.subject is null)
                                                then case
                                                         when o.bukrs = fbi.company_id
                                                             then (select hkont
                                                                   from v_acc_num
                                                                   where acc_num = fbi.borrower_bank_account limit 1)
                                                         when o.bukrs = fbi.lender_company_id
                                                             then (select hkont
                                                                   from v_acc_num
                                                                   where acc_num = fbi.lender_bank_account limit 1)
                                                end
                                            else rr.subject
                                   end
                               else rr.subject
                               end                as subject,
--                            case when (rr.subject = '' or rr.subject is null)
--                                     then
--                                     case when   o.bukrs = fbi.company_id then
--                                              (select txt50
--                                               from v_acc_num
--                                               where acc_num = fbi.borrower_bank_account limit 1)
--                                          when   o.bukrs = fbi.lender_company_id then
--                                              (select txt50
--                                               from v_acc_num
--                                               where acc_num  = fbi.lender_bank_account limit 1)
--                                         end
--                                 else case
--                                          when o.bukrs = fbi.company_id then
--                                              (select skat.txt50
--                                               from skat
--                                                        join t001 on t001.ktopl = skat.ktopl and skat.spras ='1'
--                                               where skat.saknr = rr.subject and t001.bukrs = fbi.company_id)
--                                          when o.bukrs = fbi.lender_company_id  then
--                                              (select skat.txt50
--                                               from skat
--                                                        join t001 on t001.ktopl = skat.ktopl and skat.spras ='1'
--                                               where skat.saknr = rr.subject and t001.bukrs = fbi.lender_company_id)
--                                     end
--                                end as subject_text,

                           case
                               when fbi.company_id = o.bukrs
                                   then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                 then case when (fbi.project_id != '' and fbi.project_id is not null) then fbi.prctr
                                                           else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                           (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                         (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end end
                                             when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                               when fbi.lender_company_id = o.bukrs
                                   then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                 then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                 (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                               (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end
                                             when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                               end                                                                            as profit_center_code,
                           case
                               when fbi.company_id = o.bukrs
                                   then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                 then case when (fbi.project_id != '' and fbi.project_id is not null) then (select ltext from cepct where prctr=fbi.prctr limit 1)
                                                           else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                           (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                         (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end end
                                             when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                               when fbi.lender_company_id = o.bukrs
                                   then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                 then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                 (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                               (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end
                                             when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                               end                                                                            as profit_center,
                           case
                               when fbi.company_id = o.bukrs
                                   then (select case
                                                    when fbi.company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when (fbi.project_id != '' and fbi.project_id is not null) then fbi.prctr
                                                                                else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                                (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                              (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    when fbi.lender_company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                      (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                    (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    end                                                                            as profit_center_code
                                         FROM fss_inner_loan_contract_manage fbi join fss_inner_loan_contract_iou fbto on fbi.manage_id = fbto.manage_id
                                                                                 JOIN v_organ o ON (fbi.company_id = o.bukrs or fbi.lender_company_id=o.bukrs)
                                                                                 JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                                       where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方提款','集团借款借款方提款','贷款方放款')) as rr
                                                                                      ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                                                  and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方提款','集团借款借款方提款','贷款方放款')) then rr.organ_id=o.bukrs
                                                                                               else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end)
                                         WHERE  fbto.iou_id = #{subId}
                                           and o.bukrs=fbi.lender_company_id limit 1)
                               when fbi.lender_company_id = o.bukrs
                                   then (select case
                                                    when fbi.company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when (fbi.project_id != '' and fbi.project_id is not null) then fbi.prctr
                                                                                else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                                (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                              (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    when fbi.lender_company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                      (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                    (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    end                                                                            as profit_center_code
                                         FROM fss_inner_loan_contract_manage fbi join fss_inner_loan_contract_iou fbto on fbi.manage_id = fbto.manage_id
                                                                                 JOIN v_organ o ON (fbi.company_id = o.bukrs or fbi.lender_company_id=o.bukrs)
                                                                                 JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                                       where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方提款','集团借款借款方提款','贷款方放款')) as rr
                                                                                      ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                                                  and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方提款','集团借款借款方提款','贷款方放款')) then rr.organ_id=o.bukrs
                                                                                               else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end)
                                         WHERE  fbto.iou_id = #{subId}
                                           and o.bukrs=fbi.company_id limit 1)
                               end                                                                            as opposite_profit_center_code,
                           case
                               when fbi.company_id = o.bukrs
                                   then (select case
                                                    when fbi.company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when (fbi.project_id != '' and fbi.project_id is not null) then (select ltext from cepct where prctr=fbi.prctr limit 1)
                                                                                else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                                (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                              (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    when fbi.lender_company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                      (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                    (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    end                                                                            as profit_center

                                         FROM fss_inner_loan_contract_manage fbi join fss_inner_loan_contract_iou fbto on fbi.manage_id = fbto.manage_id
                                                                                 JOIN v_organ o ON (fbi.company_id = o.bukrs or fbi.lender_company_id=o.bukrs)
                                                                                 JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                                       where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方提款','集团借款借款方提款','贷款方放款')) as rr
                                                                                      ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                                                  and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方提款','集团借款借款方提款','贷款方放款')) then rr.organ_id=o.bukrs
                                                                                               else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end)
                                         WHERE  fbto.iou_id = #{subId}
                                           and o.bukrs=fbi.lender_company_id limit 1)
                               when fbi.lender_company_id = o.bukrs
                                   then (select case
                                                    when fbi.company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when (fbi.project_id != '' and fbi.project_id is not null) then (select ltext from cepct where prctr=fbi.prctr limit 1)
                                                                                else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                                (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                              (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    when fbi.lender_company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                      (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                    (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    end                                                                            as profit_center

                                         FROM fss_inner_loan_contract_manage fbi join fss_inner_loan_contract_iou fbto on fbi.manage_id = fbto.manage_id
                                                                                 JOIN v_organ o ON (fbi.company_id = o.bukrs or fbi.lender_company_id=o.bukrs)
                                                                                 JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                                       where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方提款','集团借款借款方提款','贷款方放款')) as rr
                                                                                      ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                                                  and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方提款','集团借款借款方提款','贷款方放款')) then rr.organ_id=o.bukrs
                                                                                               else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end)
                                         WHERE  fbto.iou_id = #{subId}
                                           and o.bukrs=fbi.company_id limit 1)
                               end                                                                            as opposite_profit_center,
                           rr.rule_id,
                           rr.commercian_unit_id,
                           rr.commercian_unit,
                           rr.business_module_id,
                           rr.loan_term,
                           rr.project_stage,
                           rr.subject_type,
                           rr.project_code,
                           rr.project_name,
                           rr.cost_center_code,
                           rr.cost_center,
                           case when rr.subject_type = '项目费用科目' and (rr.internal_order is null or rr.internal_order = '') then
                                    case when o.busi = '6000' then concat(fbi.project_id ,rr.wbs_element_code)
                                         when o.busi = '5000' then (select wbs_element_code from fss_accounting_rule where organ_id = o.bukrs and type = '2' order by create_time desc limit 1)
                                         else '' end else '' end wbs_element_code,
                           rr.reason_code,
                           rr.internal_order,
                           rr.is_clear,
                           rr.type,
                           rr.remarks,
                           rr.status,
                           rr.reserve,
                           rr.create_time,
                           rr.creator,
                           rr.update_time,
                           rr.updater,
                           rr.deleted,
                           rr.business_type_list,
                           rr.subject_type_list,
                           rr.tran_type,
                           o.bukrs as organ_id,
                           o.butxt as organ_name,
                           fbi.inner_id                                                                                                  as fw_id,
                           fbto.withdraw_amount                                                                                          as drawer_amount,
                           fbto.loan_end_date                                                                                            as contract_repayment_date,
                           fbi.assigned_number,
                           fbto.iou_id as sub_id,
                           fbi.manage_id as main_id,fbi.contract_name,fbi.contract_num,
                           case when o.bukrs=fbi.company_id then concat('收到', fbi.lender_company_name,'借款')
                                when o.bukrs=fbi.lender_company_id then concat('支付', fbi.company_name,'借款') end as summary,
                           fbi.currency_type_id as currency_id,curr.code as currency_code,fbi.currency_type as currency,fbto.credit_date,fbi.company_id,fbi.lender_company_id,fbi.company_name,fbi.lender_company_name,fbi.project_nature
                    FROM fss_inner_loan_contract_manage fbi join fss_inner_loan_contract_iou fbto on fbi.manage_id = fbto.manage_id
                                                            JOIN v_organ o ON (fbi.company_id = o.bukrs or fbi.lender_company_id=o.bukrs)
                                                            JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                  where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方提款','集团借款借款方提款','贷款方放款')) as rr
                                                                 ON (case when o.bukrs = fbi.lender_company_id and exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                                                                 and r.type = '1'  and r.business_module = '内部借款' and r.business_type ='贷款方放款') then rr.organ_id=fbi.lender_company_id
                                                                          when o.bukrs = fbi.company_id and (select busi from v_organ where bukrs = fbi.company_id limit 1) = (select busi from v_organ where bukrs = fbi.lender_company_id limit 1)
                                                                              and exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                                and r.type = '1'  and r.business_module = '内部借款' and r.business_type ='内部借款借款方提款') then rr.organ_id=fbi.company_id
                                                                          when o.bukrs = fbi.company_id and (select busi from v_organ where bukrs = fbi.company_id limit 1) != (select busi from v_organ where bukrs = fbi.lender_company_id limit 1)
                                                                              and exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                                and r.type = '1'  and r.business_module = '内部借款' and r.business_type ='集团借款借款方提款') then rr.organ_id=fbi.company_id
                                                                          else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end)
                                                            left JOIN v_stonr v on v.objnr = fbi.objnr
                                                            join fss_base_currency curr on fbi.currency_type_id=curr.id
                    WHERE  fbto.iou_id = #{subId}
                      and ((o.busi != '5000' and ((v.stonr in ('10', '20', '30', '40', '50', '60', '70') and (rr.project_stage = '在建' or rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('内部借款借款方提款','集团借款借款方提款'))
                        or ((v.stonr = '80' or v.stonr is null or fbi.project_id is null or fbi.project_id ='')
                            and (rr.project_stage = '运营' or rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('内部借款借款方提款','集团借款借款方提款'))
                        or ((rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('贷款方放款'))))
                        or (o.busi = '5000' and (
                                ((fbi.project_id is not null and fbi.project_id !='' and fbi.project_id like 'F%') and (rr.project_stage = '运营' or rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('内部借款借款方提款','集团借款借款方提款'))
                                or ((fbi.project_id is not null and fbi.project_id !='' and fbi.project_id like 'E%') and v.stonr in ('10', '20', '40', '50', '60') and (rr.project_stage = '在建' or rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('内部借款借款方提款','集团借款借款方提款'))
                                or ((((fbi.project_id is not null and fbi.project_id !='' and fbi.project_id like 'E%') and v.stonr = '30') or v.stonr is null or fbi.project_id is null or fbi.project_id ='')
                                and (rr.project_stage = '运营' or rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('内部借款借款方提款','集团借款借款方提款'))
                                or ((rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('贷款方放款'))
                            )))
                      and
                        ((o.bukrs = fbi.lender_company_id and rr.business_type = '贷款方放款') or
                         (o.bukrs = fbi.company_id and (select busi from v_organ where bukrs = fbi.company_id  limit 1) =
                                                       (select busi from v_organ where bukrs = fbi.lender_company_id limit 1) and
                          rr.business_type = '内部借款借款方提款')
                            or (o.bukrs = fbi.company_id and (select busi from v_organ where bukrs = fbi.company_id limit 1) !=
                                                             (select busi from v_organ where bukrs = fbi.lender_company_id limit 1) and
                                rr.business_type = '集团借款借款方提款'))
                      and ((rr.loan_term = '一年以内' and to_number(fbi.loan_term_year, '99999999999999.99999') &lt;= '1') or (rr.loan_term = '一年以上' and to_number(fbi.loan_term_year, '99999999999999.99999') > '1') or  rr.loan_term = '' or rr.loan_term is null)
                   )
                       as rule
             ) as rru where rru.withdraw_amount>0
        order by rru.business_type,rru.organ_id
    </select>

    <select id="queryRepaymentAccounting" resultMap="BaseResultMap">
        select '未入账'                                 as entry_status,--入账状态,
               (select cskt.ltext from csks join cskt on csks.kostl =cskt.kostl where csks.kostl =rru.cost_center_code and csks.bukrs =rru.organ_id and csks.datbi >=to_char(current_date,'YYYYMMDD') limit 1 ) as cost_center,--成本中心,
               (select t053s.txt40
                from t053s
                where t053s.bukrs = rru.organ_id
                  and t053s.rstgr = rru.reason_code limit 1) as reason_code_text,--原因码描述,
               case when (rru.lifnr is not null and rru.lifnr != '') then (select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=rru.lifnr limit 1) else
                   case when rru.organ_id=rru.company_id then rru.lender_company_id
                        when rru.organ_id=rru.lender_company_id then rru.company_id end end as business_partner_id,
               case when (rru.lifnr is not null and rru.lifnr != '') then (select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=rru.lifnr limit 1) else
                   case when rru.organ_id=rru.company_id then rru.lender_company_name
                        when rru.organ_id=rru.lender_company_id then rru.company_name end end as business_partner,
               rru.repayment_amount                   as amount,
               rru.subject_type,
               rru.*
        from (select case when rule.subject_type='财务费用科目' or rule.subject_type='项目费用科目'
                              then case when (select ska1.glaccount_type from t001 join ska1 on t001.ktopl=ska1.ktopl where t001.bukrs=rule.organ_id and ska1.saknr=rule.subject limit 1) ='P'
                                            then case when ((select cost_center_code from fss_accounting_rule where organ_id=rule.organ_id and type='2' limit 1) != ''
                    and (select cost_center_code from fss_accounting_rule where organ_id=rule.organ_id and type='2' limit 1) is not null)
                                                          then (select cost_center_code from fss_accounting_rule where organ_id=rule.organ_id and type='2' limit 1)
                                                      when (rule.cost_center_code !='' and rule.cost_center_code is not null) then
                                                          case when length(rule.cost_center_code)=6 then concat(rule.organ_id,rule.cost_center_code)
                                                               when length(rule.cost_center_code)=4 then concat(ltrim((rule.profit_center_code), '0'),rule.cost_center_code)
                                                               when length(rule.cost_center_code)=10 then rule.cost_center_code end
                                                      else '' end
                                        else '' end
                          else '' end as cost_center_code,    --成本中心编码
                     case
                         when (select skb1.mitkz
                               from skb1
                               where skb1.bukrs = rule.organ_id
                                 and skb1.saknr = rule.subject limit 1) in ('D', 'K')
                             then case when rule.organ_id=rule.company_id then rule.lender_company_id
                                       when rule.organ_id=rule.lender_company_id then rule.company_id
                                       else '' end
                         else '' end    as lifnr,
                     case
                         when (select skb1.mitkz
                               from skb1
                               where skb1.bukrs = rule.organ_id
                                 and skb1.saknr = rule.subject limit 1) in ('D', 'K')
                             then case when rule.organ_id=rule.company_id then rule.lender_company_name
                                       when rule.organ_id=rule.lender_company_id then rule.company_name
                                       else '' end
                         else '' end              as lifnr_text,
                     case
                         when (select skb1.mitkz
                               from skb1
                               where skb1.bukrs = rule.organ_id
                                 and skb1.saknr = rule.subject limit 1) in ('D', 'K')
                             then rule.contract_repayment_date
                         else '' end    as expiry_date,
                     rule.organ_id,
                     rule.organ_name,
                     rule.subject,--科目
--                      rule.subject_text,--科目名称
                     (select skat.txt50
                      from t001 join skat on t001.ktopl=skat.ktopl and skat.spras='1'
                                join skb1 on skat.saknr=skb1.saknr
                      where skb1.saknr=rule.subject and t001.bukrs =rule.organ_id
                      group by skb1.saknr,t001.bukrs,t001.ktopl,skat.txt50
                      order by t001.ktopl
                      limit 1) as subject_text,
                     rule.profit_center_code,--利润中心编码
                     rule.profit_center,--利润中心文本
                     rule.opposite_profit_center_code,
                     rule.opposite_profit_center,
                     rule.rule_id,
                     rule.commercian_unit_id,
                     rule.commercian_unit,
                     rule.business_module_id,
                     rule.business_module,
                     rule.business_type,
                     rule.loan_term,
                     rule.project_stage,
                     rule.borrow_loan,
                     rule.subject_type,
                     rule.project_code,
                     rule.project_name,
                     rule.wbs_element_code,
                     case when rule.wbs_element_code !='' and rule.wbs_element_code is not null then (select post1 from prps p where p.pspnr =rule.wbs_element_code limit 1) else '' end as wbs_element,
                     rule.reason_code,
                     rule.internal_order,
                     rule.is_clear,
                     rule.type,
                     rule.remarks,
                     rule.status,
                     rule.reserve,
                     rule.create_time,
                     rule.creator,
                     rule.update_time,
                     rule.updater,
                     rule.deleted,
                     rule.business_type_list,
                     rule.subject_type_list,
                     rule.tran_type,
                     rule.fw_id,
                     rule.repayment_amount,
                     rule.assigned_number,
                     rule.sub_id,
                     rule.main_id,rule.contract_name,rule.contract_num,
                     rule.summary,rule.project_nature,
                     rule.currency_id,rule.currency_code,rule.currency,rule.credit_date,rule.company_id,rule.lender_company_id,rule.company_name,rule.lender_company_name,rule.value_date,rule.project_id
              from (SELECT frr.business_module, -- 业务模块,
                           frr.business_type,   -- 业务类型,
                           frr.borrow_loan,     -- 借或贷,
                           case when frr.subject_type = '银行科目' then to_char(frr.withdraw_date,'YYYY-MM-DD') else '' end as value_date,
                           case
                               when frr.subject_type = '银行科目'
                                   then case
                                            when (frr.subject = '' or frr.subject is null)
                                                then case
                                                         when frr.bukrs = frr.company_id
                                                             then (select hkont
                                                                   from v_acc_num
                                                                   where acc_num = frr.borrower_bank_account limit 1)
                                                         when frr.bukrs = frr.lender_company_id
                                                             then (select hkont
                                                                   from v_acc_num
                                                                   where acc_num = frr.lender_bank_account limit 1)
                                                end
                                            else frr.subject
                                   end
                               else frr.subject
                               end                as subject,
--                            case when (frr.subject = '' or frr.subject is null)
--                                     then
--                                     case when   frr.bukrs = frr.company_id then
--                                              (select txt50
--                                               from v_acc_num
--                                               where acc_num = frr.borrower_bank_account limit 1)
--                                          when   frr.bukrs = frr.lender_company_id then
--                                              (select txt50
--                                               from v_acc_num
--                                               where acc_num  = frr.lender_bank_account limit 1)
--                                         end
--                                 else case
--                                          when frr.bukrs = frr.company_id then
--                                              (select skat.txt50
--                                               from skat
--                                                        join t001 on t001.ktopl = skat.ktopl and skat.spras ='1'
--                                               where skat.saknr = frr.subject and t001.bukrs = frr.company_id)
--                                          when frr.bukrs = frr.lender_company_id  then
--                                              (select skat.txt50
--                                               from skat
--                                                        join t001 on t001.ktopl = skat.ktopl and skat.spras ='1'
--                                               where skat.saknr = frr.subject and t001.bukrs = frr.lender_company_id)
--                                     end
--                                end as subject_text,

                           case
                               when frr.company_id = frr.bukrs
                                   then case when ((select count(0) from cepc_bukrs where bukrs=frr.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=frr.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=frr.bukrs) >1)
                                                 then case when (frr.project_id != '' and frr.project_id is not null) then frr.prctr
                                                           else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = frr.bukrs and type = '2') is not null and
                                                                           (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = frr.bukrs and type = '2') !='') then
                                                                         (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = frr.bukrs and type = '2') else frr.profit_center_code end end
                                             when (select count(0) from cepc_bukrs where bukrs=frr.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=frr.bukrs) end
                               when frr.lender_company_id = frr.bukrs
                                   then case when ((select count(0) from cepc_bukrs where bukrs=frr.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=frr.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=frr.bukrs) >1)
                                                 then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = frr.bukrs and type = '2') is not null and
                                                                 (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = frr.bukrs and type = '2') !='') then
                                                               (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = frr.bukrs and type = '2') else frr.profit_center_code end
                                             when (select count(0) from cepc_bukrs where bukrs=frr.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=frr.bukrs) end
                               end                                                                            as profit_center_code,
                           case
                               when frr.company_id = frr.bukrs
                                   then case when ((select count(0) from cepc_bukrs where bukrs=frr.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=frr.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=frr.bukrs) >1)
                                                 then case when (frr.project_id != '' and frr.project_id is not null) then (select ltext from cepct where prctr=frr.prctr limit 1)
                                                           else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = frr.bukrs and type = '2') is not null and
                                                                           (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = frr.bukrs and type = '2') !='') then
                                                                         (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = frr.bukrs and type = '2') else frr.profit_center end end
                                             when (select count(0) from cepc_bukrs where bukrs=frr.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=frr.bukrs) end
                               when frr.lender_company_id = frr.bukrs
                                   then case when ((select count(0) from cepc_bukrs where bukrs=frr.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=frr.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=frr.bukrs) >1)
                                                 then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = frr.bukrs and type = '2') is not null and
                                                                 (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = frr.bukrs and type = '2') !='') then
                                                               (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = frr.bukrs and type = '2') else frr.profit_center end
                                             when (select count(0) from cepc_bukrs where bukrs=frr.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=frr.bukrs) end
                               end                                                                            as profit_center,
                           case
                               when frr.company_id = frr.bukrs
                                   then (select case
                                                    when fbi1.company_id = o1.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o1.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o1.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o1.bukrs) >1)
                                                                      then case when (fbi1.project_id != '' and fbi1.project_id is not null) then fbi1.prctr
                                                                                else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') is not null and
                                                                                                (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') !='') then
                                                                                              (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') else rr1.profit_center_code end end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o1.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o1.bukrs) end
                                                    when fbi1.lender_company_id = o1.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o1.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o1.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o1.bukrs) >1)
                                                                      then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') is not null and
                                                                                      (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') !='') then
                                                                                    (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') else rr1.profit_center_code end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o1.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o1.bukrs) end
                                                    end                                                                            as profit_center_code
                                         FROM fss_inner_loan_contract_manage fbi1 join fss_inner_loan_contract_repayment fbto1 on fbi1.manage_id = fbto1.manage_id
                                                                                  JOIN v_organ o1 ON (fbi1.company_id = o1.bukrs or fbi1.lender_company_id=o1.bukrs)
                                                                                  JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                                        where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方还款','集团借款借款方还款','贷款方收款')) as rr1
                                                                                       ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o1.bukrs
                                                                                                                                                   and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方还款','集团借款借款方还款','贷款方收款')) then rr1.organ_id=o1.bukrs
                                                                                                else rr1.code=o1.busi and (rr1.organ_id is null or rr1.organ_id = '') end)
                                         WHERE  fbto1.repayment_id = #{subId}
                                           and o1.bukrs=frr.lender_company_id limit 1)
                               when frr.lender_company_id = frr.bukrs
                                   then (select case
                                                    when fbi1.company_id = o1.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o1.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o1.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o1.bukrs) >1)
                                                                      then case when (fbi1.project_id != '' and fbi1.project_id is not null) then fbi1.prctr
                                                                                else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') is not null and
                                                                                                (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') !='') then
                                                                                              (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') else rr1.profit_center_code end end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o1.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o1.bukrs) end
                                                    when fbi1.lender_company_id = o1.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o1.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o1.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o1.bukrs) >1)
                                                                      then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') is not null and
                                                                                      (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') !='') then
                                                                                    (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') else rr1.profit_center_code end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o1.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o1.bukrs) end
                                                    end                                                                            as profit_center_code
                                         FROM fss_inner_loan_contract_manage fbi1 join fss_inner_loan_contract_repayment fbto1 on fbi1.manage_id = fbto1.manage_id
                                                                                  JOIN v_organ o1 ON (fbi1.company_id = o1.bukrs or fbi1.lender_company_id=o1.bukrs)
                                                                                  JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                                        where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方还款','集团借款借款方还款','贷款方收款')) as rr1
                                                                                       ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o1.bukrs
                                                                                                                                                   and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方还款','集团借款借款方还款','贷款方收款')) then rr1.organ_id=o1.bukrs
                                                                                                else rr1.code=o1.busi and (rr1.organ_id is null or rr1.organ_id = '') end)
                                         WHERE  fbto1.repayment_id = #{subId}
                                           and o1.bukrs=frr.company_id limit 1)
                               end                                                                            as opposite_profit_center_code,
                           case
                               when frr.company_id = frr.bukrs
                                   then (select case
                                                    when fbi1.company_id = o1.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o1.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o1.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o1.bukrs) >1)
                                                                      then case when (fbi1.project_id != '' and fbi1.project_id is not null) then (select ltext from cepct where prctr=fbi1.prctr limit 1)
                                                                                else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') is not null and
                                                                                                (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') !='') then
                                                                                              (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') else rr1.profit_center end end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o1.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o1.bukrs) end
                                                    when fbi1.lender_company_id = o1.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o1.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o1.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o1.bukrs) >1)
                                                                      then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') is not null and
                                                                                      (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') !='') then
                                                                                    (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') else rr1.profit_center end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o1.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o1.bukrs) end
                                                    end                                                                            as profit_center

                                         FROM fss_inner_loan_contract_manage fbi1 join fss_inner_loan_contract_repayment fbto1 on fbi1.manage_id = fbto1.manage_id
                                                                                  JOIN v_organ o1 ON (fbi1.company_id = o1.bukrs or fbi1.lender_company_id=o1.bukrs)
                                                                                  JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                                        where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方还款','集团借款借款方还款','贷款方收款')) as rr1
                                                                                       ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o1.bukrs
                                                                                                                                                   and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方还款','集团借款借款方还款','贷款方收款')) then rr1.organ_id=o1.bukrs
                                                                                                else rr1.code=o1.busi and (rr1.organ_id is null or rr1.organ_id = '') end)
                                         WHERE  fbto1.repayment_id = #{subId}
                                           and o1.bukrs=frr.lender_company_id limit 1)
                               when frr.lender_company_id = frr.bukrs
                                   then (select case
                                                    when fbi1.company_id = o1.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o1.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o1.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o1.bukrs) >1)
                                                                      then case when (fbi1.project_id != '' and fbi1.project_id is not null) then (select ltext from cepct where prctr=fbi1.prctr limit 1)
                                                                                else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') is not null and
                                                                                                (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') !='') then
                                                                                              (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') else rr1.profit_center end end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o1.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o1.bukrs) end
                                                    when fbi1.lender_company_id = o1.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o1.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o1.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o1.bukrs) >1)
                                                                      then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') is not null and
                                                                                      (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') !='') then
                                                                                    (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o1.bukrs and type = '2') else rr1.profit_center end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o1.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o1.bukrs) end
                                                    end                                                                            as profit_center

                                         FROM fss_inner_loan_contract_manage fbi1 join fss_inner_loan_contract_repayment fbto1 on fbi1.manage_id = fbto1.manage_id
                                                                                  JOIN v_organ o1 ON (fbi1.company_id = o1.bukrs or fbi1.lender_company_id=o1.bukrs)
                                                                                  JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                                        where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方还款','集团借款借款方还款','贷款方收款')) as rr1
                                                                                       ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o1.bukrs
                                                                                                                                                   and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方还款','集团借款借款方还款','贷款方收款')) then rr1.organ_id=o1.bukrs
                                                                                                else rr1.code=o1.busi and (rr1.organ_id is null or rr1.organ_id = '') end)
                                         WHERE  fbto1.repayment_id = #{subId}
                                           and o1.bukrs=frr.company_id limit 1)
                               end                                                                            as opposite_profit_center,
                           frr.rule_id,
                           frr.commercian_unit_id,
                           frr.commercian_unit,
                           frr.business_module_id,
                           frr.loan_term,
                           frr.project_stage,
                           frr.subject_type,
                           frr.project_code,
                           frr.project_name,
                           frr.cost_center_code,
                           frr.cost_center,
                           case when frr.subject_type = '项目费用科目' and (frr.internal_order is null or frr.internal_order = '') then
                                    case when frr.busi = '6000' then concat(frr.project_id ,frr.wbs_element_code)
                                         when frr.busi = '5000' then (select wbs_element_code from fss_accounting_rule where organ_id = frr.bukrs and type = '2' order by create_time desc limit 1)
                                         else '' end else '' end wbs_element_code,
                           frr.reason_code,
                           frr.internal_order,
                           frr.is_clear,
                           frr.type,
                           frr.remarks,
                           frr.status,
                           frr.reserve,
                           frr.create_time,
                           frr.creator,
                           frr.update_time,
                           frr.updater,
                           frr.deleted,
                           frr.business_type_list,
                           frr.subject_type_list,
                           frr.tran_type,
                           frr.bukrs as organ_id,frr.butxt as organ_name,
                           frr.inner_id                                                                                                  as fw_id,
                           case when frr.subject_type = '银行科目' then frr.this_repayment_amount else frr.repayment_amount end           as repayment_amount,
                           frr.loan_end_date                                                                                           as contract_repayment_date,
                           frr.credit_date as credit_date,
                           frr.assigned_number,
                           frr.repayment_id as sub_id,
                           frr.manage_id as main_id,frr.contract_name,frr.contract_num,
                           case when frr.bukrs=frr.company_id then concat('支付', frr.lender_company_name,'借款本金')
                                when frr.bukrs=frr.lender_company_id then concat('收到', frr.company_name,'借款本金') end as summary,frr.project_nature,
                           frr.currency_type_id as currency_id,curr.code as currency_code,frr.currency_type as currency,frr.company_id,frr.lender_company_id,frr.company_name,frr.lender_company_name,frr.project_id
                    from (
                             select fbi.inner_id,fbi.loan_end_date,fbi.assigned_number,fbi.manage_id,fbi.contract_name,fbi.contract_num,fbi.currency_type_id,fbi.currency_type,fbi.company_id,fbi.lender_company_id,
                                    fbi.company_name,fbi.lender_company_name,fbi.objnr,fbi.loan_term_year,fbi.borrower_bank_account,fbi.lender_bank_account,fbi.project_id,fbi.prctr,fbto.repayment_amount,fbto.credit_date,fbto.repayment_id,
                                    o.bukrs,o.butxt,o.busi,rr.*,null as this_repayment_amount,null as withdraw_date,fbi.project_nature
                             FROM fss_inner_loan_contract_manage fbi join fss_inner_loan_contract_repayment fbto on fbi.manage_id=fbto.manage_id
                                 --join fss_inner_loan_contract_repayment_item filcri on filcri.main_id =fbto.repayment_id join fss_inner_loan_contract_iou filci on filci.iou_id =filcri.iou_id
                                                                     JOIN v_organ o ON (fbi.company_id = o.bukrs or fbi.lender_company_id=o.bukrs)
                                                                     JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                           where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方还款','集团借款借款方还款','贷款方收款') and r.subject_type != '银行科目') as rr
                                                                          ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                                      and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方还款','集团借款借款方还款','贷款方收款')) then rr.organ_id=o.bukrs
                                                                                   else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end)
                             union all
                             select fbi.inner_id,fbi.loan_end_date,fbi.assigned_number,fbi.manage_id,fbi.contract_name,fbi.contract_num,fbi.currency_type_id,fbi.currency_type,fbi.company_id,fbi.lender_company_id,
                                    fbi.company_name,fbi.lender_company_name,fbi.objnr,fbi.loan_term_year,fbi.borrower_bank_account,fbi.lender_bank_account,fbi.project_id,fbi.prctr,fbto.repayment_amount,fbto.credit_date,fbto.repayment_id,
                                    o.bukrs,o.butxt,o.busi,rr.*,filcri.this_repayment_amount,filci.withdraw_date,fbi.project_nature
                             FROM fss_inner_loan_contract_manage fbi join fss_inner_loan_contract_repayment fbto on fbi.manage_id = fbto.manage_id
                                                                     join fss_inner_loan_contract_repayment_item filcri on filcri.main_id =fbto.repayment_id join fss_inner_loan_contract_iou filci on filci.iou_id =filcri.iou_id
                                                                     JOIN v_organ o ON (fbi.company_id = o.bukrs or fbi.lender_company_id=o.bukrs)
                                                                     JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                           where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方还款','集团借款借款方还款','贷款方收款') and r.subject_type = '银行科目') as rr
                                                                          ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                                      and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方还款','集团借款借款方还款','贷款方收款')) then rr.organ_id=o.bukrs
                                                                                   else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end)
                         ) as frr
                             left JOIN v_stonr v on v.objnr = frr.objnr
                             join fss_base_currency curr on frr.currency_type_id=curr.id
                    WHERE  frr.repayment_id = #{subId}
                      and ((frr.busi != '5000' and ((v.stonr in ('10', '20', '30', '40', '50', '60', '70') and (frr.project_stage = '在建' or frr.project_stage = '' or frr.project_stage is null) and frr.business_type in('内部借款借款方还款','集团借款借款方还款'))
                        or ((v.stonr = '80' or v.stonr is null or frr.project_id is null or frr.project_id ='')
                            and (frr.project_stage = '运营' or frr.project_stage = '' or frr.project_stage is null) and frr.business_type in('内部借款借款方还款','集团借款借款方还款'))
                        or ((frr.project_stage = '' or frr.project_stage is null) and frr.business_type in('贷款方收款'))))
                        or (frr.busi = '5000' and (
                                ((frr.project_id is not null and frr.project_id !='' and frr.project_id like 'F%') and (frr.project_stage = '运营' or frr.project_stage = '' or frr.project_stage is null) and frr.business_type in('内部借款借款方还款','集团借款借款方还款'))
                                or ((frr.project_id is not null and frr.project_id !='' and frr.project_id like 'E%') and v.stonr in ('10', '20', '40', '50', '60')
                                and (frr.project_stage = '在建' or frr.project_stage = '' or frr.project_stage is null) and frr.business_type in('内部借款借款方还款','集团借款借款方还款'))
                                or ((((frr.project_id is not null and frr.project_id !='' and frr.project_id like 'E%') and v.stonr = '30') or v.stonr is null or frr.project_id is null or frr.project_id ='')
                                and (frr.project_stage = '运营' or frr.project_stage = '' or frr.project_stage is null) and frr.business_type in('内部借款借款方还款','集团借款借款方还款'))
                                or ((frr.project_stage = '' or frr.project_stage is null) and frr.business_type in('贷款方收款'))
                            )))
                      and
                        ((frr.bukrs = frr.lender_company_id and frr.business_type = '贷款方收款') or
                         (frr.bukrs = frr.company_id and (select busi from v_organ where bukrs = frr.company_id limit 1) =
                                                         (select busi from v_organ where bukrs = frr.lender_company_id limit 1) and
                          frr.business_type = '内部借款借款方还款')
                            or (frr.bukrs = frr.company_id and (select busi from v_organ where bukrs = frr.company_id limit 1) !=
                                                               (select busi from v_organ where bukrs = frr.lender_company_id limit 1) and
                                frr.business_type = '集团借款借款方还款'))
                      and ((frr.loan_term = '一年以内' and to_number(frr.loan_term_year, '99999999999999.99999') &lt;= '1') or (frr.loan_term = '一年以上' and to_number(frr.loan_term_year, '99999999999999.99999') > '1') or  frr.loan_term = '' or frr.loan_term is null)
                   )
                       as rule
             ) as rru where rru.repayment_amount>0
        order by rru.business_type,rru.organ_id
    </select>
    <select id="queryPreWithdrawAccounting" resultMap="BaseResultMap">
        select '未入账'                                 as entry_status,--入账状态,
               (select cskt.ltext from csks join cskt on csks.kostl =cskt.kostl where csks.kostl =rru.cost_center_code and csks.bukrs =rru.organ_id and csks.datbi >=to_char(current_date,'YYYYMMDD')  limit 1) as cost_center,--成本中心,
               (select t053s.txt40
                from t053s
                where t053s.bukrs = rru.organ_id
                  and t053s.rstgr = rru.reason_code limit 1) as reason_code_text,--原因码描述,
               case when (rru.lifnr is not null and rru.lifnr != '') then (select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=rru.lifnr limit 1) else
                   case when rru.organ_id=rru.company_id then rru.lender_company_id
                        when rru.organ_id=rru.lender_company_id then rru.company_id end end as business_partner_id,
               case when (rru.lifnr is not null and rru.lifnr != '') then (select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=rru.lifnr limit 1) else
                   case when rru.organ_id=rru.company_id then rru.lender_company_name
                        when rru.organ_id=rru.lender_company_id then rru.company_name end end as business_partner,
               rru.withdraw_amount                   as amount,
               rru.subject_type,
               rru.*
        from (select case when rule.subject_type='财务费用科目' or rule.subject_type='项目费用科目'
                              then case when (select ska1.glaccount_type from t001 join ska1 on t001.ktopl=ska1.ktopl where t001.bukrs=rule.organ_id and ska1.saknr=rule.subject limit 1) ='P'
                                            then case when ((select cost_center_code from fss_accounting_rule where organ_id=rule.organ_id and profit_center_code=rule.profit_center_code and type='2' limit 1) != ''
                    and (select cost_center_code from fss_accounting_rule where organ_id=rule.organ_id and profit_center_code=rule.profit_center_code and type='2' limit 1) is not null)
                                                          then (select cost_center_code from fss_accounting_rule where organ_id=rule.organ_id and profit_center_code=rule.profit_center_code and type='2' limit 1)
                                                      when (rule.cost_center_code !='' and rule.cost_center_code is not null) then
                                                          case when length(rule.cost_center_code)=6 then concat(rule.organ_id,rule.cost_center_code)
                                                               when length(rule.cost_center_code)=4 then concat(ltrim((rule.profit_center_code), '0'),rule.cost_center_code)
                                                               when length(rule.cost_center_code)=10 then rule.cost_center_code end
                                                      else '' end
                                        else '' end
                          else '' end as cost_center_code,    --成本中心编码
                     case
                         when (select skb1.mitkz
                               from skb1
                               where skb1.bukrs = rule.organ_id
                                 and skb1.saknr = rule.subject limit 1) in ('D', 'K')
                             then case when rule.organ_id=rule.company_id then rule.lender_company_id
                                       when rule.organ_id=rule.lender_company_id then rule.company_id
                                       else '' end
                         else '' end    as lifnr,
                     case
                         when (select skb1.mitkz
                               from skb1
                               where skb1.bukrs = rule.organ_id
                                 and skb1.saknr = rule.subject limit 1) in ('D', 'K')
                             then case when rule.organ_id=rule.company_id then rule.lender_company_name
                                       when rule.organ_id=rule.lender_company_id then rule.company_name
                                       else '' end
                         else '' end              as lifnr_text,
                     case
                         when (select skb1.mitkz
                               from skb1
                               where skb1.bukrs = rule.organ_id
                                 and skb1.saknr = rule.subject limit 1) in ('D', 'K')
                             then rule.contract_repayment_date
                         else '' end    as expiry_date,
                     rule.organ_id,
                     rule.organ_name,
                     rule.subject,--科目
--                      rule.subject_text,--科目名称
                     (select skat.txt50
                      from t001 join skat on t001.ktopl=skat.ktopl and skat.spras='1'
                                join skb1 on skat.saknr=skb1.saknr
                      where skb1.saknr=rule.subject and t001.bukrs =rule.organ_id
                      group by skb1.saknr,t001.bukrs,t001.ktopl,skat.txt50
                      order by t001.ktopl
                      limit 1) as subject_text,
                     rule.profit_center_code,--利润中心编码
                     rule.profit_center,--利润中心文本
                     rule.opposite_profit_center_code,
                     rule.opposite_profit_center,
                     rule.anti_accounting_indicator,
                     rule.rule_id,
                     rule.commercian_unit_id,
                     rule.commercian_unit,
                     rule.business_module_id,
                     rule.business_module,
                     rule.business_type,
                     rule.loan_term,
                     rule.project_stage,
                     rule.borrow_loan,
                     rule.subject_type,
                     rule.project_code,
                     rule.project_name,
                     rule.wbs_element_code,
                     case when rule.wbs_element_code !='' and rule.wbs_element_code is not null then (select post1 from prps p where p.pspnr =rule.wbs_element_code limit 1) else '' end as wbs_element,
                     rule.reason_code,
                     rule.internal_order,
                     rule.is_clear,
                     rule.type,
                     rule.remarks,
                     rule.status,
                     rule.reserve,
                     rule.create_time,
                     rule.creator,
                     rule.update_time,
                     rule.updater,
                     rule.deleted,
                     rule.business_type_list,
                     rule.subject_type_list,
                     rule.tran_type,
                     rule.fw_id,
                     rule.repayment_amount           as withdraw_amount,
                     rule.assigned_number,
                     rule.sub_id,
                     rule.main_id,rule.contract_name,rule.contract_num,
                     rule.summary,rule.project_nature,
                     rule.currency_id,rule.currency_code,rule.currency,rule.credit_date,rule.company_id,rule.lender_company_id,rule.company_name,rule.lender_company_name
              from (SELECT rr.business_module, -- 业务模块,
                           rr.business_type,   -- 业务类型,
                           rr.borrow_loan,     -- 借或贷,
                           case when rr.subject_type = '财务费用科目' and rr.business_type ='贷款方预提' then 'X' else '' end as anti_accounting_indicator,    -- 反记账标识,
                           case
                               when rr.subject_type = '银行科目'
                                   then case
                                            when (rr.subject = '' or rr.subject is null)
                                                then case
                                                         when o.bukrs = fbi.company_id
                                                             then (select hkont
                                                                   from v_acc_num
                                                                   where acc_num = fbi.borrower_bank_account limit 1)
                                                         when o.bukrs = fbi.lender_company_id
                                                             then (select hkont
                                                                   from v_acc_num
                                                                   where acc_num = fbi.lender_bank_account limit 1)
                                                end
                                            else rr.subject
                                   end
                               else rr.subject
                               end                as subject,
--                            case when (rr.subject = '' or rr.subject is null)
--                                     then
--                                     case when   o.bukrs = fbi.company_id then
--                                              (select txt50
--                                               from v_acc_num
--                                               where acc_num = fbi.borrower_bank_account limit 1)
--                                          when   o.bukrs = fbi.lender_company_id then
--                                              (select txt50
--                                               from v_acc_num
--                                               where acc_num  = fbi.lender_bank_account limit 1)
--                                         end
--                                 else case
--                                          when o.bukrs = fbi.company_id then
--                                              (select skat.txt50
--                                               from skat
--                                                        join t001 on t001.ktopl = skat.ktopl and skat.spras ='1'
--                                               where skat.saknr = rr.subject and t001.bukrs = fbi.company_id)
--                                          when o.bukrs = fbi.lender_company_id  then
--                                              (select skat.txt50
--                                               from skat
--                                                        join t001 on t001.ktopl = skat.ktopl and skat.spras ='1'
--                                               where skat.saknr = rr.subject and t001.bukrs = fbi.lender_company_id)
--                                     end
--                                end as subject_text,

                           case
                               when fbi.company_id = o.bukrs
                                   then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                 then case when (fbi.project_id != '' and fbi.project_id is not null) then fbi.prctr
                                                           else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                           (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                         (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end end
                                             when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                               when fbi.lender_company_id = o.bukrs
                                   then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                 then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                 (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                               (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end
                                             when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                               end                                                                            as profit_center_code,
                           case
                               when fbi.company_id = o.bukrs
                                   then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                 then case when (fbi.project_id != '' and fbi.project_id is not null) then (select ltext from cepct where prctr=fbi.prctr limit 1)
                                                           else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                           (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                         (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end end
                                             when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                               when fbi.lender_company_id = o.bukrs
                                   then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                 then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                 (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                               (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end
                                             when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                               end                                                                            as profit_center,
                           case
                               when fbi.company_id = o.bukrs
                                   then (select case
                                                    when fbi.company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when (fbi.project_id != '' and fbi.project_id is not null) then fbi.prctr
                                                                                else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                                (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                              (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    when fbi.lender_company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                      (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                    (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    end                                                                            as profit_center_code
                                         FROM fss_inner_loan_contract_manage fbi join fss_inner_loan_contract_pre_withdraw fbto on fbi.manage_id = fbto.manage_id
                                                                                 JOIN v_organ o ON (fbi.company_id = o.bukrs or fbi.lender_company_id=o.bukrs)
                                                                                 JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                                       where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方预提','集团借款借款方预提','贷款方预提')) as rr
                                                                                      ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                                                  and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方预提','集团借款借款方预提','贷款方预提')) then rr.organ_id=o.bukrs
                                                                                               else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end)
                                         WHERE  fbto.pre_withdraw_id = #{subId}
                                           and o.bukrs=fbi.lender_company_id limit 1)
                               when fbi.lender_company_id = o.bukrs
                                   then (select case
                                                    when fbi.company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when (fbi.project_id != '' and fbi.project_id is not null) then fbi.prctr
                                                                                else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                                (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                              (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    when fbi.lender_company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                      (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                    (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    end                                                                            as profit_center_code
                                         FROM fss_inner_loan_contract_manage fbi join fss_inner_loan_contract_pre_withdraw fbto on fbi.manage_id = fbto.manage_id
                                                                                 JOIN v_organ o ON (fbi.company_id = o.bukrs or fbi.lender_company_id=o.bukrs)
                                                                                 JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                                       where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方预提','集团借款借款方预提','贷款方预提')) as rr
                                                                                      ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                                                  and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方预提','集团借款借款方预提','贷款方预提')) then rr.organ_id=o.bukrs
                                                                                               else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end)
                                         WHERE  fbto.pre_withdraw_id = #{subId}
                                           and o.bukrs=fbi.company_id limit 1)
                               end                                                                            as opposite_profit_center_code,
                           case
                               when fbi.company_id = o.bukrs
                                   then (select case
                                                    when fbi.company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when (fbi.project_id != '' and fbi.project_id is not null) then (select ltext from cepct where prctr=fbi.prctr limit 1)
                                                                                else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                                (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                              (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    when fbi.lender_company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                      (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                    (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    end                                                                            as profit_center

                                         FROM fss_inner_loan_contract_manage fbi join fss_inner_loan_contract_pre_withdraw fbto on fbi.manage_id = fbto.manage_id
                                                                                 JOIN v_organ o ON (fbi.company_id = o.bukrs or fbi.lender_company_id=o.bukrs)
                                                                                 JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                                       where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方预提','集团借款借款方预提','贷款方预提')) as rr
                                                                                      ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                                                  and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方预提','集团借款借款方预提','贷款方预提')) then rr.organ_id=o.bukrs
                                                                                               else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end)
                                         WHERE  fbto.pre_withdraw_id = #{subId}
                                           and o.bukrs=fbi.lender_company_id limit 1)
                               when fbi.lender_company_id = o.bukrs
                                   then (select case
                                                    when fbi.company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when (fbi.project_id != '' and fbi.project_id is not null) then (select ltext from cepct where prctr=fbi.prctr limit 1)
                                                                                else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                                (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                              (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    when fbi.lender_company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                      (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                    (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    end                                                                            as profit_center

                                         FROM fss_inner_loan_contract_manage fbi join fss_inner_loan_contract_pre_withdraw fbto on fbi.manage_id = fbto.manage_id
                                                                                 JOIN v_organ o ON (fbi.company_id = o.bukrs or fbi.lender_company_id=o.bukrs)
                                                                                 JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                                       where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方预提','集团借款借款方预提','贷款方预提')) as rr
                                                                                      ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                                                  and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方预提','集团借款借款方预提','贷款方预提')) then rr.organ_id=o.bukrs
                                                                                               else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end)
                                         WHERE  fbto.pre_withdraw_id = #{subId}
                                           and o.bukrs=fbi.company_id limit 1)
                               end                                                                            as opposite_profit_center,
                           rr.rule_id,
                           rr.commercian_unit_id,
                           rr.commercian_unit,
                           rr.business_module_id,
                           rr.loan_term,
                           rr.project_stage,
                           rr.subject_type,
                           rr.project_code,
                           rr.project_name,
                           rr.cost_center_code,
                           rr.cost_center,
                           case when rr.subject_type = '项目费用科目' and (rr.internal_order is null or rr.internal_order = '') then
                                    case when o.busi = '6000' then concat(fbi.project_id ,rr.wbs_element_code)
                                         when o.busi = '5000' then (select wbs_element_code from fss_accounting_rule where organ_id = o.bukrs and type = '2' order by create_time desc limit 1)
                                         else '' end else '' end wbs_element_code,
                           rr.reason_code,
                           rr.internal_order,
                           rr.is_clear,
                           rr.type,
                           rr.remarks,
                           rr.status,
                           rr.reserve,
                           rr.create_time,
                           rr.creator,
                           rr.update_time,
                           rr.updater,
                           rr.deleted,
                           rr.business_type_list,
                           rr.subject_type_list,
                           rr.tran_type,
                           o.bukrs as organ_id,o.butxt as organ_name,
                           fbi.inner_id                                                                                                  as fw_id,
                           case when rr.subject_type = '待转销项税科目' and rr.business_type ='贷款方预提' and fbto.pre_with_draw_amount is not null then round(fbto.pre_with_draw_amount/1.06*0.06,2)
                                when rr.subject_type = '财务费用科目' and rr.business_type ='贷款方预提' and fbto.pre_with_draw_amount is not null
                                    then fbto.pre_with_draw_amount-( select round(coalesce(fbto1.pre_with_draw_amount,0)/1.06*0.06,2)
                                                                     FROM fss_inner_loan_contract_manage fbi1 join fss_inner_loan_contract_pre_withdraw fbto1 on fbi1.manage_id = fbto1.manage_id
                                                                                                              JOIN v_organ o1 ON (fbi1.company_id = o1.bukrs or fbi1.lender_company_id=o1.bukrs)
                                                                                                              JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                                                                    where r.type = '1'  and r.business_module = '内部借款' and r.business_type ='贷款方预提' and r.subject_type = '待转销项税科目') as rr1
                                                                                                                   ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o1.bukrs
                                                                                                                                                                               and r.type = '1'  and r.business_module = '内部借款' and r.business_type ='贷款方预提' and r.subject_type = '待转销项税科目') then rr1.organ_id=o1.bukrs
                                                                                                                            else rr1.code=o1.busi and (rr1.organ_id is null or rr1.organ_id = '') end)
                                                                     WHERE  fbto1.pre_withdraw_id = #{subId} and o1.bukrs=o.bukrs) else fbto.pre_with_draw_amount
                               end as repayment_amount,
                           fbi.loan_end_date                                                                                           as contract_repayment_date,
                           fbto.credit_date as credit_date,
                           fbi.assigned_number,
                           fbto.pre_withdraw_id as sub_id,
                           fbi.project_id,
                           fbi.manage_id as main_id,fbi.contract_name,fbi.contract_num,
                           case when o.bukrs=fbi.company_id then concat('计提', fbi.lender_company_name,'借款利息')
                                when o.bukrs=fbi.lender_company_id then concat('计提', fbi.company_name,'借款利息') end as summary,fbi.project_nature,
                           fbi.currency_type_id as currency_id,curr.code as currency_code,fbi.currency_type as currency,fbi.company_id,fbi.lender_company_id,fbi.company_name,fbi.lender_company_name
                    FROM fss_inner_loan_contract_manage fbi join fss_inner_loan_contract_pre_withdraw fbto on fbi.manage_id = fbto.manage_id
                                                            JOIN v_organ o ON (fbi.company_id = o.bukrs or fbi.lender_company_id=o.bukrs)
                                                            JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                  where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方预提','集团借款借款方预提','贷款方预提')) as rr
                                                                 ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                             and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方预提','集团借款借款方预提','贷款方预提')) then rr.organ_id=o.bukrs
                                                                          else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end)
                                                            left JOIN v_stonr v on v.objnr = fbi.objnr
                                                            join fss_base_currency curr on fbi.currency_type_id=curr.id
                    WHERE  fbto.pre_withdraw_id = #{subId}
                      and ((o.busi != '5000' and ((v.stonr in ('10', '20', '30', '40', '50', '60', '70') and (rr.project_stage = '在建' or rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('内部借款借款方预提','集团借款借款方预提'))
                        or ((v.stonr = '80' or v.stonr is null or fbi.project_id is null or fbi.project_id ='')
                            and (rr.project_stage = '运营' or rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('内部借款借款方预提','集团借款借款方预提'))
                        or ((rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('贷款方预提'))))
                        or (o.busi = '5000' and (
                                ((fbi.project_id is not null and fbi.project_id !='' and fbi.project_id like 'F%') and (rr.project_stage = '运营' or rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('内部借款借款方预提','集团借款借款方预提'))
                                or ((fbi.project_id is not null and fbi.project_id !='' and fbi.project_id like 'E%') and v.stonr in ('10', '20', '40', '50', '60') and (rr.project_stage = '在建' or rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('内部借款借款方预提','集团借款借款方预提'))
                                or ((((fbi.project_id is not null and fbi.project_id !='' and fbi.project_id like 'E%') and v.stonr = '30') or v.stonr is null or fbi.project_id is null or fbi.project_id ='')
                                and (rr.project_stage = '运营' or rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('内部借款借款方预提','集团借款借款方预提'))
                                or ((rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('贷款方预提'))
                            )))
                      and
                        ((o.bukrs = fbi.lender_company_id and rr.business_type = '贷款方预提') or
                         (o.bukrs = fbi.company_id and (select busi from v_organ where bukrs = fbi.company_id limit 1) =
                                                       (select busi from v_organ where bukrs = fbi.lender_company_id limit 1) and
                          rr.business_type = '内部借款借款方预提')
                            or (o.bukrs = fbi.company_id and (select busi from v_organ where bukrs = fbi.company_id limit 1) !=
                                                             (select busi from v_organ where bukrs = fbi.lender_company_id limit 1) and
                                rr.business_type = '集团借款借款方预提'))
                      and ((rr.loan_term = '一年以内' and to_number(fbi.loan_term_year, '99999999999999.99999') &lt;= '1') or (rr.loan_term = '一年以上' and to_number(fbi.loan_term_year, '99999999999999.99999') > '1') or  rr.loan_term = '' or rr.loan_term is null)
                   )
                       as rule
             ) as rru where rru.withdraw_amount>0
        order by rru.business_type,rru.organ_id
    </select>

    <select id="queryPayIntrestAccounting" resultMap="BaseResultMap">
        select '未入账'                                 as entry_status,--入账状态,
               (select cskt.ltext from csks join cskt on csks.kostl =cskt.kostl where csks.kostl =rru.cost_center_code and csks.bukrs =rru.organ_id and csks.datbi >=to_char(current_date,'YYYYMMDD') limit 1) as cost_center,--成本中心,
               (select t053s.txt40
                from t053s
                where t053s.bukrs = rru.organ_id
                  and t053s.rstgr = rru.reason_code limit 1) as reason_code_text,--原因码描述,
               case when (rru.lifnr is not null and rru.lifnr != '') then (select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=rru.lifnr limit 1) else
                   case when rru.organ_id=rru.company_id then rru.lender_company_id
                        when rru.organ_id=rru.lender_company_id then rru.company_id end end as business_partner_id,
               case when (rru.lifnr is not null and rru.lifnr != '') then (select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=rru.lifnr limit 1) else
                   case when rru.organ_id=rru.company_id then rru.lender_company_name
                        when rru.organ_id=rru.lender_company_id then rru.company_name end end as business_partner,
               rru.withdraw_amount                   as amount,
               rru.subject_type,
               rru.*
        from (select case when rule.subject_type='财务费用科目' or rule.subject_type='项目费用科目'
                              then case when (select ska1.glaccount_type from t001 join ska1 on t001.ktopl=ska1.ktopl where t001.bukrs=rule.organ_id and ska1.saknr=rule.subject limit 1) ='P'
                                            then case when ((select cost_center_code from fss_accounting_rule where organ_id=rule.organ_id and type='2' limit 1) != ''
                    and (select cost_center_code from fss_accounting_rule where organ_id=rule.organ_id and type='2' limit 1) is not null)
                                                          then (select cost_center_code from fss_accounting_rule where organ_id=rule.organ_id and type='2' limit 1)
                                                      when (rule.cost_center_code !='' and rule.cost_center_code is not null) then
                                                          case when length(rule.cost_center_code)=6 then concat(rule.organ_id,rule.cost_center_code)
                                                               when length(rule.cost_center_code)=4 then concat(ltrim((rule.profit_center_code), '0'),rule.cost_center_code)
                                                               when length(rule.cost_center_code)=10 then rule.cost_center_code end
                                                      else '' end
                                        else '' end
                          else '' end as cost_center_code,    --成本中心编码
                     case
                         when (select skb1.mitkz
                               from skb1
                               where skb1.bukrs = rule.organ_id
                                 and skb1.saknr = rule.subject limit 1) in ('D', 'K')
                             then case when rule.organ_id=rule.company_id then rule.lender_company_id
                                       when rule.organ_id=rule.lender_company_id then rule.company_id
                                       else '' end
                         else '' end    as lifnr,
                     case
                         when (select skb1.mitkz
                               from skb1
                               where skb1.bukrs = rule.organ_id
                                 and skb1.saknr = rule.subject limit 1) in ('D', 'K')
                             then case when rule.organ_id=rule.company_id then rule.lender_company_name
                                       when rule.organ_id=rule.lender_company_id then rule.company_name
                                       else '' end
                         else '' end              as lifnr_text,
                     case
                         when (select skb1.mitkz
                               from skb1
                               where skb1.bukrs = rule.organ_id
                                 and skb1.saknr = rule.subject limit 1) in ('D', 'K')
                             then rule.contract_repayment_date
                         else '' end    as expiry_date,
                     rule.organ_id,
                     rule.organ_name,
                     rule.subject,--科目
--                      rule.subject_text,--科目名称
                     (select skat.txt50
                      from t001 join skat on t001.ktopl=skat.ktopl and skat.spras='1'
                                join skb1 on skat.saknr=skb1.saknr
                      where skb1.saknr=rule.subject and t001.bukrs =rule.organ_id
                      group by skb1.saknr,t001.bukrs,t001.ktopl,skat.txt50
                      order by t001.ktopl
                      limit 1) as subject_text,
                     rule.profit_center_code,--利润中心编码
                     rule.profit_center,--利润中心文本
                     rule.opposite_profit_center_code,
                     rule.opposite_profit_center,
                     rule.rule_id,
                     rule.commercian_unit_id,
                     rule.commercian_unit,
                     rule.business_module_id,
                     rule.business_module,
                     rule.business_type,
                     rule.loan_term,
                     rule.project_stage,
                     rule.borrow_loan,
                     rule.subject_type,
                     rule.project_code,
                     rule.project_name,
                     rule.wbs_element_code,
                     case when rule.wbs_element_code !='' and rule.wbs_element_code is not null then (select post1 from prps p where p.pspnr =rule.wbs_element_code limit 1) else '' end as wbs_element,
                     rule.reason_code,
                     rule.internal_order,
                     rule.is_clear,
                     rule.type,
                     rule.remarks,
                     rule.status,
                     rule.reserve,
                     rule.create_time,
                     rule.creator,
                     rule.update_time,
                     rule.updater,
                     rule.deleted,
                     rule.business_type_list,
                     rule.subject_type_list,
                     rule.tran_type,
                     rule.fw_id,
                     rule.withdraw_amount,
                     rule.assigned_number,
                     rule.sub_id,
                     rule.main_id,rule.contract_name,rule.contract_num,
                     rule.summary,rule.project_nature,
                     rule.currency_id,rule.currency_code,rule.currency,rule.credit_date,rule.company_id,rule.lender_company_id,rule.company_name,rule.lender_company_name
              from (SELECT rr.business_module, -- 业务模块,
                           rr.business_type,   -- 业务类型,
                           rr.borrow_loan,     -- 借或贷,
                           case
                               when rr.subject_type = '银行科目'
                                   then case
                                            when (rr.subject = '' or rr.subject is null)
                                                then case
                                                         when o.bukrs = fbi.company_id
                                                             then (select hkont
                                                                   from v_acc_num
                                                                   where acc_num = fbi.borrower_bank_account limit 1)
                                                         when o.bukrs = fbi.lender_company_id
                                                             then (select hkont
                                                                   from v_acc_num
                                                                   where acc_num = fbi.lender_bank_account limit 1)
                                                end
                                            else rr.subject
                                   end
                               else rr.subject
                               end                as subject,
--                            case when (rr.subject = '' or rr.subject is null)
--                                     then
--                                     case when   o.bukrs = fbi.company_id then
--                                              (select txt50
--                                               from v_acc_num
--                                               where acc_num = fbi.borrower_bank_account limit 1)
--                                          when   o.bukrs = fbi.lender_company_id then
--                                              (select txt50
--                                               from v_acc_num
--                                               where acc_num  = fbi.lender_bank_account limit 1)
--                                         end
--                                 else case
--                                          when o.bukrs = fbi.company_id then
--                                              (select skat.txt50
--                                               from skat
--                                                        join t001 on t001.ktopl = skat.ktopl and skat.spras ='1'
--                                               where skat.saknr = rr.subject and t001.bukrs = fbi.company_id)
--                                          when o.bukrs = fbi.lender_company_id  then
--                                              (select skat.txt50
--                                               from skat
--                                                        join t001 on t001.ktopl = skat.ktopl and skat.spras ='1'
--                                               where skat.saknr = rr.subject and t001.bukrs = fbi.lender_company_id)
--                                     end
--                                end as subject_text,

                           case
                               when fbi.company_id = o.bukrs
                                   then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                 then case when (fbi.project_id != '' and fbi.project_id is not null) then fbi.prctr
                                                           else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                           (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                         (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end end
                                             when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                               when fbi.lender_company_id = o.bukrs
                                   then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                 then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                 (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                               (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end
                                             when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                               end                                                                            as profit_center_code,
                           case
                               when fbi.company_id = o.bukrs
                                   then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                 then case when (fbi.project_id != '' and fbi.project_id is not null) then (select ltext from cepct where prctr=fbi.prctr limit 1)
                                                           else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                           (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                         (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end end
                                             when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                               when fbi.lender_company_id = o.bukrs
                                   then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                 then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                 (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                               (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end
                                             when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                               end                                                                            as profit_center,
                           case
                               when fbi.company_id = o.bukrs
                                   then (select case
                                                    when fbi.company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when (fbi.project_id != '' and fbi.project_id is not null) then fbi.prctr
                                                                                else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                                (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                              (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    when fbi.lender_company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                      (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                    (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    end                                                                            as profit_center_code
                                         FROM fss_inner_loan_contract_manage fbi join fss_inner_loan_contract_pay_interest fbto on fbi.manage_id = fbto.manage_id
                                                                                 JOIN v_organ o ON (fbi.company_id = o.bukrs or fbi.lender_company_id=o.bukrs)
                                                                                 JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                                       where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方付息','集团借款借款方付息','贷款方付息')) as rr
                                                                                      ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                                                  and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方付息','集团借款借款方付息','贷款方付息')) then rr.organ_id=o.bukrs
                                                                                               else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end)
                                         WHERE  fbto.interest_id = #{subId}
                                           and o.bukrs=fbi.lender_company_id limit 1)
                               when fbi.lender_company_id = o.bukrs
                                   then (select case
                                                    when fbi.company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when (fbi.project_id != '' and fbi.project_id is not null) then fbi.prctr
                                                                                else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                                (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                              (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    when fbi.lender_company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                      (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                    (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center_code end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.prctr from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    end                                                                            as profit_center_code
                                         FROM fss_inner_loan_contract_manage fbi join fss_inner_loan_contract_pay_interest fbto on fbi.manage_id = fbto.manage_id
                                                                                 JOIN v_organ o ON (fbi.company_id = o.bukrs or fbi.lender_company_id=o.bukrs)
                                                                                 JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                                       where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方付息','集团借款借款方付息','贷款方付息')) as rr
                                                                                      ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                                                  and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方付息','集团借款借款方付息','贷款方付息')) then rr.organ_id=o.bukrs
                                                                                               else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end)
                                         WHERE  fbto.interest_id = #{subId}
                                           and o.bukrs=fbi.company_id limit 1)
                               end                                                                            as opposite_profit_center_code,
                           case
                               when fbi.company_id = o.bukrs
                                   then (select case
                                                    when fbi.company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when (fbi.project_id != '' and fbi.project_id is not null) then (select ltext from cepct where prctr=fbi.prctr limit 1)
                                                                                else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                                (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                              (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    when fbi.lender_company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                      (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                    (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    end                                                                            as profit_center

                                         FROM fss_inner_loan_contract_manage fbi join fss_inner_loan_contract_pay_interest fbto on fbi.manage_id = fbto.manage_id
                                                                                 JOIN v_organ o ON (fbi.company_id = o.bukrs or fbi.lender_company_id=o.bukrs)
                                                                                 JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                                       where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方付息','集团借款借款方付息','贷款方付息')) as rr
                                                                                      ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                                                  and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方付息','集团借款借款方付息','贷款方付息')) then rr.organ_id=o.bukrs
                                                                                               else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end)
                                         WHERE  fbto.interest_id = #{subId}
                                           and o.bukrs=fbi.lender_company_id limit 1)
                               when fbi.lender_company_id = o.bukrs
                                   then (select case
                                                    when fbi.company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when (fbi.project_id != '' and fbi.project_id is not null) then (select ltext from cepct where prctr=fbi.prctr limit 1)
                                                                                else case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                                (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                              (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    when fbi.lender_company_id = o.bukrs
                                                        then case when ((select count(0) from cepc_bukrs where bukrs=o.bukrs) is null or (select count(0) from cepc_bukrs where bukrs=o.bukrs)=0 or (select count(0) from cepc_bukrs where bukrs=o.bukrs) >1)
                                                                      then case when ((select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                      (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') !='') then
                                                                                    (select ru.profit_center_code from fss_accounting_rule ru where ru.organ_id = o.bukrs and type = '2') else rr.profit_center end
                                                                  when (select count(0) from cepc_bukrs where bukrs=o.bukrs)=1 then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=o.bukrs) end
                                                    end                                                                            as profit_center

                                         FROM fss_inner_loan_contract_manage fbi join fss_inner_loan_contract_pay_interest fbto on fbi.manage_id = fbto.manage_id
                                                                                 JOIN v_organ o ON (fbi.company_id = o.bukrs or fbi.lender_company_id=o.bukrs)
                                                                                 JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                                       where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方付息','集团借款借款方付息','贷款方付息')) as rr
                                                                                      ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                                                  and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方付息','集团借款借款方付息','贷款方付息')) then rr.organ_id=o.bukrs
                                                                                               else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end)
                                         WHERE  fbto.interest_id = #{subId}
                                           and o.bukrs=fbi.company_id limit 1)
                               end                                                                            as opposite_profit_center,
                           rr.rule_id,
                           rr.commercian_unit_id,
                           rr.commercian_unit,
                           rr.business_module_id,
                           rr.loan_term,
                           rr.project_stage,
                           rr.subject_type,
                           rr.project_code,
                           rr.project_name,
                           rr.cost_center_code,
                           rr.cost_center,
                           case when rr.subject_type = '项目费用科目' and (rr.internal_order is null or rr.internal_order = '') then
                                    case when o.busi = '6000' then concat(fbi.project_id ,rr.wbs_element_code)
                                         when o.busi = '5000' then (select wbs_element_code from fss_accounting_rule where organ_id = o.bukrs and type = '2' order by create_time desc limit 1)
                                         else '' end else '' end wbs_element_code,
                           rr.reason_code,
                           rr.internal_order,
                           rr.is_clear,
                           rr.type,
                           rr.remarks,
                           rr.status,
                           rr.reserve,
                           rr.create_time,
                           rr.creator,
                           rr.update_time,
                           rr.updater,
                           rr.deleted,
                           rr.business_type_list,
                           rr.subject_type_list,
                           rr.tran_type,
                           o.bukrs as organ_id,o.butxt as organ_name,
                           fbi.inner_id                                                                                                  as fw_id,
                           fbto.pay_interest_amount     as withdraw_amount,
                           fbi.loan_end_date                                                                                            as contract_repayment_date,
                           fbi.assigned_number,
                           fbto.interest_id as sub_id,
                           fbi.manage_id as main_id,fbi.contract_name,fbi.contract_num,
                           case when o.bukrs=fbi.company_id then concat('支付', fbi.lender_company_name,'借款利息')
                                when o.bukrs=fbi.lender_company_id then concat('收到', fbi.company_name,'借款利息') end as summary,fbi.project_nature,
                           fbi.currency_type_id as currency_id,curr.code as currency_code,fbi.currency_type as currency,fbto.credit_date,fbi.company_id,fbi.lender_company_id,fbi.company_name,fbi.lender_company_name
                    FROM fss_inner_loan_contract_manage fbi join fss_inner_loan_contract_pay_interest fbto on fbi.manage_id = fbto.manage_id
                                                            JOIN v_organ o ON (fbi.company_id = o.bukrs or fbi.lender_company_id=o.bukrs)
                                                            JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
                                                                  where r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方付息','集团借款借款方付息','贷款方付息')) as rr
                                                                 ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
                                                                                                                             and r.type = '1'  and r.business_module = '内部借款' and r.business_type in('内部借款借款方付息','集团借款借款方付息','贷款方付息')) then rr.organ_id=o.bukrs
                                                                          else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end)
                                                            left JOIN v_stonr v on v.objnr = fbi.objnr
                                                            join fss_base_currency curr on fbi.currency_type_id=curr.id
                    WHERE  fbto.interest_id = #{subId}
                      and ((o.busi != '5000' and ((v.stonr in ('10', '20', '30', '40', '50', '60', '70') and (rr.project_stage = '在建' or rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('内部借款借款方付息','集团借款借款方付息'))
                        or ((v.stonr = '80' or v.stonr is null or fbi.project_id is null or fbi.project_id ='')
                            and (rr.project_stage = '运营' or rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('内部借款借款方付息','集团借款借款方付息'))
                        or ((rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('贷款方付息'))))
                        or (o.busi = '5000' and (
                                ((fbi.project_id is not null and fbi.project_id !='' and fbi.project_id like 'F%') and (rr.project_stage = '运营' or rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('内部借款借款方付息','集团借款借款方付息'))
                                or ((fbi.project_id is not null and fbi.project_id !='' and fbi.project_id like 'E%') and v.stonr in ('10', '20', '40', '50', '60') and (rr.project_stage = '在建' or rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('内部借款借款方付息','集团借款借款方付息'))
                                or ((((fbi.project_id is not null and fbi.project_id !='' and fbi.project_id like 'E%') and v.stonr = '30') or v.stonr is null or fbi.project_id is null or fbi.project_id ='')
                                and (rr.project_stage = '运营' or rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('内部借款借款方付息','集团借款借款方付息'))
                                or ((rr.project_stage = '' or rr.project_stage is null) and rr.business_type in('贷款方付息'))
                            )))
                      and
                        ((o.bukrs = fbi.lender_company_id and rr.business_type = '贷款方付息') or
                         (o.bukrs = fbi.company_id and (select busi from v_organ where bukrs = fbi.company_id limit 1) =
                                                       (select busi from v_organ where bukrs = fbi.lender_company_id limit 1) and
                          rr.business_type = '内部借款借款方付息')
                            or (o.bukrs = fbi.company_id and (select busi from v_organ where bukrs = fbi.company_id limit 1) !=
                                                             (select busi from v_organ where bukrs = fbi.lender_company_id limit 1) and
                                rr.business_type = '集团借款借款方付息'))
                      and ((rr.loan_term = '一年以内' and to_number(fbi.loan_term_year, '99999999999999.99999') &lt;= '1') or (rr.loan_term = '一年以上' and to_number(fbi.loan_term_year, '99999999999999.99999') > '1') or  rr.loan_term = '' or rr.loan_term is null)
                   )
                       as rule
             ) as rru where rru.withdraw_amount>0
        order by rru.business_type,rru.organ_id
    </select>

    <select id="queryEntryNumberBySapNo" resultType="java.lang.String">
        select entry_number from fss_inner_loan_accounting_documents where document_no=#{documentNo} limit 1
    </select>

    <select id="queryReversalByGroupNo" resultMap="BaseResultMap">
        select * from fss_inner_loan_accounting_documents
        <where>
            <if test="fssInnerLoanAccountingDocuments.groupNo != null and fssInnerLoanAccountingDocuments.groupNo != ''">
                group_no=#{fssInnerLoanAccountingDocuments.groupNo}
            </if>
            <if test="fssInnerLoanAccountingDocuments.subId != null and fssInnerLoanAccountingDocuments.subId != ''">
                and sub_id=#{fssInnerLoanAccountingDocuments.subId}
            </if>
            <if test="fssInnerLoanAccountingDocuments.entryStatus != null and fssInnerLoanAccountingDocuments.entryStatus != ''">
                and entry_status=#{fssInnerLoanAccountingDocuments.entryStatus}
            </if>
            <if test="fssInnerLoanAccountingDocuments.type != null and fssInnerLoanAccountingDocuments.type != ''">
                and entry_type =#{fssInnerLoanAccountingDocuments.type}
            </if>
            <if test="fssInnerLoanAccountingDocuments.reversalStatus != null and fssInnerLoanAccountingDocuments.reversalStatus != ''">
                and reversal_status=#{fssInnerLoanAccountingDocuments.reversalStatus}
            </if>
            <if test="fssInnerLoanAccountingDocuments.reversalStatus == null or fssInnerLoanAccountingDocuments.reversalStatus == ''">
                and (reversal_status is null or reversal_status='' or reversal_status = '未冲销')
            </if>
            <if test="nos != null and nos.size &gt; 0">
                and document_no in
                <foreach collection="nos" item="no" separator="," open="(" close=")">#{no}</foreach>
            </if>
        </where>
    </select>

    <update id="updateIGuid">
        update fss_inner_loan_accounting_documents set i_guid = #{iGuid} where sub_id=#{subId} and document_no=#{documentNo}
    </update>

    <select id="selectNotNeedChange" resultMap="BaseResultMap">
        select * from fss_inner_loan_accounting_documents where (entry_status='已入账' or is_edit='1') and group_no=#{groupNo}
    </select>

    <delete id="deleteAccountingDocuments">
        delete from fss_inner_loan_accounting_documents where sub_id=#{subId} and entry_status='未入账' and (is_edit !='1' or is_edit is null) and entry_type=#{entryType}
    </delete>
</mapper>