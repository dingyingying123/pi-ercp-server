<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.com.personnel.ercp.pi.persistence.mapper.receivable.FssFactoringBillreceAllocationMapper">
    <resultMap id="BaseResultMap"
               type="cn.com.personnel.ercp.pi.persistence.entity.receivable.FssFactoringBillreceAllocation">
        <!--
          WARNING - @mbg.generated
        -->
        <id column="documents_id" jdbcType="VARCHAR" property="documentsId"/>
        <result column="sub_id" jdbcType="VARCHAR" property="subId"/>
        <result column="main_id" jdbcType="VARCHAR" property="mainId"/>
        <result column="rule_id" jdbcType="VARCHAR" property="ruleId"/>
        <result column="organ_id" jdbcType="VARCHAR" property="organId"/>
        <result column="organ_name" jdbcType="VARCHAR" property="organName"/>
        <result column="summary" jdbcType="VARCHAR" property="summary"/>
        <result column="currency_code" jdbcType="VARCHAR" property="currencyCode"/>
        <result column="currency" jdbcType="VARCHAR" property="currency"/>
        <result column="credit_date" jdbcType="VARCHAR" property="creditDate"/>
        <result column="commercian_unit_id" jdbcType="VARCHAR" property="commercianUnitId"/>
        <result column="commercian_unit" jdbcType="VARCHAR" property="commercianUnit"/>
        <result column="business_module_id" jdbcType="VARCHAR" property="businessModuleId"/>
        <result column="business_module" jdbcType="VARCHAR" property="businessModule"/>
        <result column="business_type" jdbcType="VARCHAR" property="businessType"/>
        <result column="borrow_loan" jdbcType="VARCHAR" property="borrowLoan"/>
        <result column="subject" jdbcType="VARCHAR" property="subject"/>
        <result column="subject_text" jdbcType="VARCHAR" property="subjectText"/>
        <result column="lifnr" jdbcType="VARCHAR" property="lifnr"/>
        <result column="lifnr_text" jdbcType="VARCHAR" property="lifnrText"/>
        <result column="subject_type" jdbcType="VARCHAR" property="subjectType"/>
        <result column="profit_center_code" jdbcType="VARCHAR" property="profitCenterCode"/>
        <result column="profit_center" jdbcType="VARCHAR" property="profitCenter"/>
        <result column="cost_center_code" jdbcType="VARCHAR" property="costCenterCode"/>
        <result column="cost_center" jdbcType="VARCHAR" property="costCenter"/>
        <result column="wbs_element_code" jdbcType="VARCHAR" property="wbsElementCode"/>
        <result column="wbs_element" jdbcType="VARCHAR" property="wbsElement"/>
        <result column="reason_code" jdbcType="VARCHAR" property="reasonCode"/>
        <result column="reason_code_text" jdbcType="VARCHAR" property="reasonCodeText"/>
        <result column="assigned_number" jdbcType="VARCHAR" property="assignedNumber"/>
        <result column="expiry_date" jdbcType="VARCHAR" property="expiryDate"/>
        <result column="amount" jdbcType="NUMERIC" property="amount"/>
        <result column="entry_status" jdbcType="VARCHAR" property="entryStatus"/>
        <result column="document_no" jdbcType="VARCHAR" property="documentNo"/>
        <result column="message_number" jdbcType="VARCHAR" property="messageNumber"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="creator" jdbcType="VARCHAR" property="creator"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
        <result column="updater" jdbcType="VARCHAR" property="updater"/>
        <result column="deleted" jdbcType="VARCHAR" property="deleted"/>
        <result column="business_type_list" jdbcType="VARCHAR" property="businessTypeList"/>
        <result column="subject_type_list" jdbcType="VARCHAR" property="subjectTypeList"/>
        <result column="entry_number" jdbcType="VARCHAR" property="entryNumber"/>
        <result column="group_no" jdbcType="VARCHAR" property="groupNo"/>
        <result column="entry_type" jdbcType="VARCHAR" property="entryType"/>
        <result column="opposite_profit_center_code" jdbcType="VARCHAR" property="oppositeProfitCenterCode"/>
        <result column="opposite_profit_center" jdbcType="VARCHAR" property="oppositeProfitCenter"/>
        <result column="check_no" jdbcType="VARCHAR" property="checkNo"/>
        <result column="bill_number" jdbcType="VARCHAR" property="billNumber"/>
        <result column="tran_type" jdbcType="VARCHAR" property="tranType"/>
        <result column="rece_id_text" jdbcType="VARCHAR" property="receIdText"/>
        <result column="reversal_status" jdbcType="VARCHAR" property="reversalStatus"/>
        <result column="reversal_msg" jdbcType="VARCHAR" property="reversalMsg"/>
        <result column="succes_date" jdbcType="VARCHAR" property="succesDate"/>
        <result column="reversal_date" jdbcType="VARCHAR" property="reversalDate"/>
        <result column="reversal_sap_no" jdbcType="VARCHAR" property="reversalSapNo"/>
        <result column="i_guid" jdbcType="VARCHAR" property="iGuid"/>
        <result column="tr_type" jdbcType="VARCHAR" property="trType"/>
        <result column="rr_type" jdbcType="VARCHAR" property="rrType"/>
    </resultMap>
    <select id="getInfoById" resultMap="BaseResultMap">
        select * from fss_bill_receivable_allocation where  documents_id in
        <foreach item="item" index="index" collection="docmentIds" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <select id="getBillRecceAllocationEntry" parameterType="String" resultMap="BaseResultMap">
       select
  distinct
         rr.rule_id                                                                            as ruleId,
         tra.transfer_id                                                                      as subId,
         rr.business_module_id                                                                 as businessModuleId,
         rr.business_module                                                                    as businessModule,
         rr.business_type                                                                      as businessType,
         rr.borrow_loan                                                                        as borrowLoan,
         org.busi                                                                              as commercianUnitId,
         org.busitext                                                                          as commercianUnit,
         rr.subject,
         rr.subject_type                                                                       as subjectType,
         ''                                                                                    as costCenterCode,
         ''                                                                                    as costCenter,
         ''                                                                                    as wbsElementCode,
         ''                                                                                    as wbsElement,
         rr.reason_code,
         '1' as tr_type,
         case when (select skb1.mitkz
                     from skb1
                     where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject limit 1) in ('D', 'K') and rr.subject_type = '应收票据科目'
           then rece.rece_number
         else '' end                                                                           as billNumber,
         rece.company_id as organId,
         rece.company_name as  organName,
         (select skat.txt50
          from skat
            join t001 on t001.ktopl = skat.ktopl
          where skat.saknr = rr.subject and t001.bukrs = rece.company_id and skat.spras = '1') as subjectText,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject limit 1) in ('D', 'K')
           then case when rr.business_type = '票据内部付承'
             then case
                  when rece.company_id = tra.pay_company_id then
                      case when rr.subject_type='应收票据科目' then (select up_customer_id from fss_bill_receivable_recite where rece_id = rece.rece_id) else tra.rr_people_one_id end
                  when rece.company_id = tra.rr_people_one_id then tra.rr_people_twp_id
                  when rece.company_id = tra.rr_people_twp_id then tra.rr_people_three_id
                  end
                else case
                  when rece.company_id = tra.rr_people_one_id then tra.pay_company_id
                  when rece.company_id = tra.rr_people_twp_id then tra.rr_people_one_id
                  when rece.company_id = tra.rr_people_three_id then tra.rr_people_twp_id
                  end end
         else '' end                                                                           as lifnr,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject limit 1) in ('D', 'K')
           then case when rr.business_type = '票据内部付承'
             then case
                  when rece.company_id = tra.pay_company_id then
                      case when rr.subject_type='应收票据科目' then (select up_customer_name from fss_bill_receivable_recite where rece_id = rece.rece_id) else tra.rr_people_one end
                  when rece.company_id = tra.rr_people_one_id then tra.rr_people_two
                  when rece.company_id = tra.rr_people_twp_id then tra.rr_people_three
                  end
                else case
                  when rece.company_id = tra.rr_people_one_id then tra.pay_company
                  when rece.company_id = tra.rr_people_twp_id then tra.rr_people_one
                  when rece.company_id = tra.rr_people_three_id then tra.rr_people_two
                  end end
         else '' end                                                                           as lifnrText,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject limit 1) in ('D', 'K')
                  then case when rr.business_type = '票据内部付承'
                    then case
                         when rece.company_id = tra.pay_company_id then
                             case when rr.subject_type='应收票据科目' then (select up_rr_type from fss_bill_receivable_recite where rece_id = rece.rece_id) else tra.rr_type_one end
                         when rece.company_id = tra.rr_people_one_id then tra.rr_type_two
                         when rece.company_id = tra.rr_people_twp_id then tra.rr_type_three
                     end
                            else case
                                     when rece.company_id = tra.rr_people_one_id then (select up_rr_type from fss_bill_receivable_recite where rece_id = rece.rece_id)
                                     when rece.company_id = tra.rr_people_twp_id then tra.rr_type_one
                                     when rece.company_id = tra.rr_people_three_id then tra.rr_type_two
                                end end
              else '' end                                                                           as rrType,
         case when rece.company_id = tra.pay_company_id
           then
             case when ((select count(0)
                         from cepc_bukrs
                         where bukrs = org.bukrs) = 1)
               then (select prctr
                     from cepc_bukrs
                     where bukrs = org.bukrs)
             else case when rece.rece_prctr = '' or rece.rece_prctr is null
               then
                 case when rr.profit_center_code = '' or rr.profit_center_code is null
                   then (select ru.profit_center_code
                       from fss_accounting_rule ru
                       where ru.organ_id = rece.company_id and type = '2')
                 else  rr.profit_center_code end
                  else rece.rece_prctr end end
         else
           case when ((select count(0)
                       from cepc_bukrs
                       where bukrs = org.bukrs) = 1)
             then (select prctr
                   from cepc_bukrs
                   where bukrs = org.bukrs)
           else
             case when ((select busi
                         from v_organ
                         where bukrs = tra.pay_company_id) = '6000' and (select busi
                                                                         from v_organ
                                                                         where bukrs = rece.company_id) = '1000')
               then case
                    when tra.type = '内部调拨' then '0000888888'
                    when tra.type = '内部回款' then '0000100000'
                      end
             else
               case when rece.rece_prctr = '' or rece.rece_prctr is null
                        then
                          case when rr.profit_center_code = '' or rr.profit_center_code is null
                            then (select ru.profit_center_code
                                from fss_accounting_rule ru
                                where ru.organ_id = rece.company_id and type = '2')
                          else rr.profit_center_code end
                      else rece.rece_prctr
                           end
             end end end                                                       as profitCenterCode,
         case when rece.company_id = tra.pay_company_id
           then
             case when ((select count(0)
                         from cepc_bukrs
                         where bukrs = org.bukrs) = 1)
               then (select cepct.ltext
                     from cepc_bukrs
                       join cepct on cepc_bukrs.prctr = cepct.prctr
                     where bukrs = org.bukrs)
             else case when rece.rece_ltext = '' or rece.rece_ltext is null
               then case when rr.profit_center_code = '' or rr.profit_center_code is null
                 then (select ru.profit_center
                          from fss_accounting_rule ru
                          where ru.organ_id = rece.company_id and type = '2')
                    else rr.profit_center  end
                  else rece.rece_ltext end end
         else
           case when ((select count(0)
                       from cepc_bukrs
                       where bukrs = org.bukrs) = 1)
             then (select cepct.ltext
                   from cepc_bukrs
                     join cepct on cepc_bukrs.prctr = cepct.prctr
                   where bukrs = org.bukrs)
           else
              case when ((select busi
                         from v_organ
                         where bukrs = tra.pay_company_id) = '6000' and (select busi
                                                                         from v_organ
                                                                         where bukrs = rece.company_id) = '1000')
               then case
                    when tra.type = '内部调拨' then '集团本部'
                    when tra.type = '内部回款' then '风电本部-非电控'
                      end
             else
               case when rece.rece_ltext = '' or rece.rece_ltext is null
                        then
                          case when rr.profit_center_code = '' or rr.profit_center_code is null
                            then (select ru.profit_center
                                from fss_accounting_rule ru
                                where ru.organ_id = rece.company_id and type = '2')
                          else rr.profit_center end
                      else rece.rece_ltext
                           end
             end end end                                                      as profitCenter,
'' as oppositeProfitCenterCode,
'' as oppositeProfitCenter,
          (select t053s.txt40
           from t053s
           where t053s.bukrs = rece.company_id and t053s.rstgr = rr.reason_code)                as reasonCodeText,
          case when rr.subject_type = '应收票据科目'
            then rece.stop_date :: text
          else tra.s_date :: text end                                                                  as expiryDate,
          tra.s_date  :: text                                                                      as creditDate,
          case when (select skb1.mitkz
                     from skb1
                     where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject limit 1) in ('D', 'K') and rr.subject_type = '应收票据科目'
            then substr(rece.rece_number, length(rece.rece_number) - 9, 10)
          else '' end                                                                           as checkNo,
          case when  rr.subject_type = '应收票据科目'
            then rece.rece_money
          else tra.money_small end                                                              as amount,
          '未入账'                                                                                 as entry_status,
         case when rr.subject_type = '应收票据科目' then rece.rece_number else
          case when rr.business_type = '票据内部付承'
              then  case
                  when rece.company_id = tra.pay_company_id then  '向(' || tra.rr_people_one || ')付承'
                  when rece.company_id = tra.rr_people_one_id then  '向(' || tra.rr_people_two || ')付承'
                  when rece.company_id = tra.rr_people_twp_id then  '向(' || tra.rr_people_three || ')付承'
                  end
                else case
                  when rece.company_id = tra.rr_people_one_id then '收到(' || tra.pay_company || ')的承兑'
                  when rece.company_id = tra.rr_people_twp_id then '收到(' || tra.rr_people_one || ')的承兑'
                  when rece.company_id = tra.rr_people_three_id then '收到(' || tra.rr_people_two || ')的承兑'
                  end
          end end   as summary
       from fss_bill_receivable_info rece
         left JOIN fss_bill_receivable_transfer tra on case when rece.transfer_id != #{subId} then rece.enter_transfer_id = tra.transfer_id else rece.transfer_id = tra.transfer_id end
         left JOIN v_organ org ON rece.company_id = org.bukrs
          JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
      where r.type = '1'  and r.business_module = '应收票据' and r.business_type in('票据内部付承','票据内部收承')) as rr
     ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id = org.bukrs
     and r.type = '1'  and r.business_module = '应收票据' and r.business_type = '票据内部付承') then rr.organ_id = org.bukrs
           when exists (select 1 from fss_accounting_rule r where r.organ_id = org.bukrs
     and r.type = '1'  and r.business_module = '应收票据' and r.business_type = '票据内部收承') then rr.organ_id = org.bukrs
              else case when rr.organ_id is null or rr.organ_id = '' or rr.organ_id = '0' then  rr.code = org.busi end  end)
       where (rece.transfer_id = #{subId} or rece.enter_transfer_id=#{subId}) and tra.approval_status = '审批通过' and tra.transfer_type != ''
      and tra.transfer_type is not null and tra.transfer_type != '全单不签收'
             and
             case when rece.company_id = tra.pay_company_id then  rr.business_type = '票据内部付承' else
               case
              when tra.rr_type = '一单背书'  then
                 case when tra.transfer_type = '全单签收' and rece.company_id = tra.rr_people_one_id then rr.business_type = '票据内部收承' else 1=1 end
              when tra.rr_type = '二单背书' then
                case
                 when tra.transfer_type = '部分签收-一单签收' and rece.company_id = tra.rr_people_one_id then rr.business_type = '票据内部收承'
                 when tra.transfer_type = '全单签收' and rece.company_id = tra.rr_people_twp_id then rr.business_type = '票据内部收承' else 1=1 end
              when tra.rr_type = '三单背书' then
                case
                 when tra.transfer_type = '部分签收-一单签收' and rece.company_id = tra.rr_people_one_id then rr.business_type = '票据内部收承'
                 when tra.transfer_type = '部分签收-二单签收' and rece.company_id = tra.rr_people_twp_id then rr.business_type = '票据内部收承'
                 when tra.transfer_type = '全单签收' and rece.company_id = tra.rr_people_three_id then rr.business_type = '票据内部收承' else 1=1
                end
                 end
             end
order by organId,businessType

    </select>
    <!--查询内部调拨一单分录-->
    <select id="getBillRecceAllocationEntryOne" parameterType="String" resultMap="BaseResultMap">
select
  distinct
         rr.rule_id                                                                            as ruleId,
         rece.transfer_id                                                                      as subId,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject) in ('D', 'K') and
                   rr.subject_type = '应收票据科目'
           then rece.rece_number
         else '' end                                                                           as receNumber,
         rr.business_module_id                                                                 as businessModuleId,
         rr.business_module                                                                    as businessModule,
         rr.business_type                                                                      as businessType,
         case when rr.business_type = '票据内部付承'
           then tra.pay_company_id
         else tra.rr_people_one_id end                                                         as organId,
         case when rr.business_type = '票据内部付承'
           then tra.pay_company
         else tra.rr_people_one end                                                            as organName,
         rr.borrow_loan                                                                        as borrowLoan,
         org.busi                                                                              as commercianUnitId,
         org.busitext                                                                          as commercianUnit,
         rr.subject,
         rr.subject_type                                                                       as subjectType,
         (select skat.txt50
          from skat
            join t001 on t001.ktopl = skat.ktopl
          where skat.saknr = rr.subject and t001.bukrs = rece.company_id and skat.spras = '1') as subjectText,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject) in ('D', 'K')
           then case when rr.business_type = '票据内部付承'
             then tra.rr_people_one_id
                else tra.pay_company_id end
         else '' end                                                                           as lifnr,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject) in ('D', 'K')
           then case when rr.business_type = '票据内部付承'
             then tra.rr_people_one
                else tra.pay_company end
         else '' end                                                                           as lifnrText,
         case when rece.company_id = tra.pay_company_id
           then
             case when ((select count(0)
                         from cepc_bukrs
                         where bukrs = org.bukrs) = 1)
               then (select prctr
                     from cepc_bukrs
                     where bukrs = org.bukrs)
             else case when rece.rece_prctr = '' or rece.rece_prctr is null
               then
                 case when rr.profit_center_code = '' or rr.profit_center_code is null
                   then rr.profit_center_code
                 else (select ru.profit_center_code
                       from fss_accounting_rule ru
                       where ru.organ_id = rece.company_id and type = '2') end
                  else rece.rece_prctr end end
         else
           case when ((select count(0)
                       from cepc_bukrs
                       where bukrs = org.bukrs) = 1)
             then (select prctr
                   from cepc_bukrs
                   where bukrs = org.bukrs)
           else
             case when ((select busi
                         from v_organ
                         where bukrs = tra.pay_company_id) = '6000' and (select busi
                                                                         from v_organ
                                                                         where bukrs = rece.company_id) = '1000')
               then case when (tra.rr_type = '二单背书' and tra.rr_type_two = '内部背书') or
                              (tra.rr_type = '三单背书' and tra.rr_type_two = '内部背书')
                 then '0000888888'
                    else
                      case when (tra.rr_type = '二单背书' and tra.rr_type_two = '内部背书') or
                                (tra.rr_type = '三单背书' and tra.rr_type_two = '内部背书')
                        then '0000100000'
                      else case when rece.rece_prctr = '' or rece.rece_prctr is null
                        then
                          case when rr.profit_center_code = '' or rr.profit_center_code is null
                            then rr.profit_center_code
                          else (select ru.profit_center_code
                                from fss_accounting_rule ru
                                where ru.organ_id = rece.company_id and type = '2') end end
                      end end end end end                                                      as profitCenterCode,

         case when rece.company_id = tra.pay_company_id
           then
             case when ((select count(0)
                         from cepc_bukrs
                         where bukrs = org.bukrs) = 1)
               then (select cepct.ltext
                     from cepc_bukrs
                       join cepct on cepc_bukrs.prctr = cepct.prctr
                     where bukrs = org.bukrs)
             else case when rece.rece_ltext = '' or rece.rece_ltext is null
               then case when rr.profit_center_code = '' or rr.profit_center_code is null
                 then rr.profit_center
                    else (select ru.profit_center
                          from fss_accounting_rule ru
                          where ru.organ_id = rece.company_id and type = '2') end
                  else rece.rece_ltext end end
         else
           case when ((select count(0)
                       from cepc_bukrs
                       where bukrs = org.bukrs) = 1)
             then (select cepct.ltext
                   from cepc_bukrs
                     join cepct on cepc_bukrs.prctr = cepct.prctr
                   where bukrs = org.bukrs)
           else
             case when ((select busi
                         from v_organ
                         where bukrs = tra.pay_company_id) = '6000' and (select busi
                                                                         from v_organ
                                                                         where bukrs = rece.company_id) = '1000')
               then case when (tra.rr_type = '二单背书' and tra.rr_type_two = '内部背书') or
                              (tra.rr_type = '三单背书' and tra.rr_type_two = '内部背书')
                 then '集团本部'
                    else
                      case when (tra.rr_type = '二单背书' and tra.rr_type_two = '内部背书') or
                                (tra.rr_type = '三单背书' and tra.rr_type_two = '内部背书')
                        then '风电本部-非电控'
                      else case when rece.rece_ltext = '' or rece.rece_ltext is null
                        then
                          case when rr.profit_center_code = '' or rr.profit_center_code is null
                            then rr.profit_center
                          else (select ru.profit_center
                                from fss_accounting_rule ru
                                where ru.organ_id = rece.company_id and type = '2') end end
                      end end end end end                                                      as profitCenter,

         case when rece.rece_prctr = '' or rece.rece_prctr is null
           then case when rr.profit_center_code = '' or rr.profit_center_code is null
             then rr.profit_center_code
                else (select ru.profit_center_code
                      from fss_accounting_rule ru
                      where ru.organ_id = rece.company_id and type = '2') end
         else rece.rece_prctr end                                                              as oppositeProfitCenterCode,
         case when rece.rece_ltext = '' or rece.rece_ltext is null
           then case when rr.profit_center_code = '' or rr.profit_center_code is null
             then rr.profit_center
                else (select ru.profit_center
                      from fss_accounting_rule ru
                      where ru.organ_id = rece.company_id and type = '2') end
         else rece.rece_ltext end                                                              as oppositeProfitCenter,
         ''                                                                                    as costCenterCode,
         ''                                                                                    as costCenter,
         ''                                                                                    as wbsElementCode,
         ''                                                                                    as wbsElement,
         rr.reason_code,
         (select t053s.txt40
          from t053s
          where t053s.bukrs = rece.company_id and t053s.rstgr = rr.reason_code)                as reasonCodeText,
         case when rr.subject_type = '应收票据科目'
           then rece.stop_date :: text
         else tra.s_date :: text end                                                                  as expiryDate,
         tra.s_date  :: text                                                                      as creditDate,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject) in ('D', 'K') and
                   rr.subject_type = '应收票据科目'
           then substr(rece.rece_number, length(rece.rece_number) - 9, 10)
         else '' end                                                                           as checkNo,
         case when rr.subject_type = '应收票据科目'
           then rece.rece_money
         else tra.money_small end                                                              as amount,
         '未入账'                                                                                 as entry_status,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject) in ('D', 'K')
           then case when rr.business_type = '票据内部付承'
             then '向(' || tra.rr_people_one || ')付承'
                else '收到(' || tra.pay_company || ')的承兑' end
         else rece.rece_number end                                                             as summary,
         '1' as tr_type
       from fss_bill_receivable_info rece
         left JOIN fss_bill_receivable_transfer tra ON rece.transfer_id = tra.transfer_id
         left join fss_bill_receivable_recite brr on rece.rr_id = brr.rr_id
         left JOIN v_organ org ON rece.company_id = org.bukrs
         JOIN (select
                 rul.*,
                 enum.code
               from fss_accounting_rule rul left join sec_enum enum on enum.id = rul.commercian_unit_id
               where rul.type = '1') as rr
           ON rr.business_module = '应收票据' AND (rr.business_type = '票据内部付承' or rr.business_type = '票据内部收承') AND
              (org.busi = rr.code OR rece.company_id = rr.organ_id)
       where rece.transfer_id = #{subId} and rece.signature_state = '0' and tra.approval_status = '审批通过' and tra.transfer_type != ''
      and tra.transfer_type is not null and tra.transfer_type != '全单不签收'
      order by businessType,organId
    </select>
    <!--查询内部调拨二单分录-->
    <select id="getBillRecceAllocationEntryTow" parameterType="String" resultMap="BaseResultMap">
select
distinct
         rr.rule_id                                                                            as ruleId,
         rece.transfer_id                                                                      as subId,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject) in ('D', 'K') and
                   rr.subject_type = '应收票据科目'
           then rece.rece_number
         else '' end                                                                           as receNumber,
         rr.business_module_id                                                                 as businessModuleId,
         rr.business_module                                                                    as businessModule,
         rr.business_type                                                                      as businessType,
         case when rr.business_type = '票据内部付承'
           then tra.rr_people_one_id
         else tra.rr_people_twp_id end                                                         as organId,
         case when rr.business_type = '票据内部付承'
           then tra.rr_people_one
         else tra.rr_people_two end                                                            as organName,
         rr.borrow_loan                                                                        as borrowLoan,
         org.busi                                                                              as commercianUnitId,
         org.busitext                                                                          as commercianUnit,
         rr.subject,
         rr.subject_type                                                                       as subjectType,
         (select skat.txt50
          from skat
            join t001 on t001.ktopl = skat.ktopl
          where skat.saknr = rr.subject and t001.bukrs = rece.company_id and skat.spras = '1') as subjectText,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject) in ('D', 'K')
           then case when rr.business_type = '票据内部付承'
             then tra.rr_people_twp_id
                else tra.rr_people_one_id end
         else '' end                                                                           as lifnr,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject) in ('D', 'K')
           then case when rr.business_type = '票据内部付承'
             then tra.rr_people_two
                else tra.rr_people_one end
         else '' end                                                                           as lifnrText,
         case when rece.company_id = tra.pay_company_id
           then
             case when ((select count(0)
                         from cepc_bukrs
                         where bukrs = org.bukrs) = 1)
               then (select prctr
                     from cepc_bukrs
                     where bukrs = org.bukrs)
             else case when rece.rece_prctr = '' or rece.rece_prctr is null
               then
                 case when rr.profit_center_code = '' or rr.profit_center_code is null
                   then rr.profit_center_code
                 else (select ru.profit_center_code
                       from fss_accounting_rule ru
                       where ru.organ_id = rece.company_id and type = '2') end
                  else rece.rece_prctr end end
         else
           case when ((select count(0)
                       from cepc_bukrs
                       where bukrs = org.bukrs) = 1)
             then (select prctr
                   from cepc_bukrs
                   where bukrs = org.bukrs)
           else
             case when ((select busi
                         from v_organ
                         where bukrs = tra.pay_company_id) = '6000' and (select busi
                                                                         from v_organ
                                                                         where bukrs = rece.company_id) = '1000')
               then case when (tra.rr_type = '二单背书' and tra.rr_type_two = '内部背书') or
                              (tra.rr_type = '三单背书' and tra.rr_type_two = '内部背书')
                 then '0000888888'
                    else
                      case when (tra.rr_type = '二单背书' and tra.rr_type_two = '内部背书') or
                                (tra.rr_type = '三单背书' and tra.rr_type_two = '内部背书')
                        then '0000100000'
                      else case when rece.rece_prctr = '' or rece.rece_prctr is null
                        then
                          case when rr.profit_center_code = '' or rr.profit_center_code is null
                            then rr.profit_center_code
                          else (select ru.profit_center_code
                                from fss_accounting_rule ru
                                where ru.organ_id = rece.company_id and type = '2') end end
                      end end end end end                                                      as profitCenterCode,

         case when rece.company_id = tra.pay_company_id
           then
             case when ((select count(0)
                         from cepc_bukrs
                         where bukrs = org.bukrs) = 1)
               then (select cepct.ltext
                     from cepc_bukrs
                       join cepct on cepc_bukrs.prctr = cepct.prctr
                     where bukrs = org.bukrs)
             else case when rece.rece_ltext = '' or rece.rece_ltext is null
               then case when rr.profit_center_code = '' or rr.profit_center_code is null
                 then rr.profit_center
                    else (select ru.profit_center
                          from fss_accounting_rule ru
                          where ru.organ_id = rece.company_id and type = '2') end
                  else rece.rece_ltext end end
         else
           case when ((select count(0)
                       from cepc_bukrs
                       where bukrs = org.bukrs) = 1)
             then (select cepct.ltext
                   from cepc_bukrs
                     join cepct on cepc_bukrs.prctr = cepct.prctr
                   where bukrs = org.bukrs)
           else
             case when ((select busi
                         from v_organ
                         where bukrs = tra.pay_company_id) = '6000' and (select busi
                                                                         from v_organ
                                                                         where bukrs = rece.company_id) = '1000')
               then case when (tra.rr_type = '二单背书' and tra.rr_type_two = '内部背书') or
                              (tra.rr_type = '三单背书' and tra.rr_type_two = '内部背书')
                 then '集团本部'
                    else
                      case when (tra.rr_type = '二单背书' and tra.rr_type_two = '内部背书') or
                                (tra.rr_type = '三单背书' and tra.rr_type_two = '内部背书')
                        then '风电本部-非电控'
                      else case when rece.rece_ltext = '' or rece.rece_ltext is null
                        then
                          case when rr.profit_center_code = '' or rr.profit_center_code is null
                            then rr.profit_center
                          else (select ru.profit_center
                                from fss_accounting_rule ru
                                where ru.organ_id = rece.company_id and type = '2') end end
                      end end end end end                                                      as profitCenter,

         case when rece.rece_prctr = '' or rece.rece_prctr is null
           then case when rr.profit_center_code = '' or rr.profit_center_code is null
             then rr.profit_center_code
                else (select ru.profit_center_code
                      from fss_accounting_rule ru
                      where ru.organ_id = rece.company_id and type = '2') end
         else rece.rece_prctr end                                                              as oppositeProfitCenterCode,
         case when rece.rece_ltext = '' or rece.rece_ltext is null
           then case when rr.profit_center_code = '' or rr.profit_center_code is null
             then rr.profit_center
                else (select ru.profit_center
                      from fss_accounting_rule ru
                      where ru.organ_id = rece.company_id and type = '2') end
         else rece.rece_ltext end                                                              as oppositeProfitCenter,
         ''                                                                                    as costCenterCode,
         ''                                                                                    as costCenter,
         ''                                                                                    as wbsElementCode,
         ''                                                                                    as wbsElement,
         rr.reason_code,
         (select t053s.txt40
          from t053s
          where t053s.bukrs = rece.company_id and t053s.rstgr = rr.reason_code)                as reasonCodeText,
case when rr.subject_type = '应收票据科目'
           then rece.stop_date :: text
         else tra.s_date :: text end                                                                  as expiryDate,
         tra.s_date  :: text                                                                      as creditDate,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject) in ('D', 'K') and
                   rr.subject_type = '应收票据科目'
           then substr(rece.rece_number, length(rece.rece_number) - 9, 10)
         else '' end                                                                           as checkNo,
         case when rr.subject_type = '应收票据科目'
           then rece.rece_money
         else tra.money_small end                                                              as amount,
         '未入账'                                                                                 as entry_status,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject) in ('D', 'K')
           then case when rr.business_type = '票据内部付承'
             then '向(' || tra.rr_people_two || ')付承'
                else '收到(' || tra.rr_people_one || ')的承兑' end
         else rece.rece_number end                                                             as summary,
         '2' as tr_type
       from fss_bill_receivable_info rece
         left JOIN fss_bill_receivable_transfer tra ON rece.transfer_id = tra.transfer_id
         left join fss_bill_receivable_recite brr on rece.rr_id = brr.rr_id
         left JOIN v_organ org ON rece.company_id = org.bukrs
         JOIN (select
                 rul.*,
                 enum.code
               from fss_accounting_rule rul left join sec_enum enum on enum.id = rul.commercian_unit_id
               where rul.type = '1') as rr
           ON rr.business_module = '应收票据' AND (rr.business_type = '票据内部付承' or rr.business_type = '票据内部收承') AND
              (org.busi = rr.code OR rece.company_id = rr.organ_id)
       where (tra.rr_type = '二单背书' or tra.rr_type = '三单背书') and tra.rr_type_two = '内部背书' and
             (tra.transfer_type = '全单签收' or tra.transfer_type = '部分签收-二单签收') and
             rece.transfer_id = #{subId} and rece.signature_state = '0' and tra.approval_status = '审批通过'
             and tra.transfer_type is not null and tra.transfer_type != '全单不签收' and tra.transfer_type != ''
             order by businessType,organId
    </select>
    <!--查询内部调拨全单分录-->
    <select id="getBillRecceAllocationEntryAll" parameterType="String" resultMap="BaseResultMap">
select
distinct
          rr.rule_id                                                                            as ruleId,
          rece.transfer_id                                                                      as subId,
          case when (select skb1.mitkz
                     from skb1
                     where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject) in ('D', 'K') and
                    rr.subject_type = '应收票据科目'
            then rece.rece_number
          else '' end                                                                           as receNumber,
          rr.business_module_id                                                                 as businessModuleId,
          rr.business_module                                                                    as businessModule,
          rr.business_type                                                                      as businessType,
          case when rr.business_type = '票据内部付承'
            then tra.rr_people_twp_id
          else tra.rr_people_three_id end                                                       as organId,
          case when rr.business_type = '票据内部付承'
            then tra.rr_people_two
          else tra.rr_people_three end                                                          as organName,
          rr.borrow_loan                                                                        as borrowLoan,
          org.busi                                                                              as commercianUnitId,
          org.busitext                                                                          as commercianUnit,
          rr.subject,
          rr.subject_type                                                                       as subjectType,
          (select skat.txt50
           from skat
             join t001 on t001.ktopl = skat.ktopl
           where skat.saknr = rr.subject and t001.bukrs = rece.company_id and skat.spras = '1') as subjectText,
          case when (select skb1.mitkz
                     from skb1
                     where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject) in ('D', 'K')
            then case when rr.business_type = '票据内部付承'
              then tra.rr_people_three_id
                 else tra.rr_people_twp_id end
          else '' end                                                                           as lifnr,
          case when (select skb1.mitkz
                     from skb1
                     where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject) in ('D', 'K')
            then case when rr.business_type = '票据内部付承'
              then tra.rr_people_three
                 else tra.rr_people_two end
          else '' end                                                                           as lifnrText,
          case when rece.company_id = tra.pay_company_id
            then
              case when ((select count(0)
                          from cepc_bukrs
                          where bukrs = org.bukrs) = 1)
                then (select prctr
                      from cepc_bukrs
                      where bukrs = org.bukrs)
              else case when rece.rece_prctr = '' or rece.rece_prctr is null
                then
                  case when rr.profit_center_code = '' or rr.profit_center_code is null
                    then rr.profit_center_code
                  else (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = rece.company_id and type = '2') end
                   else rece.rece_prctr end end
          else
            case when ((select count(0)
                        from cepc_bukrs
                        where bukrs = org.bukrs) = 1)
              then (select prctr
                    from cepc_bukrs
                    where bukrs = org.bukrs)
            else
              case when ((select busi
                          from v_organ
                          where bukrs = tra.pay_company_id) = '6000' and (select busi
                                                                          from v_organ
                                                                          where bukrs = rece.company_id) = '1000')
                then case when (tra.rr_type = '二单背书' and tra.rr_type_two = '内部背书') or
                               (tra.rr_type = '三单背书' and tra.rr_type_two = '内部背书')
                  then '0000888888'
                     else
                       case when (tra.rr_type = '二单背书' and tra.rr_type_two = '内部背书') or
                                 (tra.rr_type = '三单背书' and tra.rr_type_two = '内部背书')
                         then '0000100000'
                       else case when rece.rece_prctr = '' or rece.rece_prctr is null
                         then
                           case when rr.profit_center_code = '' or rr.profit_center_code is null
                             then rr.profit_center_code
                           else (select ru.profit_center_code
                                 from fss_accounting_rule ru
                                 where ru.organ_id = rece.company_id and type = '2') end end
                       end end end end end                                                      as profitCenterCode,

          case when rece.company_id = tra.pay_company_id
            then
              case when ((select count(0)
                          from cepc_bukrs
                          where bukrs = org.bukrs) = 1)
                then (select cepct.ltext
                      from cepc_bukrs
                        join cepct on cepc_bukrs.prctr = cepct.prctr
                      where bukrs = org.bukrs)
              else case when rece.rece_ltext = '' or rece.rece_ltext is null
                then case when rr.profit_center_code = '' or rr.profit_center_code is null
                  then rr.profit_center
                     else (select ru.profit_center
                           from fss_accounting_rule ru
                           where ru.organ_id = rece.company_id and type = '2') end
                   else rece.rece_ltext end end
          else
            case when ((select count(0)
                        from cepc_bukrs
                        where bukrs = org.bukrs) = 1)
              then (select cepct.ltext
                    from cepc_bukrs
                      join cepct on cepc_bukrs.prctr = cepct.prctr
                    where bukrs = org.bukrs)
            else
              case when ((select busi
                          from v_organ
                          where bukrs = tra.pay_company_id) = '6000' and (select busi
                                                                          from v_organ
                                                                          where bukrs = rece.company_id) = '1000')
                then case when (tra.rr_type = '二单背书' and tra.rr_type_two = '内部背书') or
                               (tra.rr_type = '三单背书' and tra.rr_type_two = '内部背书')
                  then '集团本部'
                     else
                       case when (tra.rr_type = '二单背书' and tra.rr_type_two = '内部背书') or
                                 (tra.rr_type = '三单背书' and tra.rr_type_two = '内部背书')
                         then '风电本部-非电控'
                       else case when rece.rece_ltext = '' or rece.rece_ltext is null
                         then
                           case when rr.profit_center_code = '' or rr.profit_center_code is null
                             then rr.profit_center
                           else (select ru.profit_center
                                 from fss_accounting_rule ru
                                 where ru.organ_id = rece.company_id and type = '2') end end
                       end end end end end                                                      as profitCenter,

          case when rece.rece_prctr = '' or rece.rece_prctr is null
            then case when rr.profit_center_code = '' or rr.profit_center_code is null
              then rr.profit_center_code
                 else (select ru.profit_center_code
                       from fss_accounting_rule ru
                       where ru.organ_id = rece.company_id and type = '2') end
          else rece.rece_prctr end                                                              as oppositeProfitCenterCode,
          case when rece.rece_ltext = '' or rece.rece_ltext is null
            then case when rr.profit_center_code = '' or rr.profit_center_code is null
              then rr.profit_center
                 else (select ru.profit_center
                       from fss_accounting_rule ru
                       where ru.organ_id = rece.company_id and type = '2') end
          else rece.rece_ltext end                                                              as oppositeProfitCenter,
          ''                                                                                    as costCenterCode,
          ''                                                                                    as costCenter,
          ''                                                                                    as wbsElementCode,
          ''                                                                                    as wbsElement,
          rr.reason_code,
          (select t053s.txt40
           from t053s
           where t053s.bukrs = rece.company_id and t053s.rstgr = rr.reason_code)                as reasonCodeText,
case when rr.subject_type = '应收票据科目'
           then rece.stop_date :: text
         else tra.s_date :: text end                                                                  as expiryDate,
         tra.s_date  :: text                                                                      as creditDate,
          case when (select skb1.mitkz
                     from skb1
                     where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject) in ('D', 'K') and
                    rr.subject_type = '应收票据科目'
            then substr(rece.rece_number, length(rece.rece_number) - 9, 10)
          else '' end                                                                           as checkNo,
          case when rr.subject_type = '应收票据科目'
            then rece.rece_money
          else tra.money_small end                                                              as amount,
          '未入账'                                                                                 as entry_status,
          case when (select skb1.mitkz
                     from skb1
                     where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject) in ('D', 'K')
            then case when rr.business_type = '票据内部付承'
              then '向(' || tra.rr_people_three || ')付承'
                 else '收到(' || tra.rr_people_two || ')的承兑' end
          else rece.rece_number end                                                             as summary,
          '3' as tr_type
        from fss_bill_receivable_info rece
          left JOIN fss_bill_receivable_transfer tra ON rece.transfer_id = tra.transfer_id
          left join fss_bill_receivable_recite brr on rece.rr_id = brr.rr_id
          left JOIN v_organ org ON rece.company_id = org.bukrs
          JOIN (select
                  rul.*,
                  enum.code
                from fss_accounting_rule rul left join sec_enum enum on enum.id = rul.commercian_unit_id
                where rul.type = '1') as rr
            ON rr.business_module = '应收票据' AND (rr.business_type = '票据内部付承' or rr.business_type = '票据内部收承') AND
               (org.busi = rr.code OR rece.company_id = rr.organ_id)
        where tra.rr_type = '三单背书' and tra.transfer_type = '全单签收' and tra.rr_type_three = '内部背书' and rece.signature_state = '0' and
              rece.transfer_id = #{subId}  and tra.transfer_type is not null and tra.transfer_type != '全单不签收'
               and tra.transfer_type != ''  and tra.approval_status = '审批通过'
               order by businessType,organId
    </select>
    <!--order by organId,businessType-->
    <!--查询贴现分录-->
    <select id="getBillRecceRediscountEntry" resultMap="BaseResultMap">
select *
from ((select
         rece.discount_id                                                                                    as subId,
         rr.rule_id                                                                                          as ruleId,
         rece.company_id                                                                                     as organId,
         rece.company_name                                                                                   as organName,
         rr.business_module_id                                                                               as businessModuleId,
         rr.business_module                                                                                  as businessModule,
         rr.business_type                                                                                    as businessType,
         rr.borrow_loan                                                                                      as borrowLoan,
         rr.subject_type,
         case when rr.subject = '' or rr.subject is null
           THEN (select hkont
                 from v_acc_num
                 where acc_num = dis.discount_bank_acount)
         else rr.subject end                                                                                 as subject,
         case when rr.subject = '' or rr.subject is null
           THEN (select skat.txt50
                 from skat
                   join t001 on t001.ktopl = skat.ktopl
                 where skat.saknr = (select hkont
                                     from v_acc_num
                                     where acc_num = dis.discount_bank_acount) and t001.bukrs = dis.discount_body_id and
                       skat.spras = '1')
         else (select skat.txt50
               from skat
                 join t001 on t001.ktopl = skat.ktopl
               where skat.saknr = rr.subject and t001.bukrs = dis.discount_body_id and skat.spras =
                                                                                       '1') end              as subjectText,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = dis.discount_body_id and skb1.saknr = rr.subject limit 1) in ('D', 'K')
           then brr.up_customer_id
         else '' end                                                                                         as lifnr,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = dis.discount_body_id and skb1.saknr = rr.subject limit 1) in ('D', 'K')
           then brr.up_customer_name
         else '' end                                                                                         as lifnrText,
         case when rece.rece_prctr = '' or rece.rece_prctr is null
           then case when rr.profit_center_code = '' or rr.profit_center_code is null
             then rr.profit_center_code
                else (select ru.profit_center_code
                      from fss_accounting_rule ru
                      where ru.organ_id = dis.discount_body_id and type = '2') end
         else rece.rece_prctr end                                                                            as profitCenterCode,
         case when rece.rece_ltext = '' or rece.rece_ltext is null
           then case when rr.profit_center_code = '' or rr.profit_center_code is null
             then rr.profit_center
                else (select ru.profit_center
                      from fss_accounting_rule ru
                      where ru.organ_id = dis.discount_body_id and type = '2') end
         else rece.rece_ltext end                                                                            as profitCenter,
         case when (select ska1.glaccount_type
                    from t001
                      join ska1 on t001.ktopl = ska1.ktopl
                    where t001.bukrs = rr.organ_id and ska1.saknr = rr.subject) = 'P'
                   and (rr.cost_center_code != '' or rr.cost_center_code is not null)
           then case when (rr.cost_center_code != '' or rr.cost_center_code is not null)
             then
               case when length(rr.cost_center_code) = 6
                 then concat(rr.organ_id, rr.cost_center_code)
               when length(rr.cost_center_code) = 4
                 then concat(rr.profit_center_code, rr.cost_center_code)
               when length(rr.cost_center_code) = 10
                 then rr.cost_center_code end
                else (select cost_center_code
                      from fss_accounting_rule
                      where organ_id = rr.organ_id and type = '2') end
         else '' end                                                                                         as cost_center_code,
         (select cskt.ltext
          from csks
            join cskt on csks.kokrs = cskt.kokrs and csks.bukrs = rr.organ_id and to_date(csks.datbi, 'yyyyMMdd') >= now()
          where csks.kostl = rr.cost_center_code and csks.bukrs = rr.organ_id
          limit 1)                                                                                           as cost_center,
         ''                                                                                                  as wbsElementCode,
         ''                                                                                                  as wbsElement,
         rr.reason_code,
         (select t053s.txt40
          from t053s
          where t053s.bukrs = rr.organ_id and t053s.rstgr =
                                              rr.reason_code)                                                as reasonCodeText,
         case when rr.subject_type = '银行科目'
           then dis.discount_money - dis.discount_interest
         when rr.subject_type = '财务费用科目'
           then dis.discount_interest
         when rr.subject_type = '应收票据科目'
           then rece.rece_money
         else 0 end                                                                                          as amount,
         '未入账'                                                                                               as entry_status,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject limit 1) not in ('D', 'K') and
                   rr.subject_type = '应收票据科目'
           then rece.rece_number
         else dis.drawer_bank_out || '承兑汇票贴现到账' end                                                          as summary,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject limit 1) in ('D', 'K') and
                   rr.subject_type = '应收票据科目'
           then rece.rece_number
         else '' end                                                                                         as billNumber,
          to_char(rece.stop_date, 'YYYY-MM-DD hh:mi:ss')                                                     as expiryDate,
         case when (select skb1.mitkz
                    from skb1
                    where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject limit 1) in ('D', 'K') and
                   rr.subject_type = '应收票据科目'
           then substr(rece.rece_number, length(rece.rece_number) - 9, 10)
         else '' end                                                                                         as checkNo
       from fss_bill_receivable_info rece
         left join fss_bill_receivable_recite brr on brr.rr_id = rece.rr_id
         left join fss_bill_receivable_discount dis on rece.discount_id = dis.discount_id
         left JOIN v_organ org ON dis.discount_body_id = org.bukrs
         JOIN (select
                 rul.*,
                 enum.code
               from fss_accounting_rule rul left join sec_enum enum on enum.id = rul.commercian_unit_id
               where rul.type = '1') as rr
           ON rr.business_module = '应收票据' AND rr.business_type = '票据贴现到账' AND
              (org.busi = rr.code OR dis.discount_body_id = rr.organ_id)
       where rece.discount_id =#{subId} and rr.subject_type = '应收票据科目' and dis.approval_status = '审批通过')
      union all
      ( select * from (
        select
          rece.discount_id                                                                       as subId,
          rr.rule_id                                                                             as ruleId,
          rece.company_id                                                                        as organId,
          rece.company_name                                                                      as organName,
          rr.business_module_id                                                                  as businessModuleId,
          rr.business_module                                                                     as businessModule,
          rr.business_type                                                                       as businessType,
          rr.borrow_loan                                                                         as borrowLoan,
          rr.subject_type,
          case when rr.subject = '' or rr.subject is null
            THEN (select hkont
                  from v_acc_num
                  where acc_num = dis.discount_bank_acount)
          else rr.subject end                                                                    as subject,
          case when rr.subject = '' or rr.subject is null
            THEN (select skat.txt50
                  from skat
                    join t001 on t001.ktopl = skat.ktopl
                  where skat.saknr = (select hkont
                                      from v_acc_num
                                      where acc_num = dis.discount_bank_acount) and t001.bukrs = dis.discount_body_id
                        and
                        skat.spras = '1')
          else (select skat.txt50
                from skat
                  join t001 on t001.ktopl = skat.ktopl
                where skat.saknr = rr.subject and t001.bukrs = dis.discount_body_id and skat.spras =
                                                                                        '1') end as subjectText,
          case when (select skb1.mitkz
                     from skb1
                     where skb1.bukrs = dis.discount_body_id and skb1.saknr = rr.subject limit 1) in ('D', 'K')
            then brr.up_customer_id
          else '' end                                                                            as lifnr,
          case when (select skb1.mitkz
                     from skb1
                     where skb1.bukrs = dis.discount_body_id and skb1.saknr = rr.subject limit 1) in ('D', 'K')
            then brr.up_customer_name
          else '' end                                                                            as lifnrText,
          case when rece.rece_prctr = '' or rece.rece_prctr is null
            then case when rr.profit_center_code = '' or rr.profit_center_code is null
              then rr.profit_center_code
                 else (select ru.profit_center_code
                       from fss_accounting_rule ru
                       where ru.organ_id = dis.discount_body_id and type = '2') end
          else rece.rece_prctr end                                                               as profitCenterCode,
          case when rece.rece_ltext = '' or rece.rece_ltext is null
            then case when rr.profit_center_code = '' or rr.profit_center_code is null
              then rr.profit_center
                 else (select ru.profit_center
                       from fss_accounting_rule ru
                       where ru.organ_id = dis.discount_body_id and type = '2') end
          else rece.rece_ltext end                                                               as profitCenter,
          case when (select ska1.glaccount_type
                     from t001
                       join ska1 on t001.ktopl = ska1.ktopl
                     where t001.bukrs = rr.organ_id and ska1.saknr = rr.subject) = 'P'
                    and (rr.cost_center_code != '' or rr.cost_center_code is not null)
            then case when (rr.cost_center_code != '' or rr.cost_center_code is not null)
              then
                case when length(rr.cost_center_code) = 6
                  then concat(rr.organ_id, rr.cost_center_code)
                when length(rr.cost_center_code) = 4
                  then concat(rr.profit_center_code, rr.cost_center_code)
                when length(rr.cost_center_code) = 10
                  then rr.cost_center_code end
                 else (select cost_center_code
                       from fss_accounting_rule
                       where organ_id = rr.organ_id and type = '2') end
          else '' end                                                                            as cost_center_code,
          (select cskt.ltext
           from csks
             join cskt
               on csks.kokrs = cskt.kokrs and csks.bukrs = rr.organ_id and to_date(csks.datbi, 'yyyyMMdd') >= now()
           where csks.kostl = rr.cost_center_code and csks.bukrs = rr.organ_id
           limit 1)                                                                              as cost_center,
          ''::text                                                                                     as wbsElementCode,
          ''::text                                                                                     as wbsElement,
          rr.reason_code,
          (select t053s.txt40
           from t053s
           where t053s.bukrs = rr.organ_id and t053s.rstgr =
                                               rr.reason_code)                                   as reasonCodeText,
          case when rr.subject_type = '银行科目'
            then dis.discount_money - dis.discount_interest
          when rr.subject_type = '财务费用科目'
            then dis.discount_interest
          when rr.subject_type = '应收票据科目'
            then dis.discount_money
          else 0 end                                                                             as amount,
          '未入账'::text                                                                                   as entry_status,
          case when (select skb1.mitkz
                     from skb1
                     where skb1.bukrs = rece.company_id and skb1.saknr = rr.subject limit 1) not in ('D', 'K') and
                    rr.subject_type = '应收票据科目'
            then ''
          else dis.drawer_bank_out ||
               '承兑汇票贴现到账' end                                                                    as summary,
          ''::text                                                                                      as billNumber,
          ''::text                                                                                     as expiryDate,
          ''::text                                                                                      as checkNo
        from fss_bill_receivable_info rece
          left join fss_bill_receivable_recite brr on brr.rr_id = rece.rr_id
          left join fss_bill_receivable_discount dis on rece.discount_id = dis.discount_id
          left JOIN v_organ org ON dis.discount_body_id = org.bukrs
          JOIN (select
                  rul.*,
                  enum.code
                from fss_accounting_rule rul left join sec_enum enum on enum.id = rul.commercian_unit_id
                where rul.type = '1') as rr
            ON rr.business_module = '应收票据' AND rr.business_type = '票据贴现到账' AND
               (org.busi = rr.code OR dis.discount_body_id = rr.organ_id)
        where rece.discount_id =#{subId} and rr.subject_type != '应收票据科目' and
              dis.approval_status = '审批通过'
      ) as btable
        group by btable.subject_type,btable.subid,btable.ruleid,btable.organid,btable.organname,btable.businessmoduleid,
          btable.businessmodule,btable.businesstype,btable.borrowloan,btable.subject,btable.subjecttext,btable.lifnr,btable.lifnrtext,
          btable.profitcentercode,btable.profitcenter,btable.cost_center_code,btable.cost_center,btable.wbselementcode,btable.wbselement,
          btable.reason_code,btable.reasoncodetext,btable.amount,btable.entry_status,btable.summary,btable.billnumber,btable.expirydate,
          btable.checkno
      )) as allTable

    </select>
    <!--查询托收分录-->
    <select id="getBillRecceCollectionEntry" resultMap="BaseResultMap">
select
  *,
  case when (select skb1.mitkz
             from skb1
             where skb1.bukrs = rro.organId and skb1.saknr = rro.subject limit 1) in ('D', 'K') and rro.subject_type = '应收票据科目'
    then rro.receNo
  else '' end                                                                        as billNumber,
  (select skat.txt50
   from skat
     join t001 on t001.ktopl = skat.ktopl
   where skat.saknr = rro.subject and t001.bukrs = rro.organId and skat.spras = '1') as subjectText,--科目名称
  case when (select skb1.mitkz
             from skb1
             where skb1.bukrs = rro.organId and skb1.saknr = rro.subject limit 1) in ('D', 'K')
    then rro.up_customer_id
  else '' end                                                                        as lifnr, --供应商/客户编码
  case when (select skb1.mitkz
             from skb1
             where skb1.bukrs = rro.organId and skb1.saknr = rro.subject limit 1) in ('D', 'K')
    then rro.up_customer_name
  else '' end                                                                        as lifnrText,
  case when (select skb1.mitkz
             from skb1
             where skb1.bukrs = rro.organId and skb1.saknr = rro.subject limit 1) not in ('D', 'K') and
            rro.subject_type = '应收票据科目'
    then rro.receNo
  else rro.col_bank_name || '托收到账' end                                               as summary,
      case when rro.subject_type = '应收票据科目'
        then to_char(rro.stop_date, 'YYYY-MM-DD hh:mi:ss')
      else '' end                                                                        as expiryDate,
      case when (select skb1.mitkz
                 from skb1
                 where skb1.bukrs = rro.organId and skb1.saknr = rro.subject limit 1)  in ('D', 'K') and rro.subject_type = '应收票据科目'
        then substr(rro.receNo, length(rro.receNo) - 9, 10)
      else '' end                                                                        as checkNo
from (select
        rece.rece_id                                                       as subId,
        rece.rece_number                                                   as receNo,
        rece.company_id                                                    as organId,
        rece.company_name                                                  as organName,
        rece.stop_date,
        col.col_date                                                       as creditDate,
        rr.rule_id                                                         as ruleId,
        rr.business_module_id                                              as businessModuleId,
        rr.business_module                                                 as businessModule,
        rr.business_type                                                   as businessType,
        rr.borrow_loan                                                     as borrowLoan,
        ''                                                                 as cost_center_code,
        ''                                                                 as cost_center,
        ''                                                                 as wbsElementCode,
        ''                                                                 as wbsElement,
        rr.reason_code,
        (select t053s.txt40
         from t053s
         where t053s.bukrs = rr.organ_id and t053s.rstgr = rr.reason_code) as reasonCodeText,
        col.col_money                                                      as amount,
        col.col_bank_name,
        '未入账'                                                              as entry_status,
        rr.subject_type,
        brr.up_customer_id,
        brr.up_customer_name,
        case when rr.subject = '' or rr.subject is null
          THEN (select hkont
                from v_acc_num
                where acc_num = col.col_bank_number)
        else rr.subject end                                                as subject,

  case when (select count (0) from cepc_bukrs where bukrs= rece.company_id) = 1
    then (select prctr from cepc_bukrs where bukrs=rece.company_id limit 1)
else
        case when rece.rece_prctr = '' or rece.rece_prctr is null
          then case when rr.profit_center_code != '' and rr.profit_center_code is not null
            then rr.profit_center_code
               else (select ru.profit_center_code
                     from fss_accounting_rule ru
                     where ru.organ_id = rece.company_id and type = '2') end
        else rece.rece_prctr end       end                                    as profitCenterCode, --利润中心
  case when (select count (0) from cepc_bukrs where bukrs= rece.company_id) = 1
    then (select cepct.ltext from cepc_bukrs join cepct on cepc_bukrs.prctr=cepct.prctr where bukrs=rece.company_id limit 1)
else
        case when rece.rece_ltext = '' or rece.rece_ltext is null
          then case when rr.profit_center_code != '' and rr.profit_center_code is not null
            then rr.profit_center
               else (select ru.profit_center
                     from fss_accounting_rule ru
                     where ru.organ_id = rece.company_id and type = '2') end
        else rece.rece_ltext end              end                             as profitCenter --利润中心名称
      from fss_bill_receivable_info rece
        left join fss_bill_receivable_recite brr on brr.rr_id = rece.rr_id
        left join fss_bill_receivable_collection col on rece.rece_id = col.rece_id
        left JOIN v_organ org ON rece.company_id = org.bukrs
        JOIN (select
                rul.*,
                enum.code
              from fss_accounting_rule rul left join sec_enum enum on enum.id = rul.commercian_unit_id
              where rul.type = '1') as rr
          ON rr.business_module = '应收票据' AND rr.business_type = '票据托收到账' AND
             (org.busi = rr.code OR rece.company_id = rr.organ_id)
      where rece.rece_id = #{subId} and rece.rece_state = '托收到账') as rro
    </select>
    <!--不终止确认票据分录-->
    <select id="getBillRecceNoterEntry" resultMap="BaseResultMap">
select
--rece.rece_id as subId,
--rece.rece_number as receNumber,
rr.rule_id as ruleId,
  rr.business_module_id                                                                 as businessModuleId,
  rr.business_module                                                                    as businessModule,
  rr.business_type                                                                      as businessType,
  rece.company_id as organId,
  rece.company_name as organName,
  rr.borrow_loan                                                                        as borrowLoan,
  rr.subject                                                                            as subject,
  (select skat.txt50
   from skat
     join t001 on t001.ktopl = skat.ktopl
   where skat.saknr = rr.subject and t001.bukrs = rece.company_id and skat.spras = '1') as subjectText,
  --科目名称
  rr.lifnr                                                                              as lifnr,
  --供应商/客户编码
  rr.lifnr_text                                                                         as lifnrText,
  -- 供应商/客户
  case when rece.rece_prctr = '' or rece.rece_prctr is null
    then case when rr.profit_center_code = '' or rr.profit_center_code is null
      then rr.profit_center_code
         else (select ru.profit_center_code
               from fss_accounting_rule ru
               where ru.organ_id = rece.company_id and type = '2') end
  else rece.rece_prctr end                                                              as profitCenterCode,
  --利润中心
  case when rece.rece_ltext = '' or rece.rece_ltext is null
    then case when rr.profit_center_code = '' or rr.profit_center_code is null
      then rr.profit_center
         else (select ru.profit_center
               from fss_accounting_rule ru
               where ru.organ_id = rece.company_id and type = '2') end
  else rece.rece_ltext end                                                              as profitCenter,
  --利润中心名称
  ''                                                                                    as cost_center_code,
  ''                                                                                    as cost_center,
  ''                                                                                    as wbsElementCode,
  ''                                                                                    as wbsElement,
  rr.reason_code,
  (select t053s.txt40
   from t053s
   where t053s.bukrs = rr.organ_id and t053s.rstgr = rr.reason_code)                    as reasonCodeText,
  sum(rece.rece_money)                                                                  as amount,
  '未入账'                                                                                 as entry_status,
        '不终止确认票据' as summary
from fss_bill_receivable_info rece
  left join fss_bill_receivable_recite brr on brr.rr_id = rece.rr_id
  left JOIN v_organ org ON rece.company_id = org.bukrs
  JOIN (select
          rul.*,
          enum.code
        from fss_accounting_rule rul left join sec_enum enum on enum.id = rul.commercian_unit_id
        where rul.type = '1') as rr
    ON rr.business_module = '应收票据' AND rr.business_type = '不终止确认票据' AND
       (org.busi = rr.code OR rece.company_id = rr.organ_id)
        where rece.is_state = 0 and rece.rece_id in
        <foreach collection="subIds" item="subId" index="index" open="(" close=")" separator=",">
            #{subId}
        </foreach>
group by rece.company_id, rr.business_module_id, rr.business_module, rr.business_type, rece.company_name, rr.borrow_loan,rr.subject,rr.lifnr_text,rr.lifnr,
  rece.rece_prctr,rr.profit_center,rr.profit_center_code,rece.rece_ltext,rr.reason_code,rr.organ_id,rr.rule_id
    </select>
    <!--折现分录-->
    <select id="getBillRecceDiscountEntry" resultMap="BaseResultMap">
select
--rece.rece_id as subId,
   rr.rule_id as ruleId,
--  rece.transfer_id as mainId,
  rr.business_module_id                                                                 as businessModuleId,
  rr.business_module                                                                    as businessModule,
  rr.business_type                                                                      as businessType,
  rece.company_id as organId,
  rece.company_name as organName,
  rr.borrow_loan                                                                        as borrowLoan,
  rr.subject                                                                            as subject,
  (select skat.txt50
   from skat
     join t001 on t001.ktopl = skat.ktopl
   where skat.saknr = rr.subject and t001.bukrs = rece.company_id and skat.spras = '1') as subjectText,
  --科目名称
  rr.lifnr                                                                              as lifnr,
  --供应商/客户编码
  rr.lifnr_text                                                                         as lifnrText,
  -- 供应商/客户
  case when rece.rece_prctr = '' or rece.rece_prctr is null
    then case when rr.profit_center_code = '' or rr.profit_center_code is null
      then rr.profit_center_code
         else (select ru.profit_center_code
               from fss_accounting_rule ru
               where ru.organ_id = rece.company_id and type = '2') end
  else rece.rece_prctr end                                                              as profitCenterCode,
  --利润中心
  case when rece.rece_ltext = '' or rece.rece_ltext is null
    then case when rr.profit_center_code = '' or rr.profit_center_code is null
      then rr.profit_center
         else (select ru.profit_center
               from fss_accounting_rule ru
               where ru.organ_id = rece.company_id and type = '2') end
  else rece.rece_ltext end                                                              as profitCenter,
  --利润中心名称
  ''                                                                                    as cost_center_code,
  ''                                                                                    as cost_center,
  ''                                                                                    as wbsElementCode,
  ''                                                                                    as wbsElement,
  rr.reason_code,
  (select t053s.txt40
   from t053s
   where t053s.bukrs = rr.organ_id and t053s.rstgr = rr.reason_code)                    as reasonCodeText,
  rr.tran_type as tranType,
        (0 - sum(rece.other_money))                                                                  as amount,
  '未入账'                                                                                 as entry_status,
        rr.subject_type as subjectType,
  '应收票据折现' as summary
from fss_bill_receivable_info rece
  left join fss_bill_receivable_recite brr on brr.rr_id = rece.rr_id
  left JOIN v_organ org ON rece.company_id = org.bukrs
  JOIN (select
          rul.*,
          enum.code
        from fss_accounting_rule rul left join sec_enum enum on enum.id = rul.commercian_unit_id
        where rul.type = '1') as rr
    ON rr.business_module = '应收票据' AND rr.business_type = '票据折现' AND
       (org.busi = rr.code OR rece.company_id = rr.organ_id)
       where rece.is_state = 0  and rece.rece_id in
        <foreach collection="subIds" item="subId" index="index" open="(" close=")" separator=",">
            #{subId}
        </foreach>
group by rece.company_id, rr.business_module_id, rr.business_module, rr.business_type, rece.company_name, rr.borrow_loan,rr.subject,rr.lifnr_text,rr.lifnr,
  rece.rece_prctr,rr.profit_center,rr.profit_center_code,rece.rece_ltext,rr.reason_code,rr.organ_id,rr.tran_type,rr.rule_id,rr.subject_type
        having (0 - sum(rece.other_money)) > 0
    </select>

    <delete id="delFssFactoringBillreceAllocation">
       delete from fss_bill_receivable_allocation  where sub_id=#{subId} and entry_status='未入账'  and entry_type=#{entryType}
    </delete>
</mapper>