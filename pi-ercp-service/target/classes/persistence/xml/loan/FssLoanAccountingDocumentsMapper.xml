<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.personnel.ercp.pi.persistence.mapper.loan.FssLoanAccountingDocumentsMapper">
  <resultMap id="BaseResultMap" type="cn.com.personnel.ercp.pi.persistence.entity.loan.FssLoanAccountingDocuments">
    <!--
      WARNING - @mbg.generated
    -->
    <id column="documents_id" jdbcType="VARCHAR" property="documentsId" />
    <result column="sub_id" jdbcType="VARCHAR" property="subId" />
    <result column="main_id" jdbcType="VARCHAR" property="mainId" />
    <result column="rule_id" jdbcType="VARCHAR" property="ruleId" />
    <result column="contract_name" jdbcType="VARCHAR" property="contractName" />
    <result column="contract_num" jdbcType="VARCHAR" property="contractNum" />
    <result column="organ_id" jdbcType="VARCHAR" property="organId" />
    <result column="organ_name" jdbcType="VARCHAR" property="organName" />
    <result column="summary" jdbcType="VARCHAR" property="summary" />
    <result column="currency_code" jdbcType="VARCHAR" property="currencyCode" />
    <result column="currency" jdbcType="VARCHAR" property="currency" />
    <result column="credit_date" jdbcType="VARCHAR" property="creditDate" />
    <result column="commercian_unit_id" jdbcType="VARCHAR" property="commercianUnitId" />
    <result column="commercian_unit" jdbcType="VARCHAR" property="commercianUnit" />
    <result column="business_module_id" jdbcType="VARCHAR" property="businessModuleId" />
    <result column="business_module" jdbcType="VARCHAR" property="businessModule" />
    <result column="business_type" jdbcType="VARCHAR" property="businessType" />
    <result column="borrow_loan" jdbcType="VARCHAR" property="borrowLoan" />
    <result column="subject" jdbcType="VARCHAR" property="subject" />
    <result column="subject_text" jdbcType="VARCHAR" property="subjectText" />
    <result column="lifnr" jdbcType="VARCHAR" property="lifnr" />
    <result column="lifnr_text" jdbcType="VARCHAR" property="lifnrText" />
    <result column="loan_term" jdbcType="VARCHAR" property="loanTerm" />
    <result column="project_stage" jdbcType="VARCHAR" property="projectStage" />
    <result column="subject_type" jdbcType="VARCHAR" property="subjectType" />
    <result column="project_code" jdbcType="VARCHAR" property="projectCode" />
    <result column="project_name" jdbcType="VARCHAR" property="projectName" />
    <result column="profit_center_code" jdbcType="VARCHAR" property="profitCenterCode" />
    <result column="profit_center" jdbcType="VARCHAR" property="profitCenter" />
    <result column="cost_center_code" jdbcType="VARCHAR" property="costCenterCode" />
    <result column="cost_center" jdbcType="VARCHAR" property="costCenter" />
    <result column="wbs_element_code" jdbcType="VARCHAR" property="wbsElementCode" />
    <result column="wbs_element" jdbcType="VARCHAR" property="wbsElement" />
    <result column="reason_code" jdbcType="VARCHAR" property="reasonCode" />
    <result column="reason_code_text" jdbcType="VARCHAR" property="reasonCodeText" />
    <result column="assigned_number" jdbcType="VARCHAR" property="assignedNumber" />
    <result column="amount" jdbcType="NUMERIC" property="amount" />
    <result column="entry_status" jdbcType="VARCHAR" property="entryStatus" />
    <result column="document_no" jdbcType="VARCHAR" property="documentNo" />
    <result column="message_number" jdbcType="VARCHAR" property="messageNumber" />
    <result column="internal_order" jdbcType="VARCHAR" property="internalOrder" />
    <result column="is_clear" jdbcType="VARCHAR" property="isClear" />
    <result column="type" jdbcType="VARCHAR" property="type" />
    <result column="remarks" jdbcType="VARCHAR" property="remarks" />
    <result column="status" jdbcType="VARCHAR" property="status" />
    <result column="reserve" jdbcType="VARCHAR" property="reserve" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="creator" jdbcType="VARCHAR" property="creator" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="updater" jdbcType="VARCHAR" property="updater" />
    <result column="deleted" jdbcType="VARCHAR" property="deleted" />
    <result column="business_type_list" jdbcType="VARCHAR" property="businessTypeList" />
    <result column="subject_type_list" jdbcType="VARCHAR" property="subjectTypeList" />
    <result column="entry_number" jdbcType="VARCHAR" property="entryNumber" />
    <result column="group_no" jdbcType="VARCHAR" property="groupNo" />
    <result column="entry_type" jdbcType="VARCHAR" property="entryType" />
    <result column="expiry_date" jdbcType="VARCHAR" property="expiryDate" />
    <result column="opposite_profit_center_code" jdbcType="VARCHAR" property="oppositeProfitCenterCode" />
    <result column="opposite_profit_center" jdbcType="VARCHAR" property="oppositeProfitCenter" />
    <result column="reversal_status" jdbcType="VARCHAR" property="reversalStatus" />
    <result column="reversal_sap_no" jdbcType="VARCHAR" property="reversalSapNo" />
    <result column="i_guid" jdbcType="VARCHAR" property="iGuid" />
    <result column="reversal_error_message" jdbcType="VARCHAR" property="reversalErrorMessage" />
    <result column="business_partner_id" jdbcType="VARCHAR" property="businessPartnerId" />
    <result column="business_partner" jdbcType="VARCHAR" property="businessPartner" />
    <result column="value_date" jdbcType="VARCHAR" property="valueDate" />
  </resultMap>

    <!--提款分录-->
    <select id="queryWithdrawAccountingRule" resultMap="BaseResultMap">
    --提款
select
distinct
  * ,
case
    when allTable.is_syndicated_loan = '是'
  then case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        allTable.branlifnr
			else ''
		end
  else
  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        case when allTable.subject_type = '借款往来科目' or allTable.subject_type = '利息往来科目'
          then (select lifnr from fss_base_bank_branch bra where bra.branch_id = allTable.loan_organization_id limit  1)
          else '' end
			else ''
		end  end as lifnr,

		(select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=(case
    when allTable.is_syndicated_loan = '是'
  then case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        allTable.branlifnr
			else ''
		end
  else
  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        case when allTable.subject_type = '借款往来科目' or allTable.subject_type = '利息往来科目'
          then (select lifnr from fss_base_bank_branch bra where bra.branch_id = allTable.loan_organization_id limit  1)
          else '' end
			else ''
		end  end) limit 1) as business_partner,
(select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=(case
    when allTable.is_syndicated_loan = '是'
  then case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        allTable.branlifnr
			else ''
		end
  else
  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        case when allTable.subject_type = '借款往来科目' or allTable.subject_type = '利息往来科目'
          then (select lifnr from fss_base_bank_branch bra where bra.branch_id = allTable.loan_organization_id limit  1)
          else '' end
			else ''
		end  end) limit 1) as business_partner_id,
case
    when allTable.is_syndicated_loan = '是'
  then  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
         allTable.branlifnrText
			else ''
		end
  else
    case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        case when allTable.subject_type = '借款往来科目' or allTable.subject_type = '利息往来科目'
          then (select lifnr_text from fss_base_bank_branch bra where bra.branch_id = allTable.loan_organization_id limit  1)
          else '' end
			else ''
		end
		end as lifnr_text,
   (select LTEXT from  CEPCt where prctr = allTable.profit_center_code limit 1) as profit_center,
   case when (select ska1.glaccount_type
                    from t001
                      join ska1 on t001.ktopl = ska1.ktopl
                    where t001.bukrs = allTable.organ_id and ska1.saknr = allTable.subject) = 'P'
                   and (allTable.cost_center_code != '' or allTable.cost_center_code is not null)
           then case when (allTable.cost_center_code != '' or allTable.cost_center_code is not null)
             then
               case when length(allTable.cost_center_code) = 6
                 then concat(allTable.organ_id, allTable.cost_center_code)
               when length(allTable.cost_center_code) = 4
                 then concat(allTable.profit_center_code, allTable.cost_center_code)
               when length(allTable.cost_center_code) = 10
                 then allTable.cost_center_code end
                else (select cost_center_code
                      from fss_accounting_rule
                      where organ_id = allTable.organ_id and type = '2') end
         else '' end                                                                                         as cost_center_code,
   (select cskt.ltext
          from csks
            join cskt on csks.kostl = cskt.kostl and csks.kokrs = cskt.kokrs and csks.bukrs = allTable.organ_id and to_date(csks.datbi, 'yyyyMMdd') &gt;= now()
          where csks.kostl =  (case when (select ska1.glaccount_type
                    from t001
                      join ska1 on t001.ktopl = ska1.ktopl
                    where t001.bukrs = allTable.organ_id and ska1.saknr = allTable.subject) = 'P'
                   and (allTable.cost_center_code != '' or allTable.cost_center_code is not null)
           then case when (allTable.cost_center_code != '' or allTable.cost_center_code is not null)
             then
               case when length(allTable.cost_center_code) = 6
                 then concat(allTable.organ_id, allTable.cost_center_code)
               when length(allTable.cost_center_code) = 4
                 then concat(allTable.profit_center_code, allTable.cost_center_code)
               when length(allTable.cost_center_code) = 10
                 then allTable.cost_center_code end
                else (select cost_center_code
                      from fss_accounting_rule
                      where organ_id = allTable.organ_id and type = '2') end
         else '' end) and csks.bukrs = allTable.organ_id
          limit 1)                                                                                           as cost_center,
          ''                                                                                                  as wbsElementCode,
          ''                                                                                                  as wbsElement,
   	'未入账' as entry_status
 from ( select
    iou.iou_id  as subId,
    iou.credit_date as creditDate,
    iou.currency_type as currency,
    man.company_id as organ_id,
    man.company_name as organ_name,
    man.assigned_number,
    man.manage_id as main_id,
    man.is_syndicated_loan,
    man.manage_id as main_id,
    man.contract_name as contract_name,
    man.contract_num as contract_num,
    bra.lifnr as branlifnr,
    bra.lifnr_text as branlifnrText,
    rr.rule_id,
    rr.business_module_id,
    rr.business_module,
    rr.business_type,
    rr.borrow_loan,
    rr.loan_term,
    rr.subject_type,
    iou.loan_organization_id,
    iou.loan_organization || '|外部借款|提款' as summary,
    rr.cost_center_code,
    rr.reason_code,
    case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = man.company_id
				and skb1.saknr = (case when  rr.subject_type = '银行科目' and (rr.subject = '' or rr.subject is null)
      then  (select hkont
        from v_acc_num
        where acc_num = man.bank_account limit 1)
    else rr.subject end)) in ('D', 'K') then
       iou.withdraw_date :: text
			else ''
		end    as expiry_date,
   (select t053s.txt40
          from t053s
          where t053s.bukrs = man.company_id and t053s.rstgr = rr.reason_code)                                                as reasonCodeText,
    case when  rr.subject_type = '银行科目' and (rr.subject = '' or rr.subject is null)
      then  (select hkont
        from v_acc_num
        where acc_num = (case when  man.is_syndicated_loan = '是' then syn.bank_account else man.bank_account end) limit 1)
    else rr.subject end as subject,
    (select skat.txt50
   from skat
     join t001 on t001.ktopl = skat.ktopl
   where skat.saknr = (case when  rr.subject_type = '银行科目' and (rr.subject = '' or rr.subject is null)
      then  (select hkont
        from v_acc_num
        where acc_num = (case when  man.is_syndicated_loan = '是' then syn.bank_account else man.bank_account end) limit 1)
    else rr.subject end) and t001.bukrs = man.company_id and skat.spras = '1') as subject_text,
   case when o.busi = '6000'
     then case when rr.profit_center_code = '' or rr.profit_center_code is null
       then pro.prctr else  rr.profit_center_code end
   else
       case when rr.profit_center_code = '' or rr.profit_center_code is null
       then (select profit_center_code from fss_accounting_rule where (organ_id = man.company_id or rr.code = o.busi) and type = '2' limit 1)
       else rr.profit_center_code end
     end as profit_center_code,
   case when man.is_syndicated_loan = '是'
     then case when  syn.total_amount_withdrawn > 0
             and (select count(*) from fss_loan_contract_manage_syndicated ss where ss.iou_id = iou.iou_id and ss.bank_account = syn.bank_account) > 1
       then iou.withdraw_amount
          else syn.this_application_amount end
       else iou.withdraw_amount  end as amount,
     rr.is_clear,
  case when rr.subject_type = '银行科目' then iou.withdraw_date :: text else '' end as value_date
  FROM fss_loan_contract_manage man
    left join fss_loan_contract_iou iou on man.manage_id = iou.manage_id
    left join fss_base_project_info pro on man.project_id = pro.project_id
    left join v_stonr sto on pro.objnr = sto.objnr
    left join fss_base_bank_branch bra on iou.loan_organization_id = bra.branch_id
    left join fss_loan_contract_manage_syndicated syn on syn.iou_id = iou.iou_id
    JOIN v_organ o ON man.company_id = o.bukrs
    JOIN (select
            r.*,
            enum.code
          from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
          where
            r.type = '1' and r.business_module = '外部借款' and r.business_type = '提款') as rr
      ON (case when exists(select 1  from fss_accounting_rule r where r.organ_id = man.company_id
                                                                     and r.type = '1' and r.business_module = '外部借款' and
                                                                     r.business_type = '提款')
      then rr.organ_id = man.company_id
          else rr.code = o.busi end) and (case when  man.loan_term_year &gt; '1' or man.loan_term_month &gt; '12' then (rr.loan_term != '一年以内') else  rr.loan_term != '一年以上'  end)
  where iou.iou_id = #{subId} and ((sto.stonr in ('10', '20', '30', '40', '50', '60', '70') and (rr.project_stage = '在建' or rr.project_stage = '' or rr.project_stage is null))
                    or ((sto.stonr = '80' or sto.stonr is null or pro.project_id is null or pro.project_id ='')
                    and (rr.project_stage = '运营' or rr.project_stage = '' or rr.project_stage is null))
                    or ((rr.project_stage = '' or rr.project_stage is null))) and rr.subject_type = '银行科目')
   as allTable

union all

     select * ,
case
    when allTabletow.is_syndicated_loan = '是'
  then case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTabletow.organ_id
				and skb1.saknr = allTabletow.subject) in ('D', 'K') then
        allTabletow.branlifnr
			else ''
		end
  else
  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTabletow.organ_id
				and skb1.saknr = allTabletow.subject) in ('D', 'K') then
        case when allTabletow.subject_type = '借款往来科目' or allTabletow.subject_type = '利息往来科目'
          then (select lifnr from fss_base_bank_branch bra where bra.branch_id = allTabletow.loan_organization_id limit  1)
          else '' end
			else ''
		end  end as lifnr,
		(select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=(case
    when allTabletow.is_syndicated_loan = '是'
  then case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTabletow.organ_id
				and skb1.saknr = allTabletow.subject) in ('D', 'K') then
        allTabletow.branlifnr
			else ''
		end
  else
  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTabletow.organ_id
				and skb1.saknr = allTabletow.subject) in ('D', 'K') then
        case when allTabletow.subject_type = '借款往来科目' or allTabletow.subject_type = '利息往来科目'
          then (select lifnr from fss_base_bank_branch bra where bra.branch_id = allTabletow.loan_organization_id limit  1)
          else '' end
			else ''
		end  end) limit 1) as business_partner,
		(select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=(case
    when allTabletow.is_syndicated_loan = '是'
  then case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTabletow.organ_id
				and skb1.saknr = allTabletow.subject) in ('D', 'K') then
        allTabletow.branlifnr
			else ''
		end
  else
  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTabletow.organ_id
				and skb1.saknr = allTabletow.subject) in ('D', 'K') then
        case when allTabletow.subject_type = '借款往来科目' or allTabletow.subject_type = '利息往来科目'
          then (select lifnr from fss_base_bank_branch bra where bra.branch_id = allTabletow.loan_organization_id limit  1)
          else '' end
			else ''
		end  end) limit 1) as business_partner_id,
case
    when allTabletow.is_syndicated_loan = '是'
  then  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTabletow.organ_id
				and skb1.saknr = allTabletow.subject) in ('D', 'K') then
         allTabletow.branlifnrText
			else ''
		end
  else
    case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTabletow.organ_id
				and skb1.saknr = allTabletow.subject) in ('D', 'K') then
        case when allTabletow.subject_type = '借款往来科目' or allTabletow.subject_type = '利息往来科目'
          then (select lifnr_text from fss_base_bank_branch bra where bra.branch_id = allTabletow.loan_organization_id limit  1)
          else '' end
			else ''
		end
		end as lifnr_text,
   (select LTEXT from  CEPCt where prctr = allTabletow.profit_center_code limit 1) as profit_center,
   case when (select ska1.glaccount_type
                    from t001
                      join ska1 on t001.ktopl = ska1.ktopl
                    where t001.bukrs = allTabletow.organ_id and ska1.saknr = allTabletow.subject) = 'P'
                   and (allTabletow.cost_center_code != '' or allTabletow.cost_center_code is not null)
           then case when (allTabletow.cost_center_code != '' or allTabletow.cost_center_code is not null)
             then
               case when length(allTabletow.cost_center_code) = 6
                 then concat(allTabletow.organ_id, allTabletow.cost_center_code)
               when length(allTabletow.cost_center_code) = 4
                 then concat(allTabletow.profit_center_code, allTabletow.cost_center_code)
               when length(allTabletow.cost_center_code) = 10
                 then allTabletow.cost_center_code end
                else (select cost_center_code
                      from fss_accounting_rule
                      where organ_id = allTabletow.organ_id and type = '2') end
         else '' end                                                                                         as cost_center_code,
   (select cskt.ltext
          from csks
            join cskt on csks.kostl = cskt.kostl and csks.kokrs = cskt.kokrs and csks.bukrs = allTabletow.organ_id and to_date(csks.datbi, 'yyyyMMdd') &gt;= now()
          where csks.kostl =  (case when (select ska1.glaccount_type
                    from t001
                      join ska1 on t001.ktopl = ska1.ktopl
                    where t001.bukrs = allTabletow.organ_id and ska1.saknr = allTabletow.subject) = 'P'
                   and (allTabletow.cost_center_code != '' or allTabletow.cost_center_code is not null)
           then case when (allTabletow.cost_center_code != '' or allTabletow.cost_center_code is not null)
             then
               case when length(allTabletow.cost_center_code) = 6
                 then concat(allTabletow.organ_id, allTabletow.cost_center_code)
               when length(allTabletow.cost_center_code) = 4
                 then concat(allTabletow.profit_center_code, allTabletow.cost_center_code)
               when length(allTabletow.cost_center_code) = 10
                 then allTabletow.cost_center_code end
                else (select cost_center_code
                      from fss_accounting_rule
                      where organ_id = allTabletow.organ_id and type = '2') end
         else '' end) and csks.bukrs = allTabletow.organ_id
          limit 1)                                                                                           as cost_center,
          ''                                                                                                  as wbsElementCode,
          ''                                                                                                  as wbsElement,
       '未入账' as entry_status
 from ( select
    iou.iou_id  as subId,
    iou.credit_date as creditDate,
    iou.currency_type as currency,
    man.company_id as organ_id,
    man.company_name as organ_name,
    man.assigned_number,
    man.manage_id as main_id,
    man.is_syndicated_loan,
    man.manage_id as main_id,
    man.contract_name as contract_name,
    man.contract_num as contract_num,
    bra.lifnr as branlifnr,
    bra.lifnr_text as branlifnrText,
    rr.rule_id,
    rr.business_module_id,
    rr.business_module,
    rr.business_type,
    rr.borrow_loan,
    rr.loan_term,
    rr.subject_type,
    iou.loan_organization_id,
    iou.loan_organization || '|外部借款|提款' as summary,
    rr.cost_center_code,
    rr.reason_code,
    case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = man.company_id
				and skb1.saknr = (case when  rr.subject_type = '银行科目' and (rr.subject = '' or rr.subject is null)
      then  (select hkont
        from v_acc_num
        where acc_num = man.bank_account limit 1)
    else rr.subject end)) in ('D', 'K') then
       plan.plan_date :: text
			else ''
		end    as expiry_date,
   (select t053s.txt40
          from t053s
          where t053s.bukrs = man.company_id and t053s.rstgr = rr.reason_code)                                                as reasonCodeText,
    case when  rr.subject_type = '银行科目' and (rr.subject = '' or rr.subject is null)
      then  (select hkont
        from v_acc_num
        where acc_num = man.bank_account limit 1)
    else rr.subject end as subject,
    (select skat.txt50
   from skat
     join t001 on t001.ktopl = skat.ktopl
   where skat.saknr = (case when  rr.subject_type = '银行科目' and (rr.subject = '' or rr.subject is null)
      then  (select hkont
        from v_acc_num
        where acc_num = man.bank_account limit 1)
    else rr.subject end) and t001.bukrs = man.company_id and skat.spras = '1') as subject_text,
   case when o.busi = '6000'
     then case when rr.profit_center_code = '' or rr.profit_center_code is null
       then pro.prctr else  rr.profit_center_code end
   else
       case when rr.profit_center_code = '' or rr.profit_center_code is null
       then (select profit_center_code from fss_accounting_rule where (organ_id = man.company_id or rr.code = o.busi) and type = '2' limit 1)
       else rr.profit_center_code end
     end as profit_center_code,
   plan.actual_planned_repayment_amount as amount,
   rr.is_clear,
  case when rr.subject_type = '银行科目' then iou.withdraw_date :: text else '' end as value_date
  FROM fss_loan_contract_manage man
    left join fss_loan_contract_iou iou on man.manage_id = iou.manage_id
    left join fss_base_project_info pro on man.project_id = pro.project_id
    left join v_stonr sto on pro.objnr = sto.objnr
    left join fss_loan_contract_iou_repayment_plan plan on plan.main_id = iou.iou_id and plan.actual_planned_repayment_amount is not null
    left join fss_base_bank_branch bra on plan.branch_id = bra.branch_id
    JOIN v_organ o ON man.company_id = o.bukrs
    JOIN (select
            r.*,
            enum.code
          from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
          where
            r.type = '1' and r.business_module = '外部借款' and r.business_type = '提款') as rr
      ON (case when exists(select 1  from fss_accounting_rule r where r.organ_id = man.company_id
                                                                     and r.type = '1' and r.business_module = '外部借款' and
                                                                     r.business_type = '提款')
      then rr.organ_id = man.company_id
          else rr.code = o.busi end) and (case when  man.loan_term_year &gt; '1' or man.loan_term_month &gt; '12' then (rr.loan_term != '一年以内') else  rr.loan_term != '一年以上'  end)
  where iou.iou_id = #{subId} and ((sto.stonr in ('10', '20', '30', '40', '50', '60', '70') and (rr.project_stage = '在建' or rr.project_stage = '' or rr.project_stage is null))
                    or ((sto.stonr = '80' or sto.stonr is null or pro.project_id is null or pro.project_id ='')
                    and (rr.project_stage = '运营' or rr.project_stage = '' or rr.project_stage is null))
                    or ((rr.project_stage = '' or rr.project_stage is null))) and rr.subject_type != '银行科目') as allTabletow
    </select>
    <!--预提-->
    <select id="queryPreWithdrawAccountingRule" resultMap="BaseResultMap">
select distinct * ,
case
    when allTable.is_syndicated_loan = '是'
  then case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        allTable.branlifnr
			else ''
		end
  else
  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        case when allTable.subject_type = '借款往来科目' or allTable.subject_type = '利息往来科目'
          then (select lifnr from fss_base_bank_branch bra where bra.branch_id = allTable.loan_organization_id limit  1)
          else '' end
			else ''
		end  end as lifnr,
		(select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=(case
    when allTable.is_syndicated_loan = '是'
  then case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        allTable.branlifnr
			else ''
		end
  else
  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        case when allTable.subject_type = '借款往来科目' or allTable.subject_type = '利息往来科目'
          then (select lifnr from fss_base_bank_branch bra where bra.branch_id = allTable.loan_organization_id limit  1)
          else '' end
			else ''
		end  end) limit 1) as business_partner,
		(select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=(case
    when allTable.is_syndicated_loan = '是'
  then case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        allTable.branlifnr
			else ''
		end
  else
  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        case when allTable.subject_type = '借款往来科目' or allTable.subject_type = '利息往来科目'
          then (select lifnr from fss_base_bank_branch bra where bra.branch_id = allTable.loan_organization_id limit  1)
          else '' end
			else ''
		end  end) limit 1) as business_partner_id,
case
    when allTable.is_syndicated_loan = '是'
  then  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
         allTable.branlifnrText
			else ''
		end
  else
    case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        case when allTable.subject_type = '借款往来科目' or allTable.subject_type = '利息往来科目'
          then (select lifnr_text from fss_base_bank_branch bra where bra.branch_id = allTable.loan_organization_id limit  1)
          else '' end
			else ''
		end
		end as lifnr_text,
   (select LTEXT from  CEPCt where prctr = allTable.profit_center_code limit 1) as profit_center,
   case when (select ska1.glaccount_type
                    from t001
                      join ska1 on t001.ktopl = ska1.ktopl
                    where t001.bukrs = allTable.organ_id and ska1.saknr = allTable.subject) = 'P'
           then case when  (select cost_center_code
                      from fss_accounting_rule
                      where organ_id = allTable.organ_id and type = '2' and profit_center_code = allTable.profit_center_code limit 1) is not null and (select cost_center_code
                      from fss_accounting_rule
                      where organ_id = allTable.organ_id and type = '2'  and profit_center_code = allTable.profit_center_code limit 1) != ''
             then
                (select cost_center_code
                      from fss_accounting_rule
                      where organ_id = allTable.organ_id and type = '2'  and profit_center_code = allTable.profit_center_code limit 1)
                else case when length(allTable.cost_center_code_c) = 6
                 then concat(allTable.organ_id, allTable.cost_center_code_c)
               when length(allTable.cost_center_code_c) = 4
                 then ltrim(concat(allTable.profit_center_code, allTable.cost_center_code_c), '0')
               when length(allTable.cost_center_code_c) = 10
                 then allTable.cost_center_code_c end end
         else '' end                                                                                         as cost_center_code,
   (select cskt.ltext
          from csks
            join cskt on csks.kostl = cskt.kostl and csks.kokrs = cskt.kokrs and csks.bukrs = allTable.organ_id and to_date(csks.datbi, 'yyyyMMdd') &gt;= now()
          where csks.kostl = (case when (select ska1.glaccount_type
                    from t001
                      join ska1 on t001.ktopl = ska1.ktopl
                    where t001.bukrs = allTable.organ_id and ska1.saknr = allTable.subject) = 'P'

           then case when  (select cost_center_code
                      from fss_accounting_rule
                      where organ_id = allTable.organ_id and type = '2' and profit_center_code = allTable.profit_center_code limit 1) is not null and (select cost_center_code
                      from fss_accounting_rule
                      where organ_id = allTable.organ_id and type = '2' and profit_center_code = allTable.profit_center_code limit 1) != ''
             then
                (select cost_center_code
                      from fss_accounting_rule
                      where organ_id = allTable.organ_id and type = '2' and profit_center_code = allTable.profit_center_code limit 1)
                else case when length(allTable.cost_center_code_c) = 6
                 then concat(allTable.organ_id, allTable.cost_center_code_c)
               when length(allTable.cost_center_code_c) = 4
                 then ltrim(concat(allTable.profit_center_code, allTable.cost_center_code_c), '0')
               when length(allTable.cost_center_code_c) = 10
                 then allTable.cost_center_code_c end end
         else '' end) and csks.bukrs = allTable.organ_id
          limit 1)                                                                                           as cost_center,
   (select post1 from prps p where p.pspnr = allTable.wbs_element_code limit 1) as wbs_element,
   	'未入账' as entry_status
 from ( select
    o.busi                                                                              as commercianUnitId,
    o.busitext                                                                          as commercianUnit,
    wit.pre_withdraw_id as sub_id,
    wit.credit_date as creditDate,
    wit.currency_type as currency,
    wit.bank_name || '|外部借款|预提' as summary,
    man.company_id as organ_id,
    man.company_name as organ_name,
    man.assigned_number,
    man.is_syndicated_loan,
    man.manage_id as main_id,
    man.contract_name as contract_name,
    man.contract_num as contract_num,
    bra.lifnr as branlifnr,
    bra.lifnr_text as branlifnrText,
    rr.business_module_id,
    rr.business_module,
    rr.business_type,
    rr.borrow_loan,
    rr.loan_term,
    rr.rule_id,
    rr.subject_type,
    rr.is_clear,
    wit.bank_id as loan_organization_id,
    rr.cost_center_code as cost_center_code_c,
    rr.reason_code,
    case when  rr.subject_type = '财务费用科目' or rr.subject_type = '项目费用科目' then null else wit.credit_date end as expiry_date,
   (select t053s.txt40
          from t053s
          where t053s.bukrs = man.company_id and t053s.rstgr = rr.reason_code)                                                as reasonCodeText,
    case when  rr.subject_type = '银行科目' and (rr.subject = '' or rr.subject is null)
      then  (select hkont
        from v_acc_num
        where acc_num = man.bank_account limit 1)
    else rr.subject end as subject,
    (select skat.txt50
   from skat
     join t001 on t001.ktopl = skat.ktopl
   where skat.saknr = (case when  rr.subject_type = '银行科目' and (rr.subject = '' or rr.subject is null)
      then  (select hkont
        from v_acc_num
        where acc_num = man.bank_account limit 1)
    else rr.subject end) and t001.bukrs = man.company_id and skat.spras = '1') as subject_text,
   case when o.busi = '6000'
     then case when rr.profit_center_code = '' or rr.profit_center_code is null
       then pro.prctr else  rr.profit_center_code end
   else
       case when rr.profit_center_code = '' or rr.profit_center_code is null
       then (select profit_center_code from fss_accounting_rule where (organ_id = man.company_id or rr.code = o.busi) and type = '2' limit 1)
       else rr.profit_center_code end
     end as profit_center_code,
     wit.pre_with_draw_amount as amount,
   case when rr.subject_type = '项目费用科目' and (rr.internal_order is null or rr.internal_order = '') then
     case when o.busi = '6000' then concat(pro.pspid ,rr.wbs_element_code)
     when o.busi = '5000' then (select wbs_element_code from fss_accounting_rule where organ_id = man.company_id and type = '2' limit 1)
       else '' end
     else '' end wbs_element_code
  FROM fss_loan_contract_manage man
    left join fss_loan_contract_pre_withdraw wit on man.manage_id = wit.manage_id
    left join fss_base_project_info pro on man.project_id = pro.project_id
    left join v_stonr sto on pro.objnr = sto.objnr
    left join fss_base_bank_branch bra on wit.bank_id = bra.branch_id
    JOIN v_organ o ON man.company_id = o.bukrs
    JOIN (select
            r.*,
            enum.code
          from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
          where
            r.type = '1' and r.business_module = '外部借款' and r.business_type = '预提') as rr
      ON (case when exists(select 1  from fss_accounting_rule r where r.organ_id = man.company_id
                                                                     and r.type = '1' and r.business_module = '外部借款' and
                                                                     r.business_type = '预提')
      then rr.organ_id = man.company_id
          else rr.code = o.busi end) and (case when  man.loan_term_year &gt; '1' or man.loan_term_month &gt; '12' then (rr.loan_term != '一年以内') else  rr.loan_term != '一年以上'  end)
  where wit.pre_withdraw_id = #{subId} and case when o.busi != '5000' then  ((sto.stonr in ('10', '20', '30', '40', '50', '60', '70') and (rr.project_stage = '在建' or rr.project_stage = '' or rr.project_stage is null))
                    or ((sto.stonr = '80' or sto.stonr is null or pro.project_id is null or pro.project_id ='')
                    and (rr.project_stage = '运营' or rr.project_stage = '' or rr.project_stage is null))
                    or ((rr.project_stage = '' or rr.project_stage is null))) else
    case when pro.pspid like 'E%' then
      ((sto.stonr in ('10', '20', '40', '50', '60') and (rr.project_stage = '在建' or rr.project_stage = '' or rr.project_stage is null))
                    or ((sto.stonr = '30' or sto.stonr is null or pro.project_id is null or pro.project_id ='')
                    and (rr.project_stage = '运营' or rr.project_stage = '' or rr.project_stage is null))
                    or ((rr.project_stage = '' or rr.project_stage is null)))
      else
        (rr.project_stage = '运营' or rr.project_stage = '' or rr.project_stage is null)
        end
    end

      ) as allTable
    </select>
    <!--付息-->
    <select id="queryPayInterestAccountingRule" resultMap="BaseResultMap">
select distinct * ,
       (select skat.txt50
        from t001 join skat on t001.ktopl=skat.ktopl and skat.spras='1'
                  join skb1 on skat.saknr=skb1.saknr
        where skb1.saknr=allTable.subject and t001.bukrs =allTable.organ_id
        group by skb1.saknr,t001.bukrs,t001.ktopl,skat.txt50
        order by t001.ktopl
        limit 1) as subject_text,
case
    when allTable.is_syndicated_loan = '是'
  then case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        allTable.branlifnr
			else ''
		end
  else
  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        case when allTable.subject_type = '借款往来科目' or allTable.subject_type = '利息往来科目'
          then (select lifnr from fss_base_bank_branch bra where bra.branch_id = allTable.loan_organization_id limit  1)
          else '' end
			else ''
		end  end as lifnr,
		(select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=(case
    when allTable.is_syndicated_loan = '是'
  then case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        allTable.branlifnr
			else ''
		end
  else
  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        case when allTable.subject_type = '借款往来科目' or allTable.subject_type = '利息往来科目'
          then (select lifnr from fss_base_bank_branch bra where bra.branch_id = allTable.loan_organization_id limit  1)
          else '' end
			else ''
		end  end) limit 1) as business_partner,
		(select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=(case
    when allTable.is_syndicated_loan = '是'
  then case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        allTable.branlifnr
			else ''
		end
  else
  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        case when allTable.subject_type = '借款往来科目' or allTable.subject_type = '利息往来科目'
          then (select lifnr from fss_base_bank_branch bra where bra.branch_id = allTable.loan_organization_id limit  1)
          else '' end
			else ''
		end  end) limit 1) as business_partner_id,
case
    when allTable.is_syndicated_loan = '是'
  then  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
         allTable.branlifnrText
			else ''
		end
  else
    case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        case when allTable.subject_type = '借款往来科目' or allTable.subject_type = '利息往来科目'
          then (select lifnr_text from fss_base_bank_branch bra where bra.branch_id = allTable.loan_organization_id limit  1)
          else '' end
			else ''
		end
		end as lifnr_text,
   (select LTEXT from  CEPCt where prctr = allTable.profit_center_code limit 1) as profit_center,
   case when (select ska1.glaccount_type
                    from t001
                      join ska1 on t001.ktopl = ska1.ktopl
                    where t001.bukrs = allTable.organ_id and ska1.saknr = allTable.subject) = 'P'
                   and (allTable.cost_center_code_c != '' or allTable.cost_center_code_c is not null)
           then case when (allTable.cost_center_code_c != '' or allTable.cost_center_code_c is not null)
             then
               case when length(allTable.cost_center_code_c) = 6
                 then concat(allTable.organ_id, allTable.cost_center_code_c)
               when length(allTable.cost_center_code_c) = 4
                 then ltrim(concat(allTable.profit_center_code, allTable.cost_center_code_c), '0')
               when length(allTable.cost_center_code_c) = 10
                 then allTable.cost_center_code_c end
                else (select cost_center_code
                      from fss_accounting_rule
                      where organ_id = allTable.organ_id and type = '2') end
         else '' end                                                                                         as cost_center_code,
   (select cskt.ltext
          from csks
            join cskt on csks.kostl = cskt.kostl and csks.kokrs = cskt.kokrs and csks.bukrs = allTable.organ_id and to_date(csks.datbi, 'yyyyMMdd') &gt;= now()
          where csks.kostl =  (case when (select ska1.glaccount_type
                    from t001
                      join ska1 on t001.ktopl = ska1.ktopl
                    where t001.bukrs = allTable.organ_id and ska1.saknr = allTable.subject) = 'P'
                   and (allTable.cost_center_code_c != '' or allTable.cost_center_code_c is not null)
           then case when (allTable.cost_center_code_c != '' or allTable.cost_center_code_c is not null)
             then
               case when length(allTable.cost_center_code_c) = 6
                 then concat(allTable.organ_id, allTable.cost_center_code_c)
               when length(allTable.cost_center_code_c) = 4
                 then ltrim(concat(allTable.profit_center_code, allTable.cost_center_code_c), '0')
               when length(allTable.cost_center_code_c) = 10
                 then allTable.cost_center_code_c end
                else (select cost_center_code
                      from fss_accounting_rule
                      where organ_id = allTable.organ_id and type = '2') end
         else '' end) and csks.bukrs = allTable.organ_id
          limit 1)                                                                                           as cost_center,
(select post1 from prps p where p.pspnr = allTable.wbs_element_code limit 1) as wbs_element,
   	'未入账' as entry_status
 from ( select
    payin.interest_id as sub_id,
    payin.credit_date,
    payin.currency_type as currency,
    payin.bank_name || '|外部借款|付息' as summary,
    man.company_id as organ_id,
    man.company_name as organ_name,
    man.assigned_number,
    man.is_syndicated_loan,
    man.manage_id as main_id,
    man.contract_name as contract_name,
    man.contract_num as contract_num,
    bra.lifnr as branlifnr,
    bra.lifnr_text as branlifnrText,
    rr.rule_id,
    rr.business_module_id,
    rr.business_module,
    rr.business_type,
    rr.borrow_loan,
    rr.loan_term,
    rr.subject_type,
    rr.is_clear,
    payin.bank_id as loan_organization_id,
    rr.cost_center_code as cost_center_code_c,
    rr.reason_code,
   case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = man.company_id
				and skb1.saknr = (case when  rr.subject_type = '银行科目' and (rr.subject = '' or rr.subject is null)
      then  (select hkont
        from v_acc_num
        where acc_num = man.still_bank_account limit 1)
    else rr.subject end)) in ('D', 'K') then
       payin.credit_date :: text
			else ''
		end    as expiry_date,
   (select t053s.txt40
          from t053s
          where t053s.bukrs = man.company_id and t053s.rstgr = rr.reason_code limit 1)                                                as reasonCodeText,
    case when  rr.subject_type = '银行科目' and (rr.subject = '' or rr.subject is null)
     then  (case when man.is_syndicated_loan = '否' then (select hkont from v_acc_num where acc_num = man.still_bank_account limit 1)
         else case when (select bank_account from fss_loan_contract_manage_syndicated flcms where manage_id =man.manage_id and branch_id =payin.bank_id and data_flag ='初始化银团' limit 1) is not null then
           (select hkont from v_acc_num where acc_num =(select bank_account from fss_loan_contract_manage_syndicated flcms where manage_id =man.manage_id and branch_id =payin.bank_id and data_flag ='初始化银团' limit 1))
       else '' end end
    )
         else rr.subject end as subject,
--     (select skat.txt50
--    from skat
--      join t001 on t001.ktopl = skat.ktopl
--    where skat.saknr = (case when  rr.subject_type = '银行科目' and (rr.subject = '' or rr.subject is null)
--       then  (select hkont
--         from v_acc_num
--         where acc_num = man.still_bank_account limit 1)
--     else rr.subject end) and t001.bukrs = man.company_id and skat.spras = '1') as subject_text,
   case when o.busi = '6000'
     then case when rr.profit_center_code = '' or rr.profit_center_code is null
       then pro.prctr else  rr.profit_center_code end
   else
       case when rr.profit_center_code = '' or rr.profit_center_code is null
       then (select profit_center_code from fss_accounting_rule where (organ_id = man.company_id or rr.code = o.busi) and type = '2' limit 1)
       else rr.profit_center_code end
     end as profit_center_code,
     payin.pay_interest_amount as amount,
     case when rr.subject_type = '项目费用科目' then
     case when o.busi = '6000' then concat(pro.pspid ,rr.wbs_element_code)
     when o.busi = '5000' then (select wbs_element_code from fss_accounting_rule where organ_id = man.company_id and type = '2' limit 1)
       else '' end
     else '' end wbs_element_code
  FROM fss_loan_contract_manage man
    left join fss_loan_contract_pay_interest payin on man.manage_id = payin.manage_id
    left join fss_base_project_info pro on man.project_id = pro.project_id
    left join v_stonr sto on pro.objnr = sto.objnr
    left join fss_base_bank_branch bra on payin.bank_id = bra.branch_id
    JOIN v_organ o ON man.company_id = o.bukrs
    JOIN (select r.*, enum.code from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
      where r.type = '1'  and r.business_module = '外部借款' and r.business_type = '付息') as rr
     ON (case when exists (select 1 from fss_accounting_rule r where r.organ_id=o.bukrs
     and r.type = '1'  and r.business_module = '外部借款' and r.business_type = '付息') then rr.organ_id=o.bukrs
              else rr.code=o.busi and (rr.organ_id is null or rr.organ_id = '') end) and (case when  man.loan_term_year &gt; '1' or man.loan_term_month &gt; '12' then (rr.loan_term != '一年以内') else  rr.loan_term != '一年以上'  end)
  where payin.interest_id = #{subId} and  ((sto.stonr in ('10', '20', '30', '40', '50', '60', '70') and (rr.project_stage = '在建' or rr.project_stage = '' or rr.project_stage is null))
                    or ((sto.stonr = '80' or sto.stonr is null or pro.project_id is null or pro.project_id ='')
                    and (rr.project_stage = '运营' or rr.project_stage = '' or rr.project_stage is null))
                    or ((rr.project_stage = '' or rr.project_stage is null)))) as allTable
    </select>
    <!--还款-->
    <select id="queryRepaymentAccountingRule" resultMap="BaseResultMap">
select distinct * ,
        (select skat.txt50
         from t001 join skat on t001.ktopl=skat.ktopl and skat.spras='1'
                   join skb1 on skat.saknr=skb1.saknr
         where skb1.saknr=allTable.subject and t001.bukrs =allTable.organ_id
         group by skb1.saknr,t001.bukrs,t001.ktopl,skat.txt50
         order by t001.ktopl
         limit 1) as subject_text,
case
    when allTable.is_syndicated_loan = '是'
  then case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        allTable.branlifnr
			else ''
		end
  else
  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        case when allTable.subject_type = '借款往来科目' or allTable.subject_type = '利息往来科目'
          then (select lifnr from fss_base_bank_branch bra where bra.branch_id = allTable.loan_organization_id limit  1)
          else '' end
			else ''
		end  end as lifnr,
		(select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=(case
    when allTable.is_syndicated_loan = '是'
  then case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        allTable.branlifnr
			else ''
		end
  else
  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        case when allTable.subject_type = '借款往来科目' or allTable.subject_type = '利息往来科目'
          then (select lifnr from fss_base_bank_branch bra where bra.branch_id = allTable.loan_organization_id limit  1)
          else '' end
			else ''
		end  end) limit 1) as business_partner,
		(select ltrim(lfa1.vbund,'0') from lfa1 where ltrim(lfa1.lifnr, '0')=(case
    when allTable.is_syndicated_loan = '是'
  then case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        allTable.branlifnr
			else ''
		end
  else
  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        case when allTable.subject_type = '借款往来科目' or allTable.subject_type = '利息往来科目'
          then (select lifnr from fss_base_bank_branch bra where bra.branch_id = allTable.loan_organization_id limit  1)
          else '' end
			else ''
		end  end) limit 1) as business_partner_id,
case
    when allTable.is_syndicated_loan = '是'
  then  case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
         allTable.branlifnrText
			else ''
		end
  else
    case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = allTable.organ_id
				and skb1.saknr = allTable.subject) in ('D', 'K') then
        case when allTable.subject_type = '借款往来科目' or allTable.subject_type = '利息往来科目'
          then (select lifnr_text from fss_base_bank_branch bra where bra.branch_id = allTable.loan_organization_id limit  1)
          else '' end
			else ''
		end
		end as lifnr_text,
   (select LTEXT from  CEPCt where prctr = allTable.profit_center_code limit 1) as profit_center,
   case when (select ska1.glaccount_type
                    from t001
                      join ska1 on t001.ktopl = ska1.ktopl
                    where t001.bukrs = allTable.organ_id and ska1.saknr = allTable.subject) = 'P'
                   and (allTable.cost_center_code != '' or allTable.cost_center_code is not null)
           then case when (allTable.cost_center_code != '' or allTable.cost_center_code is not null)
             then
               case when length(allTable.cost_center_code) = 6
                 then concat(allTable.organ_id, allTable.cost_center_code)
               when length(allTable.cost_center_code) = 4
                 then concat(allTable.profit_center_code, allTable.cost_center_code)
               when length(allTable.cost_center_code) = 10
                 then allTable.cost_center_code end
                else (select cost_center_code
                      from fss_accounting_rule
                      where organ_id = allTable.organ_id and type = '2') end
         else '' end                                                                                         as cost_center_code,
   (select cskt.ltext
          from csks
            join cskt on csks.kostl = cskt.kostl and csks.kokrs = cskt.kokrs and csks.bukrs = allTable.organ_id and to_date(csks.datbi, 'yyyyMMdd')&gt;= now()
          where csks.kostl = (case when (select ska1.glaccount_type
                    from t001
                      join ska1 on t001.ktopl = ska1.ktopl
                    where t001.bukrs = allTable.organ_id and ska1.saknr = allTable.subject) = 'P'
                   and (allTable.cost_center_code != '' or allTable.cost_center_code is not null)
           then case when (allTable.cost_center_code != '' or allTable.cost_center_code is not null)
             then
               case when length(allTable.cost_center_code) = 6
                 then concat(allTable.organ_id, allTable.cost_center_code)
               when length(allTable.cost_center_code) = 4
                 then concat(allTable.profit_center_code, allTable.cost_center_code)
               when length(allTable.cost_center_code) = 10
                 then allTable.cost_center_code end
                else (select cost_center_code
                      from fss_accounting_rule
                      where organ_id = allTable.organ_id and type = '2') end
         else '' end) and csks.bukrs = allTable.organ_id
          limit 1)                                                                                           as cost_center,
(select post1 from prps p where p.pspnr = allTable.wbs_element_code limit 1) as wbs_element,
   	'未入账' as entry_status
 from ( select
    man.company_id as organ_id,
    man.company_name as organ_name,
    man.is_syndicated_loan,
    man.assigned_number,
    man.manage_id as main_id,
    man.contract_name as contract_name,
    man.contract_num as contract_num,
    rep.repayment_id as sub_id,
    rep.credit_date,
    rep.currency_type as currency,
    rep.loan_organization || '|外部借款|还款' as summary,
    bra.lifnr as branlifnr,
    bra.lifnr_text as branlifnrText,
    rr.rule_id,
    rr.business_module_id,
    rr.business_module,
    rr.business_type,
    rr.borrow_loan,
    rr.loan_term,
    rr.subject_type,
    rr.is_clear,
    rep.loan_organization_id,
    rr.cost_center_code,
    rr.reason_code,
    case
			when (
			select
				skb1.mitkz
			from
				skb1
			where
				skb1.bukrs = man.company_id
				and skb1.saknr = (case when  rr.subject_type = '银行科目' and (rr.subject = '' or rr.subject is null)
      then  (select hkont
        from v_acc_num
        where acc_num = man.still_bank_account limit 1)
    else rr.subject end)) in ('D', 'K') then
       rep.repayment_date :: text
			else ''
		end    as expiry_date,
   (select t053s.txt40
          from t053s
          where t053s.bukrs = man.company_id and t053s.rstgr = rr.reason_code)                                                as reasonCodeText,
    case when  rr.subject_type = '银行科目' and (rr.subject = '' or rr.subject is null)
             then  (case when man.is_syndicated_loan = '否' then (select hkont from v_acc_num where acc_num = man.still_bank_account limit 1)
             else case when (select bank_account from fss_loan_contract_manage_syndicated flcms where manage_id =man.manage_id and branch_id =rep.loan_organization_id and data_flag ='初始化银团' limit 1) is not null then
                   (select hkont from v_acc_num where acc_num =(select bank_account from fss_loan_contract_manage_syndicated flcms where manage_id =man.manage_id and branch_id =rep.loan_organization_id and data_flag ='初始化银团' limit 1))
               else '' end end
            )
         else rr.subject end as subject,
--    (select skat.txt50
--    from skat
--      join t001 on t001.ktopl = skat.ktopl
--    where skat.saknr = (case when  rr.subject_type = '银行科目' and (rr.subject = '' or rr.subject is null)
--       then  (select hkont
--         from v_acc_num
--         where acc_num = (case when repitem.still_bank_account is null or repitem.still_bank_account = '' then man.still_bank_account else repitem.still_bank_account end) limit 1)
--     else rr.subject end) and t001.bukrs = man.company_id and skat.spras = '1') as subject_text,
   case when o.busi = '6000'
     then case when rr.profit_center_code = '' or rr.profit_center_code is null
       then pro.prctr else  rr.profit_center_code end
   else
       case when rr.profit_center_code = '' or rr.profit_center_code is null
       then (select profit_center_code from fss_accounting_rule where (organ_id = man.company_id or rr.code = o.busi) and type = '2' limit 1)
       else rr.profit_center_code end
     end as profit_center_code,
     repitem.this_repayment_amount as amount,
     case when rr.subject_type = '项目费用科目' then
     case when o.busi = '6000' then concat(pro.pspid ,rr.wbs_element_code)
     when o.busi = '5000' then (select wbs_element_code from fss_accounting_rule where organ_id = man.company_id and type = '2')
       else '' end
     else '' end wbs_element_code,
   case when rr.subject_type = '银行科目' then iou.withdraw_date :: text else '' end as value_date
  FROM fss_loan_contract_manage man
    left join fss_loan_contract_repayment rep on man.manage_id = rep.manage_id
    left join fss_base_project_info pro on man.project_id = pro.project_id
    left join v_stonr sto on pro.objnr = sto.objnr
    left join fss_loan_contract_repayment_item repitem on repitem.main_id = rep.repayment_id
    left join fss_loan_contract_iou iou on repitem.iou_id = iou.iou_id
    left join fss_loan_contract_manage_syndicated  syy on syy.manage_id= man.manage_id and iou.iou_id =syy.iou_id
    left join fss_base_bank_branch bra on repitem.branch_id = bra.branch_id
    JOIN v_organ o ON man.company_id = o.bukrs
    JOIN (select
            r.*,
            enum.code
          from fss_accounting_rule r left join sec_enum enum on enum.id = r.commercian_unit_id
          where
            r.type = '1' and r.business_module = '外部借款' and r.business_type = '还款') as rr
      ON (case when exists(select 1  from fss_accounting_rule r where r.organ_id = man.company_id
                                                                     and r.type = '1' and r.business_module = '外部借款' and
                                                                     r.business_type = '还款')
      then rr.organ_id = man.company_id
          else rr.code = o.busi end) and (case when  man.loan_term_year &gt; '1' or man.loan_term_month &gt; '12' then (rr.loan_term != '一年以内') else  rr.loan_term != '一年以上'  end)
  where rep.repayment_id = #{subId} and  ((sto.stonr in ('10', '20', '30', '40', '50', '60', '70') and (rr.project_stage = '在建' or rr.project_stage = '' or rr.project_stage is null))
                    or ((sto.stonr = '80' or sto.stonr is null or pro.project_id is null or pro.project_id ='')
                    and (rr.project_stage = '运营' or rr.project_stage = '' or rr.project_stage is null))
                    or ((rr.project_stage = '' or rr.project_stage is null)))) as allTable
    </select>

    <delete id="delFssLoanAccountingDocuments">
       delete from fss_loan_accounting_documents  where sub_id=#{subId} and entry_status='未入账'  and entry_type=#{entryType}
    </delete>
</mapper>