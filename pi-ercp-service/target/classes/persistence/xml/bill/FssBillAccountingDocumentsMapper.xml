<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.personnel.ercp.pi.persistence.mapper.bill.FssBillAccountingDocumentsMapper">
  <resultMap id="BaseResultMap" type="cn.com.personnel.ercp.pi.persistence.entity.bill.FssBillAccountingDocuments">
    <!--
      WARNING - @mbg.generated
    -->
    <id column="documents_id" jdbcType="VARCHAR" property="documentsId" />
    <result column="fw_id" jdbcType="VARCHAR" property="fwId" />
    <result column="fc_id" jdbcType="VARCHAR" property="fcId" />
    <result column="rule_id" jdbcType="VARCHAR" property="ruleId" />
    <result column="contract_name" jdbcType="VARCHAR" property="contractName" />
    <result column="contract_num" jdbcType="VARCHAR" property="contractNum" />
    <result column="organ_id" jdbcType="VARCHAR" property="organId" />
    <result column="organ_name" jdbcType="VARCHAR" property="organName" />
    <result column="summary" jdbcType="VARCHAR" property="summary" />
    <result column="currency_code" jdbcType="VARCHAR" property="currencyCode" />
    <result column="currency" jdbcType="VARCHAR" property="currency" />
    <result column="credit_date" jdbcType="VARCHAR" property="creditDate" />
    <result column="commercian_unit_id" jdbcType="VARCHAR" property="commercianUnitId" />
    <result column="commercian_unit" jdbcType="VARCHAR" property="commercianUnit" />
    <result column="business_module_id" jdbcType="VARCHAR" property="businessModuleId" />
    <result column="business_module" jdbcType="VARCHAR" property="businessModule" />
    <result column="business_type" jdbcType="VARCHAR" property="businessType" />
    <result column="borrow_loan" jdbcType="VARCHAR" property="borrowLoan" />
    <result column="subject" jdbcType="VARCHAR" property="subject" />
    <result column="subject_text" jdbcType="VARCHAR" property="subjectText" />
    <result column="lifnr" jdbcType="VARCHAR" property="lifnr" />
    <result column="lifnr_text" jdbcType="VARCHAR" property="lifnrText" />
    <result column="loan_term" jdbcType="VARCHAR" property="loanTerm" />
    <result column="project_stage" jdbcType="VARCHAR" property="projectStage" />
    <result column="subject_type" jdbcType="VARCHAR" property="subjectType" />
    <result column="project_code" jdbcType="VARCHAR" property="projectCode" />
    <result column="project_name" jdbcType="VARCHAR" property="projectName" />
    <result column="profit_center_code" jdbcType="VARCHAR" property="profitCenterCode" />
    <result column="profit_center" jdbcType="VARCHAR" property="profitCenter" />
    <result column="cost_center_code" jdbcType="VARCHAR" property="costCenterCode" />
    <result column="cost_center" jdbcType="VARCHAR" property="costCenter" />
    <result column="wbs_element_code" jdbcType="VARCHAR" property="wbsElementCode" />
    <result column="wbs_element" jdbcType="VARCHAR" property="wbsElement" />
    <result column="reason_code" jdbcType="VARCHAR" property="reasonCode" />
    <result column="reason_code_text" jdbcType="VARCHAR" property="reasonCodeText" />
    <result column="assigned_number" jdbcType="VARCHAR" property="assignedNumber" />
    <result column="expiry_date" jdbcType="VARCHAR" property="expiryDate" />
    <result column="amount" jdbcType="NUMERIC" property="amount" />
    <result column="entry_status" jdbcType="VARCHAR" property="entryStatus" />
<!--    <result column="document_no" jdbcType="VARCHAR" property="documentNo" />-->
    <result column="message_number" jdbcType="VARCHAR" property="messageNumber" />
    <result column="internal_order" jdbcType="VARCHAR" property="internalOrder" />
    <result column="is_clear" jdbcType="VARCHAR" property="isClear" />
    <result column="type" jdbcType="VARCHAR" property="type" />
    <result column="remarks" jdbcType="VARCHAR" property="remarks" />
    <result column="status" jdbcType="VARCHAR" property="status" />
    <result column="reserve" jdbcType="VARCHAR" property="reserve" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="creator" jdbcType="VARCHAR" property="creator" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="updater" jdbcType="VARCHAR" property="updater" />
    <result column="deleted" jdbcType="VARCHAR" property="deleted" />
    <result column="business_type_list" jdbcType="VARCHAR" property="businessTypeList" />
    <result column="subject_type_list" jdbcType="VARCHAR" property="subjectTypeList" />
    <result column="entry_number" jdbcType="VARCHAR" property="entryNumber" />
    <result column="group_no" jdbcType="VARCHAR" property="groupNo" />
    <result column="entry_type" jdbcType="VARCHAR" property="entryType" />

    <result column="check_no" jdbcType="VARCHAR" property="checkNo" />
    <result column="bill_number" jdbcType="VARCHAR" property="billNumber" />
    <result column="payer_account" jdbcType="VARCHAR" property="payerAccount" />
    <result column="sub_id" jdbcType="VARCHAR" property="subId" />

    <result column="opposite_profit_center_code" jdbcType="VARCHAR" property="oppositeProfitCenterCode" />
    <result column="opposite_profit_center" jdbcType="VARCHAR" property="oppositeProfitCenter" />

    <result column="reversal_status" jdbcType="VARCHAR" property="reversalStatus" />
    <result column="error_message" jdbcType="VARCHAR" property="errorMessage" />
    <result column="sap_document_no" jdbcType="VARCHAR" property="sapDocumentNo" />

    <result column="reversal_sap_no" jdbcType="VARCHAR" property="reversalSapNo" />
    <result column="document_no" jdbcType="VARCHAR" property="documentNo" />
    <result column="i_guid" jdbcType="VARCHAR" property="iGuid" />
  </resultMap>


  <resultMap extends="BaseResultMap" id="BaseResultMapVO" type="cn.com.personnel.ercp.pi.module.bill.FssBillAccountingDocumentsVO">
    <result column="entry_status" jdbcType="VARCHAR" property="entryStatus" />
    <result column="reason_code_text" jdbcType="VARCHAR" property="reasonCodeText" />
    <result column="amount" jdbcType="NUMERIC" property="amount" />
    <result column="subject_text" jdbcType="VARCHAR" property="subjectText" />
    <result column="lifnr" jdbcType="VARCHAR" property="lifnr" />
    <result column="lifnr_text" jdbcType="VARCHAR" property="lifnrText" />
    <result column="fw_id" jdbcType="VARCHAR" property="fwId" />
    <result column="fc_id" jdbcType="VARCHAR" property="fcId" />
    <result column="assigned_number" jdbcType="VARCHAR" property="assignedNumber" />
    <result column="expiry_date" jdbcType="VARCHAR" property="expiryDate" />
  </resultMap>


    <update id="updateIGuid">
        update fss_bill_accounting_documents set i_guid = #{iGuid} where sub_id=#{subId} and document_no=#{documentNo}
    </update>

    <!-- 生成分录的数据票据金额大于0  或调拨单金额大于0-->
  <select id="queryBillAccountingRule" resultMap="BaseResultMapVO">

      -- 调试应付票据的分类信息
      select
      distinct
          '未入账'                                     as entry_status,
          ''                                        as cost_center,
          (select t053s.txt40
           from t053s
           where t053s.bukrs = rru.organ_id
             and t053s.rstgr = rru.reason_code) as reason_code_text,

          rru.subject_type,
          rru.*
      from (select
                ''::text            as cost_center_code,
                rule.subject,
                rule.subject_text,
                rule.profit_center_code,
                rule.profit_center,
                rule.opposite_profit_center_code,
                rule.opposite_profit_center,
                case
                    when (select skb1.mitkz
                          from skb1
                          where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                         ('D', 'K')
                        then case when rule.organ_id = rule.pay_company_id
                                      then rule.get_company_id
                                  when rule.organ_id = rule.get_company_id
                                      then rule.pay_company_id
                                  else '' end
                    else '' end   as lifnr,
                case
                    when (select skb1.mitkz
                          from skb1
                          where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                         ('D', 'K')
                        then case
                                 when rule.organ_id = rule.pay_company_id
                                     then rule.get_company
                                 when rule.organ_id = rule.get_company_id
                                     then rule.pay_company
                                 else '' end
                    else '' end   as lifnr_text,
                case
                    when rule.subject_type = '应付票据' or rule.subject_type = '应收票据'
                        then coalesce(rule.drawer_amount, 0)
                    when rule.subject_type = '应付账款' or rule.subject_type = '应收账款' or rule.subject_type = '中转科目'
                        then coalesce(rule.money_start, 0)
                    else 0 end    as amount,
                rule.rule_id,
                rule.commercian_unit_id,
                rule.commercian_unit,
                rule.business_module_id,
                rule.business_module,
                rule.business_type,
                rule.loan_term,
                rule.project_stage,
                rule.borrow_loan,
                rule.subject_type,
                rule.project_code,
                rule.project_name,
                rule.wbs_element_code,
                rule.wbs_element,
                rule.reason_code,
                rule.internal_order,
                rule.is_clear,
                rule.type,
                rule.remarks,
                rule.status,
                rule.reserve,
                rule.create_time,
                rule.creator,
                rule.update_time,
                rule.updater,
                rule.deleted,
                rule.business_type_list,
                rule.subject_type_list,
                rule.tran_type,
                rule.organ_id,
                rule.organ_name,
                rule.fw_id,
                rule.drawer_amount,
                rule.pay_company,
                rule.pay_company_id,
                rule.get_company,
                rule.get_company_id,
                rule.money_start,
                rule.sub_id,
                case when rule.subject_type = '应收票据' and (select skb1.mitkz
                                                          from skb1
                                                          where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) not in
                                                         ('D', 'K')
                         then rule.bill_number
                     when rule.business_type = '票据开承'
                         then concat('向', rule.get_company, '开立承兑')
                     when rule.business_type = '票据收承'
                         then concat('收到', rule.pay_company, '承兑')
                    end           as summary,
                rule.contract_repayment_date as expiry_date,
              /*  case
                    when  (select skb1.mitkz
                           from skb1
                           where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) not in
                          ('D', 'K') or rule.subject_type in('应收账款','应付账款')
                        then rule.contract_repayment_date
                    else null end as expiry_date,*/
                rule.credit_date,
                rule.currency,



                case when (select skb1.mitkz
                           from skb1
                           where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                          ('D', 'K') and subject_type='应付票据'
                         then rule.payer_account
                     else '' end          as payer_account,
                case when (select skb1.mitkz
                           from skb1
                           where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                          ('D', 'K') and subject_type='应付票据'
                         then rule.check_no
                     else '' end          as check_no,

                case when (select skb1.mitkz
                           from skb1
                           where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                          ('D', 'K') and subject_type='应付票据'
                         then rule.bill_number
                     else '' end          as bill_number
            from (SELECT
                      rr.subject,
                      case
                          when (rr.subject = '' or rr.subject is null)
                              then ''
                          else (select skat.txt50
                                from skat
                                         join t001 on t001.ktopl = skat.ktopl and skat.spras ='1'
                                where skat.saknr = rr.subject
                                  and t001.bukrs = fbi.company_id) end as subject_text,
                      case --这个是判断利润中心编码
                          when fbto.get_company_id = o.bukrs --内部借款对应公司名称是收款方的
                              then case when ((select count(0)
                                               from cepc_bukrs
                                               where bukrs = o.bukrs) is null or (select count(0)
                                                                                  from cepc_bukrs
                                                                                  where bukrs = o.bukrs) = 0 or (select count(0)
                                                                                                                 from cepc_bukrs
                                                                                                                 where
                                                                                                                     bukrs = o.bukrs) >
                                                                                                                1)
                              --这个是从项目中找
                                            then case when (fbi.prctr != '' and fbi.prctr is not null)
                                                          then fbi.prctr
                                                      else
                                                          -- 先从利润中心找
                                                          case when ((select ru.profit_center_code
                                                                      from fss_accounting_rule ru
                                                                      where ru.organ_id = o.bukrs and type = '2') is not null and
                                                              -- 在自己配置  费用科目中配置
                                                                     (select ru.profit_center_code
                                                                      from fss_accounting_rule ru
                                                                      where ru.organ_id = o.bukrs and type = '2') != '')
                                                                   then
                                                                   (select ru.profit_center_code
                                                                    from fss_accounting_rule ru
                                                                    where ru.organ_id = o.bukrs and type = '2')
                                                               else rr.profit_center_code end end
                              -- 查看会计规则中配置
                                        when (select count(0)
                                              from cepc_bukrs
                                              where bukrs = o.bukrs) = 1
                                            then (select cepct.prctr
                                                  from cepc_bukrs
                                                           join cepct on cepc_bukrs.prctr = cepct.prctr
                                                  where bukrs = o.bukrs) end
                          when fbto.pay_company_id = o.bukrs --内部借款对应公司名称是贷款方的
                              then case when ((select count(0)
                                               from cepc_bukrs
                                               where bukrs = o.bukrs) is null or (select count(0)
                                                                                  from cepc_bukrs
                                                                                  where bukrs = o.bukrs) = 0 or (select count(0)
                                                                                                                 from cepc_bukrs
                                                                                                                 where
                                                                                                                     bukrs = o.bukrs) >
                                                                                                                1)
                                            then case when (fbi.prctr != '' and fbi.prctr is not null)
                                                          then fbi.prctr
                                                      else case when ((select ru.profit_center_code
                                                                       from fss_accounting_rule ru
                                                                       where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                      (select ru.profit_center_code
                                                                       from fss_accounting_rule ru
                                                                       where ru.organ_id = o.bukrs and type = '2') != '')
                                                                    then
                                                                    (select ru.profit_center_code
                                                                     from fss_accounting_rule ru
                                                                     where ru.organ_id = o.bukrs and type = '2')
                                                                else rr.profit_center_code end end
                                        when (select count(0)
                                              from cepc_bukrs
                                              where bukrs = o.bukrs) = 1
                                            then (select cepct.prctr
                                                  from cepc_bukrs
                                                           join cepct on cepc_bukrs.prctr = cepct.prctr
                                                  where bukrs = o.bukrs) end
                          end                                              as profit_center_code,
                      case --这个是判断利润中心名称
                          when fbto.get_company_id = o.bukrs
                              then case when ((select count(0)
                                               from cepc_bukrs
                                               where bukrs = o.bukrs) is null or (select count(0)
                                                                                  from cepc_bukrs
                                                                                  where bukrs = o.bukrs) = 0 or (select count(0)
                                                                                                                 from cepc_bukrs
                                                                                                                 where
                                                                                                                     bukrs = o.bukrs) >
                                                                                                                1)
                                            then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                                                          then fbi.ltext
                                                      else
                                                          case when ((select ru.profit_center_code
                                                                      from fss_accounting_rule ru
                                                                      where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                     (select ru.profit_center_code
                                                                      from fss_accounting_rule ru
                                                                      where ru.organ_id = o.bukrs and type = '2') != '')
                                                                   then
                                                                   (select ru.profit_center_code
                                                                    from fss_accounting_rule ru
                                                                    where ru.organ_id = o.bukrs and type = '2')
                                                               else rr.profit_center end end
                                        when (select count(0)
                                              from cepc_bukrs
                                              where bukrs = o.bukrs) = 1
                                            then (select cepct.ltext
                                                  from cepc_bukrs
                                                           join cepct on cepc_bukrs.prctr = cepct.prctr
                                                  where bukrs = o.bukrs) end
                          when fbto.pay_company_id = o.bukrs
                              then case when ((select count(0)
                                               from cepc_bukrs
                                               where bukrs = o.bukrs) is null or (select count(0)
                                                                                  from cepc_bukrs
                                                                                  where bukrs = o.bukrs) = 0 or (select count(0)
                                                                                                                 from cepc_bukrs
                                                                                                                 where
                                                                                                                     bukrs = o.bukrs) >
                                                                                                                1)
                                            then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                                                          then fbi.ltext
                                                      else case when ((select ru.profit_center_code
                                                                       from fss_accounting_rule ru
                                                                       where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                      (select ru.profit_center_code
                                                                       from fss_accounting_rule ru
                                                                       where ru.organ_id = o.bukrs and type = '2') != '')
                                                                    then
                                                                    (select ru.profit_center_code
                                                                     from fss_accounting_rule ru
                                                                     where ru.organ_id = o.bukrs and type = '2')
                                                                else rr.profit_center end end
                                        when (select count(0)
                                              from cepc_bukrs
                                              where bukrs = o.bukrs) = 1
                                            then (select cepct.ltext
                                                  from cepc_bukrs
                                                           join cepct on cepc_bukrs.prctr = cepct.prctr
                                                  where bukrs = o.bukrs) end
                          end                                              as profit_center,
                      -- 这个是判断对方利润中心编码
                      case -- get_company_id 提款方  lender_company_id贷款方
                      -- 当提款方的公司id和公司id一致的情况下程序去判断对方的利润中心
                          when fbto.get_company_id = o.bukrs
                              then (select case
                                               when fbto.get_company_id = o.bukrs
                                                   then case when ((select count(0)
                                                                    from cepc_bukrs
                                                                    where bukrs = o.bukrs) is null or (select count(0)
                                                                                                       from cepc_bukrs
                                                                                                       where bukrs = o.bukrs) = 0 or
                                                                   (select count(0)
                                                                    from cepc_bukrs
                                                                    where bukrs = o.bukrs) > 1)
                                                                 then case when (fbi.prctr != '' and fbi.prctr is not null and o.busi!='6000')
                                                                               then fbi.prctr
                                                                           when ((select ru.profit_center_code
                                                                                  from fss_accounting_rule ru
                                                                                  where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                 (select ru.profit_center_code
                                                                                  from fss_accounting_rule ru
                                                                                  where ru.organ_id = o.bukrs and type = '2') != '')
                                                                               then
                                                                               (select ru.profit_center_code
                                                                                from fss_accounting_rule ru
                                                                                where ru.organ_id = o.bukrs and type = '2')
                                                                           else rr.profit_center_code end
                                                             when (select count(0)
                                                                   from cepc_bukrs
                                                                   where bukrs = o.bukrs) = 1
                                                                 then (select cepct.prctr
                                                                       from cepc_bukrs
                                                                                join cepct on cepc_bukrs.prctr = cepct.prctr
                                                                       where bukrs = o.bukrs) end
                                               when fbto.pay_company_id = o.bukrs
                                                   then case when ((select count(0)
                                                                    from cepc_bukrs
                                                                    where bukrs = o.bukrs) is null or (select count(0)
                                                                                                       from cepc_bukrs
                                                                                                       where bukrs = o.bukrs) = 0 or
                                                                   (select count(0)
                                                                    from cepc_bukrs
                                                                    where bukrs = o.bukrs) > 1)
                                                                 then case when (fbi.prctr != '' and fbi.prctr is not null and o.busi!='6000')
                                                                               then fbi.prctr
                                                                           when ((select ru.profit_center_code
                                                                                  from fss_accounting_rule ru
                                                                                  where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                 (select ru.profit_center_code
                                                                                  from fss_accounting_rule ru
                                                                                  where ru.organ_id = o.bukrs and type = '2') != '')
                                                                               then (select ru.profit_center_code
                                                                                     from fss_accounting_rule ru
                                                                                     where ru.organ_id = o.bukrs and type = '2')
                                                                           else rr.profit_center_code end
                                                             when (select count(0)
                                                                   from cepc_bukrs
                                                                   where bukrs = o.bukrs) = 1
                                                                 then (select cepct.prctr
                                                                       from cepc_bukrs
                                                                                join cepct on cepc_bukrs.prctr = cepct.prctr
                                                                       where bukrs = o.bukrs) end
                                               end as profit_center_code
                                    FROM fss_bill_info fbi
                                             join fss_bill_transfer_order_connect fbtoc5 on fbi.bill_id=fbtoc5.bill_id
                                             join fss_bill_transfer_order fbto
                                                  on fbtoc5.transfer_id = fbto.transfer_id
                                             JOIN v_organ o ON (fbto.get_company_id = o.bukrs or fbto.pay_company_id = o.bukrs)
                                             JOIN (select
                                                       r.*,
                                                       enum.code
                                                   from fss_accounting_rule r
                                                            left join sec_enum enum on enum.id = r.commercian_unit_id
                                                   where r.type = '1' and r.business_module = '应付票据' and
                                                       r.business_type in ('票据开承', '票据收承')) as rr
                                                  ON (((rr.organ_id is not null and rr.organ_id != '') and o.bukrs = rr.organ_id) or
                                                      ((rr.organ_id is null or rr.organ_id = '') and o.busi = rr.code))
                                    WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId}
                                      and o.bukrs = fbto.pay_company_id
                                    limit 1)
                          -- 当贷款方的公司id和公司id一致的情况下程序去判断对方的利润中心
                          when fbto.pay_company_id = o.bukrs
                              then (select case
                                               when fbto.get_company_id = o.bukrs
                                                   then case when ((select count(0)
                                                                    from cepc_bukrs
                                                                    where bukrs = o.bukrs) is null or (select count(0)
                                                                                                       from cepc_bukrs
                                                                                                       where bukrs = o.bukrs) = 0 or
                                                                   (select count(0)
                                                                    from cepc_bukrs
                                                                    where bukrs = o.bukrs) > 1)
                                                                 then case when (fbi.prctr != '' and fbi.prctr is not null and o.busi!='6000')
                                                                               then fbi.prctr
                                                                           when ((select ru.profit_center_code
                                                                                  from fss_accounting_rule ru
                                                                                  where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                 (select ru.profit_center_code
                                                                                  from fss_accounting_rule ru
                                                                                  where ru.organ_id = o.bukrs and type = '2') != '')
                                                                               then
                                                                               (select ru.profit_center_code
                                                                                from fss_accounting_rule ru
                                                                                where ru.organ_id = o.bukrs and type = '2')
                                                                           else rr.profit_center_code end
                                                             when (select count(0)
                                                                   from cepc_bukrs
                                                                   where bukrs = o.bukrs) = 1
                                                                 then (select cepct.prctr
                                                                       from cepc_bukrs
                                                                                join cepct on cepc_bukrs.prctr = cepct.prctr
                                                                       where bukrs = o.bukrs) end
                                               when fbto.pay_company_id = o.bukrs
                                                   then case when ((select count(0)
                                                                    from cepc_bukrs
                                                                    where bukrs = o.bukrs) is null or (select count(0)
                                                                                                       from cepc_bukrs
                                                                                                       where bukrs = o.bukrs) = 0 or
                                                                   (select count(0)
                                                                    from cepc_bukrs
                                                                    where bukrs = o.bukrs) > 1)
                                                                 then case when (fbi.prctr != '' and fbi.prctr is not null)
                                                                               then fbi.prctr
                                                                           when ((select ru.profit_center_code
                                                                                  from fss_accounting_rule ru
                                                                                  where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                 (select ru.profit_center_code
                                                                                  from fss_accounting_rule ru
                                                                                  where ru.organ_id = o.bukrs and type = '2') != '')
                                                                               then
                                                                               (select ru.profit_center_code
                                                                                from fss_accounting_rule ru
                                                                                where ru.organ_id = o.bukrs and type = '2')
                                                                           else rr.profit_center_code end
                                                             when (select count(0)
                                                                   from cepc_bukrs
                                                                   where bukrs = o.bukrs) = 1
                                                                 then (select cepct.prctr
                                                                       from cepc_bukrs
                                                                                join cepct on cepc_bukrs.prctr = cepct.prctr
                                                                       where bukrs = o.bukrs) end
                                               end as profit_center_code
                                    FROM fss_bill_info fbi
                                             join fss_bill_transfer_order_connect fbtoc4 on fbi.bill_id=fbtoc4.bill_id
                                             join fss_bill_transfer_order fbto
                                                  on fbtoc4.transfer_id = fbto.transfer_id
                                             JOIN v_organ o ON fbto.get_company_id = o.bukrs
                                             JOIN (select
                                                       r.*,
                                                       enum.code
                                                   from fss_accounting_rule r
                                                            left join sec_enum enum on enum.id = r.commercian_unit_id
                                                   where r.type = '1' and r.business_module = '应付票据' and
                                                       r.business_type in ('票据开承', '票据收承')) as rr
                                                  ON (((rr.organ_id is not null and rr.organ_id != '') and o.bukrs = rr.organ_id) or
                                                      ((rr.organ_id is null or rr.organ_id = '') and o.busi = rr.code))
                                    WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId}
                                      and o.bukrs = fbto.get_company_id
                                    limit 1)
                          end                                              as opposite_profit_center_code,

                      --这个是判断对方利润中心名称
                      case
                      when fbto.get_company_id = o.bukrs
                      then (select case
                      when fbto.get_company_id = o.bukrs
                      then case when ((select count(0)
                      from cepc_bukrs
                      where bukrs = o.bukrs) is null or (select count(0)
                      from cepc_bukrs
                      where bukrs = o.bukrs) = 0 or
                      (select count(0)
                      from cepc_bukrs
                      where bukrs = o.bukrs) > 1)
                      then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                      then fbi.ltext
                      when ((select ru.profit_center_code
                      from fss_accounting_rule ru
                      where ru.organ_id = o.bukrs and type = '2') is not null and
                      (select ru.profit_center_code
                      from fss_accounting_rule ru
                      where ru.organ_id = o.bukrs and type = '2') != '')
                      then
                      (select ru.profit_center_code
                      from fss_accounting_rule ru
                      where ru.organ_id = o.bukrs and type = '2')
                      else rr.profit_center end
                      when (select count(0)
                      from cepc_bukrs
                      where bukrs = o.bukrs) = 1
                      then (select cepct.ltext
                      from cepc_bukrs
                      join cepct on cepc_bukrs.prctr = cepct.prctr
                      where bukrs = o.bukrs) end
                      when fbto.pay_company_id = o.bukrs
                      then case when ((select count(0)
                      from cepc_bukrs
                      where bukrs = o.bukrs) is null or (select count(0)
                      from cepc_bukrs
                      where bukrs = o.bukrs) = 0 or
                      (select count(0)
                      from cepc_bukrs
                      where bukrs = o.bukrs) > 1)
                      then case when (fbi.ltext != '' and fbi.ltext is not null)
                      then fbi.ltext
                      when ((select ru.profit_center_code
                      from fss_accounting_rule ru
                      where ru.organ_id = o.bukrs and type = '2') is not null and
                      (select ru.profit_center_code
                      from fss_accounting_rule ru
                      where ru.organ_id = o.bukrs and type = '2') != '')
                      then
                      (select ru.profit_center_code
                      from fss_accounting_rule ru
                      where ru.organ_id = o.bukrs and type = '2')
                      else rr.profit_center end
                      when (select count(0)
                      from cepc_bukrs
                      where bukrs = o.bukrs) = 1
                      then (select cepct.ltext
                      from cepc_bukrs
                      join cepct on cepc_bukrs.prctr = cepct.prctr
                      where bukrs = o.bukrs) end
                      end as profit_center

                      FROM fss_bill_info fbi
                      join fss_bill_transfer_order_connect fbtoc3 on fbi.bill_id=fbtoc3.bill_id
                      join fss_bill_transfer_order fbto   on fbtoc3.transfer_id = fbto.transfer_id
                      JOIN v_organ o ON (fbto.get_company_id = o.bukrs or fbto.pay_company_id = o.bukrs)
                      JOIN (select
                      r.*,
                      enum.code
                      from fss_accounting_rule r
                      left join sec_enum enum on enum.id = r.commercian_unit_id
                      where r.type = '1') as rr
                      ON rr.business_module = '应付票据' AND
                      (rr.business_type = '票据开承' or rr.business_type = '票据收承') AND
                      (o.busi = rr.code OR fbto.company_name_id = rr.organ_id)
                      WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId}
                      and o.bukrs = fbto.pay_company_id
                      limit 1)
                      when fbto.pay_company_id = o.bukrs
                      then (select case when fbto.get_company_id = o.bukrs
                      then case when ((select count(0)
                      from cepc_bukrs
                      where bukrs = o.bukrs) is null or (select count(0)
                      from cepc_bukrs
                      where bukrs = o.bukrs) = 0 or (select count(0)
                      from cepc_bukrs
                      where
                      bukrs = o.bukrs)
                          > 1)
                      then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                      then fbi.ltext
                      when ((select ru.profit_center_code
                      from fss_accounting_rule ru
                      where ru.organ_id = o.bukrs and type = '2') is not null and
                      (select ru.profit_center_code
                      from fss_accounting_rule ru
                      where ru.organ_id = o.bukrs and type = '2') != '')
                      then
                      (select ru.profit_center_code
                      from fss_accounting_rule ru
                      where ru.organ_id = o.bukrs and type = '2')
                      else rr.profit_center end
                      when (select count(0)
                      from cepc_bukrs
                      where bukrs = o.bukrs) = 1
                      then (select cepct.ltext
                      from cepc_bukrs
                      join cepct on cepc_bukrs.prctr = cepct.prctr
                      where bukrs = o.bukrs) end
                      -- 判断对方利润中心名称  公司和付款公司一致的情况
                      when fbto.pay_company_id = o.bukrs
                      then case when ((select count(0)
                      from cepc_bukrs
                      where bukrs = o.bukrs) is null or (select count(0)
                      from cepc_bukrs
                      where bukrs = o.bukrs) = 0 or
                      (select count(0)
                      from cepc_bukrs
                      where bukrs = o.bukrs) > 1)
                      then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                      then fbi.ltext
                      when ((select ru.profit_center_code
                      from fss_accounting_rule ru
                      where ru.organ_id = o.bukrs and type = '2') is not null and
                      (select ru.profit_center_code
                      from fss_accounting_rule ru
                      where ru.organ_id = o.bukrs and type = '2') != '')
                      then
                      (select ru.profit_center_code
                      from fss_accounting_rule ru
                      where ru.organ_id = o.bukrs and type = '2')
                      else rr.profit_center end
                      when (select count(0)
                      from cepc_bukrs
                      where bukrs = o.bukrs) = 1
                      then (select cepct.ltext
                      from cepc_bukrs
                      join cepct on cepc_bukrs.prctr = cepct.prctr
                      where bukrs = o.bukrs) end
                      end as profit_center

                      FROM fss_bill_info fbi
                      join   fss_bill_transfer_order_connect fbtoc2 on fbi.bill_id =fbtoc2.bill_id
                      join fss_bill_transfer_order fbto    on fbtoc2.transfer_id = fbto.transfer_id
                      JOIN v_organ o ON (fbto.get_company_id = o.bukrs or fbto.pay_company_id = o.bukrs)
                      JOIN (select
                      r.*,
                      enum.code
                      from fss_accounting_rule r
                      left join sec_enum enum on enum.id = r.commercian_unit_id
                      where r.type = '1') as rr
                      ON rr.business_module = '应付票据' AND
                      (rr.business_type = '票据开承' or rr.business_type = '票据收承') AND
                      (o.busi = rr.code OR fbto.company_name_id = rr.organ_id)
                      WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId}
                      and o.bukrs = fbto.get_company_id
                      limit 1)
                      end                                              as opposite_profit_center,
                      rr.rule_id,
                      rr.commercian_unit_id,
                      rr.commercian_unit,
                      rr.business_module_id,
                      rr.business_module,
                      rr.business_type,
                      rr.loan_term,
                      rr.project_stage,
                      rr.borrow_loan,
                      rr.subject_type,
                      rr.project_code,
                      rr.project_name,
                      rr.cost_center_code,
                      rr.cost_center,
                      rr.wbs_element_code,
                      rr.wbs_element,
                      rr.reason_code,
                      rr.internal_order,
                      rr.is_clear,
                      rr.type,
                      rr.remarks,
                      rr.status,
                      fbi.bill_number,
                      rr.reserve,
                      rr.create_time,
                      rr.creator,
                      rr.update_time,
                      rr.updater,
                      rr.deleted,
                      rr.business_type_list,
                      rr.subject_type_list,
                      rr.tran_type,
                      o.bukrs                                          as organ_id,
                      o.full_name                                      as organ_name,
                      fbi.bill_id                                      as fw_id,
                      coalesce(fbi.drawer_amount, 0)                   as drawer_amount,
                      fbto.pay_company,
                      fbto.pay_company_id,
                      fbto.get_company,
                      fbto.get_company_id,
                      coalesce(fbto.money_small, 0)                    as money_start,
                      fbto.transfer_id                                 as sub_id,
                      case
                      when fbi.bill_class in ('纸质银行承兑汇票', '电子银行承兑汇票')
                      then '银行开承'
                      when fbi.bill_class in ('纸质商业承兑汇票', '电子商业承兑汇票')
                      then '商业开承' end                                as check_no,
                      fbi.payer_account                                   as payer_account,
                       case
                when rr.subject_type = '中转科目' then ''
                when  rr.subject_type = '应付票据' or rr.subject_type = '应收票据' then fbi.moneyorder_start::text
                else fbto.approval_time::text
                end  as contract_repayment_date,
                      fbto.approval_time                               as credit_date,
                      (select code from fss_base_currency where id=fbi.currency_id )as currency
                  FROM fss_bill_info fbi
                      left join fss_bill_transfer_order_connect fbtoc on fbi.bill_id = fbtoc.bill_id
                      join fss_bill_transfer_order fbto       on fbtoc.transfer_id = fbto.transfer_id
                      JOIN v_organ o ON (fbto.get_company_id = o.bukrs or fbto.pay_company_id = o.bukrs)
                      JOIN (select
                      r.*,
                      enum.code
                      from fss_accounting_rule r
                      left join sec_enum enum on enum.id = r.commercian_unit_id
                      where r.type = '1' and r.business_module = '应付票据' and r.business_type in ('票据开承', '票据收承')) as rr
                      ON (((rr.organ_id is not null and rr.organ_id != '') and o.bukrs = rr.organ_id) or
                      ((rr.organ_id is null or rr.organ_id = '') and o.busi = rr.code))
                  WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId} and ((rr.subject_type = '应付票据' and
                      ((fbi.bill_class in
                      ('纸质商业承兑汇票', '电子商业承兑汇票') and
                      rr.bill_form = '商业')
                      or (fbi.bill_class in
                      ('电子银行承兑汇票', '纸质银行承兑汇票') and
                      rr.bill_form = '银行'))
                      ) or rr.subject_type = '应收票据')
                      and ((fbto.get_company_id = o.bukrs and rr.business_type = '票据收承') or
                      (fbto.pay_company_id = o.bukrs and rr.business_type = '票据开承'))
                 ) as rule) as rru
      order by rru.business_type,rru.organ_name,rru.subject_type

  </select>
    <select id="queryBillAccountingRuleTwo"
            resultMap="BaseResultMapVO">
        select
        distinct
            '未入账'                                     as entry_status,
            ''                                        as cost_center,
            (select t053s.txt40
             from t053s
             where t053s.bukrs = rru.organ_id
               and t053s.rstgr = rru.reason_code) as reason_code_text,

            rru.subject_type,
            rru.*
        from (select
                  ''::text            as cost_center_code,
                  rule.subject,
                  rule.subject_text,
                  rule.profit_center_code,
                  rule.profit_center,
                  rule.opposite_profit_center_code,
                  rule.opposite_profit_center,
                  case
                      when (select skb1.mitkz
                            from skb1
                            where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                           ('D', 'K')
                          then case when rule.organ_id = rule.pay_company_id
                                        then rule.get_company_id
                                    when rule.organ_id = rule.get_company_id
                                        then rule.pay_company_id
                                    else '' end
                      else '' end   as lifnr,
                  case
                      when (select skb1.mitkz
                            from skb1
                            where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                           ('D', 'K')
                          then case
                                   when rule.organ_id = rule.pay_company_id
                                       then rule.get_company
                                   when rule.organ_id = rule.get_company_id
                                       then rule.pay_company
                                   else '' end
                      else '' end   as lifnr_text,
                  case
                      when rule.subject_type = '应付票据' or rule.subject_type = '应收票据'
                          then coalesce(rule.drawer_amount, 0)
                      when rule.subject_type = '应付账款' or rule.subject_type = '应收账款' or rule.subject_type = '中转科目'
                          then coalesce(rule.money_start, 0)
                      else 0 end    as amount,
                  rule.rule_id,
                  rule.commercian_unit_id,
                  rule.commercian_unit,
                  rule.business_module_id,
                  rule.business_module,
                  rule.business_type,
                  rule.loan_term,
                  rule.project_stage,
                  rule.borrow_loan,
                  rule.subject_type,
                  rule.project_code,
                  rule.project_name,
                  rule.wbs_element_code,
                  rule.wbs_element,
                  rule.reason_code,
                  rule.internal_order,
                  rule.is_clear,
                  rule.type,
                  rule.remarks,
                  rule.status,
                  rule.reserve,
                  rule.create_time,
                  rule.creator,
                  rule.update_time,
                  rule.updater,
                  rule.deleted,
                  rule.business_type_list,
                  rule.subject_type_list,
                  rule.tran_type,
                  rule.organ_id,
                  rule.organ_name,
                  rule.fw_id,
                  rule.drawer_amount,
                  rule.pay_company,
                  rule.pay_company_id,
                  rule.get_company,
                  rule.get_company_id,
                  rule.money_start,
                  rule.sub_id,
                  case when rule.subject_type = '应收票据' and (select skb1.mitkz
                                                            from skb1
                                                            where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) not in
                                                           ('D', 'K')
                           then rule.bill_number
                       when rule.business_type = '票据开承'
                           then concat('向', rule.get_company, '开立承兑')
                       when rule.business_type = '票据收承'
                           then concat('收到', rule.pay_company, '承兑')
                      end           as summary,
                 /* case
                      when  (select skb1.mitkz
                             from skb1
                             where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject) not in
                            ('D', 'K') or rule.subject_type in('应收账款','应付账款')
                          then rule.contract_repayment_date
                      else null end as expiry_date,*/
                  rule.contract_repayment_date as expiry_date,
                  rule.credit_date,
                  rule.currency,



                  case when (select skb1.mitkz
                             from skb1
                             where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                            ('D', 'K') and subject_type='应付票据'
                           then rule.payer_account
                       else '' end          as payer_account,
                  case when (select skb1.mitkz
                             from skb1
                             where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                            ('D', 'K') and subject_type='应付票据'
                           then rule.check_no
                       else '' end          as check_no,

                  case when (select skb1.mitkz
                             from skb1
                             where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                            ('D', 'K') and subject_type='应付票据'
                           then rule.bill_number
                       else '' end          as bill_number
              from (SELECT
                        rr.subject,
                        case
                            when (rr.subject = '' or rr.subject is null)
                                then ''
                            else (select skat.txt50
                                  from skat
                                           join t001 on t001.ktopl = skat.ktopl and skat.spras ='1'
                                  where skat.saknr = rr.subject
                                    and t001.bukrs = fbi.company_id) end as subject_text,
                        case --这个是判断利润中心编码
                            when fbto.get_company_id = o.bukrs --内部借款对应公司名称是收款方的
                                then case when ((select count(0)
                                                 from cepc_bukrs
                                                 where bukrs = o.bukrs) is null or (select count(0)
                                                                                    from cepc_bukrs
                                                                                    where bukrs = o.bukrs) = 0 or (select count(0)
                                                                                                                   from cepc_bukrs
                                                                                                                   where
                                                                                                                       bukrs = o.bukrs) >
                                                                                                                  1)
                                --这个是从项目中找
                                              then case when (fbi.prctr != '' and fbi.prctr is not null)
                                                            then fbi.prctr
                                                        else
                                                            -- 先从利润中心找
                                                            case when ((select ru.profit_center_code
                                                                        from fss_accounting_rule ru
                                                                        where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                -- 在自己配置  费用科目中配置
                                                                       (select ru.profit_center_code
                                                                        from fss_accounting_rule ru
                                                                        where ru.organ_id = o.bukrs and type = '2') != '')
                                                                     then
                                                                     (select ru.profit_center_code
                                                                      from fss_accounting_rule ru
                                                                      where ru.organ_id = o.bukrs and type = '2')
                                                                 else rr.profit_center_code end end
                                -- 查看会计规则中配置
                                          when (select count(0)
                                                from cepc_bukrs
                                                where bukrs = o.bukrs) = 1
                                              then (select cepct.prctr
                                                    from cepc_bukrs
                                                             join cepct on cepc_bukrs.prctr = cepct.prctr
                                                    where bukrs = o.bukrs) end
                            when fbto.pay_company_id = o.bukrs --内部借款对应公司名称是贷款方的
                                then case when ((select count(0)
                                                 from cepc_bukrs
                                                 where bukrs = o.bukrs) is null or (select count(0)
                                                                                    from cepc_bukrs
                                                                                    where bukrs = o.bukrs) = 0 or (select count(0)
                                                                                                                   from cepc_bukrs
                                                                                                                   where
                                                                                                                       bukrs = o.bukrs) >
                                                                                                                  1)
                                              then case when (fbi.prctr != '' and fbi.prctr is not null)
                                                            then fbi.prctr
                                                        else case when ((select ru.profit_center_code
                                                                         from fss_accounting_rule ru
                                                                         where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                        (select ru.profit_center_code
                                                                         from fss_accounting_rule ru
                                                                         where ru.organ_id = o.bukrs and type = '2') != '')
                                                                      then
                                                                      (select ru.profit_center_code
                                                                       from fss_accounting_rule ru
                                                                       where ru.organ_id = o.bukrs and type = '2')
                                                                  else rr.profit_center_code end end
                                          when (select count(0)
                                                from cepc_bukrs
                                                where bukrs = o.bukrs) = 1
                                              then (select cepct.prctr
                                                    from cepc_bukrs
                                                             join cepct on cepc_bukrs.prctr = cepct.prctr
                                                    where bukrs = o.bukrs) end
                            end                                              as profit_center_code,
                        case --这个是判断利润中心名称
                            when fbto.get_company_id = o.bukrs
                                then case when ((select count(0)
                                                 from cepc_bukrs
                                                 where bukrs = o.bukrs) is null or (select count(0)
                                                                                    from cepc_bukrs
                                                                                    where bukrs = o.bukrs) = 0 or (select count(0)
                                                                                                                   from cepc_bukrs
                                                                                                                   where
                                                                                                                       bukrs = o.bukrs) >
                                                                                                                  1)
                                              then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                                                            then fbi.ltext
                                                        else
                                                            case when ((select ru.profit_center_code
                                                                        from fss_accounting_rule ru
                                                                        where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                       (select ru.profit_center_code
                                                                        from fss_accounting_rule ru
                                                                        where ru.organ_id = o.bukrs and type = '2') != '')
                                                                     then
                                                                     (select ru.profit_center_code
                                                                      from fss_accounting_rule ru
                                                                      where ru.organ_id = o.bukrs and type = '2')
                                                                 else rr.profit_center end end
                                          when (select count(0)
                                                from cepc_bukrs
                                                where bukrs = o.bukrs) = 1
                                              then (select cepct.ltext
                                                    from cepc_bukrs
                                                             join cepct on cepc_bukrs.prctr = cepct.prctr
                                                    where bukrs = o.bukrs) end
                            when fbto.pay_company_id = o.bukrs
                                then case when ((select count(0)
                                                 from cepc_bukrs
                                                 where bukrs = o.bukrs) is null or (select count(0)
                                                                                    from cepc_bukrs
                                                                                    where bukrs = o.bukrs) = 0 or (select count(0)
                                                                                                                   from cepc_bukrs
                                                                                                                   where
                                                                                                                       bukrs = o.bukrs) >
                                                                                                                  1)
                                              then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                                                            then fbi.ltext
                                                        else case when ((select ru.profit_center_code
                                                                         from fss_accounting_rule ru
                                                                         where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                        (select ru.profit_center_code
                                                                         from fss_accounting_rule ru
                                                                         where ru.organ_id = o.bukrs and type = '2') != '')
                                                                      then
                                                                      (select ru.profit_center_code
                                                                       from fss_accounting_rule ru
                                                                       where ru.organ_id = o.bukrs and type = '2')
                                                                  else rr.profit_center end end
                                          when (select count(0)
                                                from cepc_bukrs
                                                where bukrs = o.bukrs) = 1
                                              then (select cepct.ltext
                                                    from cepc_bukrs
                                                             join cepct on cepc_bukrs.prctr = cepct.prctr
                                                    where bukrs = o.bukrs) end
                            end                                              as profit_center,
                        -- 这个是判断对方利润中心编码
                        case -- get_company_id 提款方  lender_company_id贷款方
                        -- 当提款方的公司id和公司id一致的情况下程序去判断对方的利润中心
                            when fbto.get_company_id = o.bukrs
                                then (select case
                                                 when fbto.get_company_id = o.bukrs
                                                     then case when ((select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) is null or (select count(0)
                                                                                                         from cepc_bukrs
                                                                                                         where bukrs = o.bukrs) = 0 or
                                                                     (select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) > 1)
                                                                   then case when (fbi.prctr != '' and fbi.prctr is not null and o.busi!='6000')
                                                                                 then fbi.prctr
                                                                             when ((select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                   (select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') != '')
                                                                                 then
                                                                                 (select ru.profit_center_code
                                                                                  from fss_accounting_rule ru
                                                                                  where ru.organ_id = o.bukrs and type = '2')
                                                                             else rr.profit_center_code end
                                                               when (select count(0)
                                                                     from cepc_bukrs
                                                                     where bukrs = o.bukrs) = 1
                                                                   then (select cepct.prctr
                                                                         from cepc_bukrs
                                                                                  join cepct on cepc_bukrs.prctr = cepct.prctr
                                                                         where bukrs = o.bukrs) end
                                                 when fbto.pay_company_id = o.bukrs
                                                     then case when ((select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) is null or (select count(0)
                                                                                                         from cepc_bukrs
                                                                                                         where bukrs = o.bukrs) = 0 or
                                                                     (select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) > 1)
                                                                   then case when (fbi.prctr != '' and fbi.prctr is not null and o.busi!='6000')
                                                                                 then fbi.prctr
                                                                             when ((select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                   (select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') != '')
                                                                                 then (select ru.profit_center_code
                                                                                       from fss_accounting_rule ru
                                                                                       where ru.organ_id = o.bukrs and type = '2')
                                                                             else rr.profit_center_code end
                                                               when (select count(0)
                                                                     from cepc_bukrs
                                                                     where bukrs = o.bukrs) = 1
                                                                   then (select cepct.prctr
                                                                         from cepc_bukrs
                                                                                  join cepct on cepc_bukrs.prctr = cepct.prctr
                                                                         where bukrs = o.bukrs) end
                                                 end as profit_center_code
                                      FROM fss_bill_info fbi
                                               join fss_bill_transfer_order_connect fbtoc5 on fbi.bill_id=fbtoc5.bill_id
                                               join fss_bill_transfer_order fbto
                                                    on fbtoc5.transfer_id = fbto.transfer_id
                                               JOIN v_organ o ON (fbto.get_company_id = o.bukrs or fbto.pay_company_id = o.bukrs)
                                               JOIN (select
                                                         r.*,
                                                         enum.code
                                                     from fss_accounting_rule r
                                                              left join sec_enum enum on enum.id = r.commercian_unit_id
                                                     where r.type = '1' and r.business_module = '应付票据' and
                                                         r.business_type in ('票据开承', '票据收承')) as rr
                                                    ON (((rr.organ_id is not null and rr.organ_id != '') and o.bukrs = rr.organ_id) or
                                                        ((rr.organ_id is null or rr.organ_id = '') and o.busi = rr.code))
                                      WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId}
                                        and o.bukrs = fbto.pay_company_id
                                      limit 1)
                            -- 当贷款方的公司id和公司id一致的情况下程序去判断对方的利润中心
                            when fbto.pay_company_id = o.bukrs
                                then (select case
                                                 when fbto.get_company_id = o.bukrs
                                                     then case when ((select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) is null or (select count(0)
                                                                                                         from cepc_bukrs
                                                                                                         where bukrs = o.bukrs) = 0 or
                                                                     (select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) > 1)
                                                                   then case when (fbi.prctr != '' and fbi.prctr is not null and o.busi!='6000')
                                                                                 then fbi.prctr
                                                                             when ((select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                   (select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') != '')
                                                                                 then
                                                                                 (select ru.profit_center_code
                                                                                  from fss_accounting_rule ru
                                                                                  where ru.organ_id = o.bukrs and type = '2')
                                                                             else rr.profit_center_code end
                                                               when (select count(0)
                                                                     from cepc_bukrs
                                                                     where bukrs = o.bukrs) = 1
                                                                   then (select cepct.prctr
                                                                         from cepc_bukrs
                                                                                  join cepct on cepc_bukrs.prctr = cepct.prctr
                                                                         where bukrs = o.bukrs) end
                                                 when fbto.pay_company_id = o.bukrs
                                                     then case when ((select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) is null or (select count(0)
                                                                                                         from cepc_bukrs
                                                                                                         where bukrs = o.bukrs) = 0 or
                                                                     (select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) > 1)
                                                                   then case when (fbi.prctr != '' and fbi.prctr is not null)
                                                                                 then fbi.prctr
                                                                             when ((select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                   (select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') != '')
                                                                                 then
                                                                                 (select ru.profit_center_code
                                                                                  from fss_accounting_rule ru
                                                                                  where ru.organ_id = o.bukrs and type = '2')
                                                                             else rr.profit_center_code end
                                                               when (select count(0)
                                                                     from cepc_bukrs
                                                                     where bukrs = o.bukrs) = 1
                                                                   then (select cepct.prctr
                                                                         from cepc_bukrs
                                                                                  join cepct on cepc_bukrs.prctr = cepct.prctr
                                                                         where bukrs = o.bukrs) end
                                                 end as profit_center_code
                                      FROM fss_bill_info fbi
                                               join fss_bill_transfer_order_connect fbtoc4 on fbi.bill_id=fbtoc4.bill_id
                                               join fss_bill_transfer_order fbto
                                                    on fbtoc4.transfer_id = fbto.transfer_id
                                               JOIN v_organ o ON fbto.get_company_id = o.bukrs
                                               JOIN (select
                                                         r.*,
                                                         enum.code
                                                     from fss_accounting_rule r
                                                              left join sec_enum enum on enum.id = r.commercian_unit_id
                                                     where r.type = '1' and r.business_module = '应付票据' and
                                                         r.business_type in ('票据开承', '票据收承')) as rr
                                                    ON (((rr.organ_id is not null and rr.organ_id != '') and o.bukrs = rr.organ_id) or
                                                        ((rr.organ_id is null or rr.organ_id = '') and o.busi = rr.code))
                                      WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId}
                                        and o.bukrs = fbto.get_company_id
                                      limit 1)
                            end                                              as opposite_profit_center_code,

                        --这个是判断对方利润中心名称
                        case
                        when fbto.get_company_id = o.bukrs
                        then (select case
                        when fbto.get_company_id = o.bukrs
                        then case when ((select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) is null or (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 0 or
                        (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) > 1)
                        then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                        then fbi.ltext
                        when ((select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') is not null and
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') != '')
                        then
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2')
                        else rr.profit_center end
                        when (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 1
                        then (select cepct.ltext
                        from cepc_bukrs
                        join cepct on cepc_bukrs.prctr = cepct.prctr
                        where bukrs = o.bukrs) end
                        when fbto.pay_company_id = o.bukrs
                        then case when ((select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) is null or (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 0 or
                        (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) > 1)
                        then case when (fbi.ltext != '' and fbi.ltext is not null)
                        then fbi.ltext
                        when ((select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') is not null and
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') != '')
                        then
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2')
                        else rr.profit_center end
                        when (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 1
                        then (select cepct.ltext
                        from cepc_bukrs
                        join cepct on cepc_bukrs.prctr = cepct.prctr
                        where bukrs = o.bukrs) end
                        end as profit_center

                        FROM fss_bill_info fbi
                        join fss_bill_transfer_order_connect fbtoc3 on fbi.bill_id=fbtoc3.bill_id
                        join fss_bill_transfer_order fbto   on fbtoc3.transfer_id = fbto.transfer_id
                        JOIN v_organ o ON (fbto.get_company_id = o.bukrs or fbto.pay_company_id = o.bukrs)
                        JOIN (select
                        r.*,
                        enum.code
                        from fss_accounting_rule r
                        left join sec_enum enum on enum.id = r.commercian_unit_id
                        where r.type = '1') as rr
                        ON rr.business_module = '应付票据' AND
                        (rr.business_type = '票据开承' or rr.business_type = '票据收承') AND
                        (o.busi = rr.code OR fbto.company_name_id = rr.organ_id)
                        WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId}
                        and o.bukrs = fbto.pay_company_id
                        limit 1)
                        when fbto.pay_company_id = o.bukrs
                        then (select case when fbto.get_company_id = o.bukrs
                        then case when ((select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) is null or (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 0 or (select count(0)
                        from cepc_bukrs
                        where
                        bukrs = o.bukrs)
                            > 1)
                        then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                        then fbi.ltext
                        when ((select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') is not null and
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') != '')
                        then
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2')
                        else rr.profit_center end
                        when (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 1
                        then (select cepct.ltext
                        from cepc_bukrs
                        join cepct on cepc_bukrs.prctr = cepct.prctr
                        where bukrs = o.bukrs) end
                        -- 判断对方利润中心名称  公司和付款公司一致的情况
                        when fbto.pay_company_id = o.bukrs
                        then case when ((select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) is null or (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 0 or
                        (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) > 1)
                        then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                        then fbi.ltext
                        when ((select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') is not null and
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') != '')
                        then
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2')
                        else rr.profit_center end
                        when (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 1
                        then (select cepct.ltext
                        from cepc_bukrs
                        join cepct on cepc_bukrs.prctr = cepct.prctr
                        where bukrs = o.bukrs) end
                        end as profit_center

                        FROM fss_bill_info fbi
                        join   fss_bill_transfer_order_connect fbtoc2 on fbi.bill_id =fbtoc2.bill_id
                        join fss_bill_transfer_order fbto    on fbtoc2.transfer_id = fbto.transfer_id
                        JOIN v_organ o ON (fbto.get_company_id = o.bukrs or fbto.pay_company_id = o.bukrs)
                        JOIN (select
                        r.*,
                        enum.code
                        from fss_accounting_rule r
                        left join sec_enum enum on enum.id = r.commercian_unit_id
                        where r.type = '1') as rr
                        ON rr.business_module = '应付票据' AND
                        (rr.business_type = '票据开承' or rr.business_type = '票据收承') AND
                        (o.busi = rr.code OR fbto.company_name_id = rr.organ_id)
                        WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId}
                        and o.bukrs = fbto.get_company_id
                        limit 1)
                        end                                              as opposite_profit_center,
                        rr.rule_id,
                        rr.commercian_unit_id,
                        rr.commercian_unit,
                        rr.business_module_id,
                        rr.business_module,
                        rr.business_type,
                        rr.loan_term,
                        rr.project_stage,
                        rr.borrow_loan,
                        rr.subject_type,
                        rr.project_code,
                        rr.project_name,
                        rr.cost_center_code,
                        rr.cost_center,
                        rr.wbs_element_code,
                        rr.wbs_element,
                        rr.reason_code,
                        rr.internal_order,
                        rr.is_clear,
                        rr.type,
                        rr.remarks,
                        rr.status,
                        fbi.bill_number,
                        rr.reserve,
                        rr.create_time,
                        rr.creator,
                        rr.update_time,
                        rr.updater,
                        rr.deleted,
                        rr.business_type_list,
                        rr.subject_type_list,
                        rr.tran_type,
                        o.bukrs                                          as organ_id,
                        o.full_name                                      as organ_name,
                        fbi.bill_id                                      as fw_id,
                        coalesce(fbi.drawer_amount, 0)                   as drawer_amount,
                        fbto.pay_company,
                        fbto.pay_company_id,
                        fbto.get_company,
                        fbto.get_company_id,
                        coalesce(fbto.money_small, 0)                    as money_start,
                        fbto.transfer_id                                 as sub_id,
                        case
                        when fbi.bill_class in ('纸质银行承兑汇票', '电子银行承兑汇票')
                        then '银行开承'
                        when fbi.bill_class in ('纸质商业承兑汇票', '电子商业承兑汇票')
                        then '商业开承' end                                as check_no,
                        fbi.payer_account                                   as payer_account,
                         case
                when rr.subject_type = '中转科目' then ''
                when  rr.subject_type = '应付票据' or rr.subject_type = '应收票据' then fbi.moneyorder_start::text
                else fbto.approval_time::text
                end  as contract_repayment_date,
                        fbto.approval_time                               as credit_date,
                        (select code from fss_base_currency where id=fbi.currency_id )as currency
                    from fss_bill_transfer_order fbto
                        left join fss_bill_transfer_order_connect fbtoc on fbtoc.transfer_id = fbto.transfer_id
                        join  (select fbi2.*,fbtoc6.transfer_id from fss_bill_info fbi2 left join fss_bill_transfer_order_connect fbtoc6 on fbi2.bill_id=fbtoc6.bill_id
                        where fbtoc6.transfer_id=#{fssBillAccountingDocuments.subId} limit 1 )  as fbi on fbi.bill_id = fbtoc.bill_id
                        JOIN v_organ o ON (fbto.get_company_id = o.bukrs or fbto.pay_company_id = o.bukrs)
                        JOIN (select
                        r.*,
                        enum.code
                        from fss_accounting_rule r
                        left join sec_enum enum on enum.id = r.commercian_unit_id
                        where r.type = '1' and r.business_module = '应付票据' and r.business_type in ('票据开承', '票据收承')) as rr
                        ON (((rr.organ_id is not null and rr.organ_id != '') and o.bukrs = rr.organ_id) or
                        ((rr.organ_id is null or rr.organ_id = '') and o.busi = rr.code))
                    WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId} and rr.subject_type in ('应付账款','中转科目','应收账款')
                        and ((fbto.get_company_id = o.bukrs and rr.business_type = '票据收承') or
                        (fbto.pay_company_id = o.bukrs and rr.business_type = '票据开承'))
                   ) as rule) as rru
        order by  rru.business_type,rru.organ_name,rru.subject_type
    </select>
<!--    #{fssBillAccountingDocuments.subId}-->

    <select id="queryBillAccountingRuleCacel"  resultMap="BaseResultMapVO">
        select
            '未入账'                                     as entry_status,
            ''                                        as cost_center,
            (select t053s.txt40
             from t053s
             where t053s.bukrs = rru.organ_id
               and t053s.rstgr = rru.reason_code) as reason_code_text,

            rru.subject_type,
            rru.*
        from (select
                  ''            as cost_center_code,
                  rule.subject,
                  rule.subject_text,
                  rule.profit_center_code,
                  rule.profit_center,
                  rule.opposite_profit_center_code,
                  rule.opposite_profit_center,
                  case
                      when (select skb1.mitkz
                            from skb1
                            where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                           ('D', 'K')
                          then case when rule.organ_id = rule.pay_company_id
                                        then rule.get_company_id
                                    when rule.organ_id = rule.get_company_id
                                        then rule.pay_company_id
                                    else '' end
                      else '' end   as lifnr,
                  case
                      when (select skb1.mitkz
                            from skb1
                            where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                           ('D', 'K')
                          then case
                                   when rule.organ_id = rule.pay_company_id
                                       then rule.get_company
                                   when rule.organ_id = rule.get_company_id
                                       then rule.pay_company
                                   else '' end
                      else '' end   as lifnr_text,
                  case
                      when rule.subject_type = '应付票据' or rule.subject_type = '应收票据'
                          then coalesce(rule.drawer_amount, 0)
                      when rule.subject_type = '应付账款' or rule.subject_type = '应收账款' or rule.subject_type = '中转科目'
                          then coalesce(rule.money_start, 0)
                      else 0 end    as amount,
                  rule.rule_id,
                  rule.commercian_unit_id,
                  rule.commercian_unit,
                  rule.business_module_id,
                  rule.business_module,
                  rule.business_type,
                  rule.loan_term,
                  rule.project_stage,
                  rule.borrow_loan,
                  rule.subject_type,
                  rule.project_code,
                  rule.project_name,
                  rule.wbs_element_code,
                  rule.wbs_element,
                  rule.reason_code,
                  rule.internal_order,
                  rule.is_clear,
                  rule.type,
                  rule.remarks,
                  rule.status,
                  rule.reserve,
                  rule.create_time,
                  rule.creator,
                  rule.update_time,
                  rule.updater,
                  rule.deleted,
                  rule.business_type_list,
                  rule.subject_type_list,
                  rule.tran_type,
                  rule.organ_id,
                  rule.organ_name,
                  rule.fw_id,
                  rule.drawer_amount,
                  rule.pay_company,
                  rule.pay_company_id,
                  rule.get_company,
                  rule.get_company_id,
                  rule.money_start,
                  rule.sub_id,
                  case when rule.subject_type = '应收票据' and (select skb1.mitkz
                                                            from skb1
                                                            where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) not in
                                                           ('D', 'K')
                           then rule.bill_number
                       when rule.business_type = '取消票据开承'
                           then concat('向', rule.get_company, '开立承兑')
                       when rule.business_type = '取消票据收承'
                           then concat('收到', rule.pay_company, '承兑')
                      end           as summary,
                 /* case
                      when  (select skb1.mitkz
                             from skb1
                             where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject) not in
                            ('D', 'K') or rule.subject_type in('应收账款','应付账款')
                          then rule.contract_repayment_date
                      else null end as expiry_date,*/
                  rule.contract_repayment_date as expiry_date,
                  rule.credit_date,
                  rule.currency,



                  case when (select skb1.mitkz
                             from skb1
                             where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                            ('D', 'K') and subject_type='应付票据'
                           then rule.payer_account
                       else '' end          as payer_account,
                  case when (select skb1.mitkz
                             from skb1
                             where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                            ('D', 'K') and subject_type='应付票据'
                           then rule.check_no
                       else '' end          as check_no,

                  case when (select skb1.mitkz
                             from skb1
                             where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                            ('D', 'K') and subject_type='应付票据'
                           then rule.bill_number
                       else '' end          as bill_number
              from (SELECT
                        rr.subject,
                        case
                            when (rr.subject = '' or rr.subject is null)
                                then ''
                            else (select skat.txt50
                                  from skat
                                           join t001 on t001.ktopl = skat.ktopl and skat.spras ='1'
                                  where skat.saknr = rr.subject
                                    and t001.bukrs = fbi.company_id) end as subject_text,
                        case --这个是判断利润中心编码
                            when fbto.get_company_id = o.bukrs --内部借款对应公司名称是收款方的
                                then case when ((select count(0)
                                                 from cepc_bukrs
                                                 where bukrs = o.bukrs) is null or (select count(0)
                                                                                    from cepc_bukrs
                                                                                    where bukrs = o.bukrs) = 0 or (select count(0)
                                                                                                                   from cepc_bukrs
                                                                                                                   where
                                                                                                                       bukrs = o.bukrs) >
                                                                                                                  1)
                                --这个是从项目中找
                                              then case when (fbi.prctr != '' and fbi.prctr is not null)
                                                            then fbi.prctr
                                                        else
                                                            -- 先从利润中心找
                                                            case when ((select ru.profit_center_code
                                                                        from fss_accounting_rule ru
                                                                        where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                -- 在自己配置  费用科目中配置
                                                                       (select ru.profit_center_code
                                                                        from fss_accounting_rule ru
                                                                        where ru.organ_id = o.bukrs and type = '2') != '')
                                                                     then
                                                                     (select ru.profit_center_code
                                                                      from fss_accounting_rule ru
                                                                      where ru.organ_id = o.bukrs and type = '2')
                                                                 else rr.profit_center_code end end
                                -- 查看会计规则中配置
                                          when (select count(0)
                                                from cepc_bukrs
                                                where bukrs = o.bukrs) = 1
                                              then (select cepct.prctr
                                                    from cepc_bukrs
                                                             join cepct on cepc_bukrs.prctr = cepct.prctr
                                                    where bukrs = o.bukrs) end
                            when fbto.pay_company_id = o.bukrs --内部借款对应公司名称是贷款方的
                                then case when ((select count(0)
                                                 from cepc_bukrs
                                                 where bukrs = o.bukrs) is null or (select count(0)
                                                                                    from cepc_bukrs
                                                                                    where bukrs = o.bukrs) = 0 or (select count(0)
                                                                                                                   from cepc_bukrs
                                                                                                                   where
                                                                                                                       bukrs = o.bukrs) >
                                                                                                                  1)
                                              then case when (fbi.prctr != '' and fbi.prctr is not null)
                                                            then fbi.prctr
                                                        else case when ((select ru.profit_center_code
                                                                         from fss_accounting_rule ru
                                                                         where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                        (select ru.profit_center_code
                                                                         from fss_accounting_rule ru
                                                                         where ru.organ_id = o.bukrs and type = '2') != '')
                                                                      then
                                                                      (select ru.profit_center_code
                                                                       from fss_accounting_rule ru
                                                                       where ru.organ_id = o.bukrs and type = '2')
                                                                  else rr.profit_center_code end end
                                          when (select count(0)
                                                from cepc_bukrs
                                                where bukrs = o.bukrs) = 1
                                              then (select cepct.prctr
                                                    from cepc_bukrs
                                                             join cepct on cepc_bukrs.prctr = cepct.prctr
                                                    where bukrs = o.bukrs) end
                            end                                              as profit_center_code,
                        case --这个是判断利润中心名称
                            when fbto.get_company_id = o.bukrs
                                then case when ((select count(0)
                                                 from cepc_bukrs
                                                 where bukrs = o.bukrs) is null or (select count(0)
                                                                                    from cepc_bukrs
                                                                                    where bukrs = o.bukrs) = 0 or (select count(0)
                                                                                                                   from cepc_bukrs
                                                                                                                   where
                                                                                                                       bukrs = o.bukrs) >
                                                                                                                  1)
                                              then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                                                            then fbi.ltext
                                                        else
                                                            case when ((select ru.profit_center_code
                                                                        from fss_accounting_rule ru
                                                                        where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                       (select ru.profit_center_code
                                                                        from fss_accounting_rule ru
                                                                        where ru.organ_id = o.bukrs and type = '2') != '')
                                                                     then
                                                                     (select ru.profit_center_code
                                                                      from fss_accounting_rule ru
                                                                      where ru.organ_id = o.bukrs and type = '2')
                                                                 else rr.profit_center end end
                                          when (select count(0)
                                                from cepc_bukrs
                                                where bukrs = o.bukrs) = 1
                                              then (select cepct.ltext
                                                    from cepc_bukrs
                                                             join cepct on cepc_bukrs.prctr = cepct.prctr
                                                    where bukrs = o.bukrs) end
                            when fbto.pay_company_id = o.bukrs
                                then case when ((select count(0)
                                                 from cepc_bukrs
                                                 where bukrs = o.bukrs) is null or (select count(0)
                                                                                    from cepc_bukrs
                                                                                    where bukrs = o.bukrs) = 0 or (select count(0)
                                                                                                                   from cepc_bukrs
                                                                                                                   where
                                                                                                                       bukrs = o.bukrs) >
                                                                                                                  1)
                                              then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                                                            then fbi.ltext
                                                        else case when ((select ru.profit_center_code
                                                                         from fss_accounting_rule ru
                                                                         where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                        (select ru.profit_center_code
                                                                         from fss_accounting_rule ru
                                                                         where ru.organ_id = o.bukrs and type = '2') != '')
                                                                      then
                                                                      (select ru.profit_center_code
                                                                       from fss_accounting_rule ru
                                                                       where ru.organ_id = o.bukrs and type = '2')
                                                                  else rr.profit_center end end
                                          when (select count(0)
                                                from cepc_bukrs
                                                where bukrs = o.bukrs) = 1
                                              then (select cepct.ltext
                                                    from cepc_bukrs
                                                             join cepct on cepc_bukrs.prctr = cepct.prctr
                                                    where bukrs = o.bukrs) end
                            end                                              as profit_center,
                        -- 这个是判断对方利润中心编码
                        case -- get_company_id 提款方  lender_company_id贷款方
                        -- 当提款方的公司id和公司id一致的情况下程序去判断对方的利润中心
                            when fbto.get_company_id = o.bukrs
                                then (select case
                                                 when fbto.get_company_id = o.bukrs
                                                     then case when ((select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) is null or (select count(0)
                                                                                                         from cepc_bukrs
                                                                                                         where bukrs = o.bukrs) = 0 or
                                                                     (select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) > 1)
                                                                   then case when (fbi.prctr != '' and fbi.prctr is not null and o.busi!='6000')
                                                                                 then fbi.prctr
                                                                             when ((select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                   (select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') != '')
                                                                                 then
                                                                                 (select ru.profit_center_code
                                                                                  from fss_accounting_rule ru
                                                                                  where ru.organ_id = o.bukrs and type = '2')
                                                                             else rr.profit_center_code end
                                                               when (select count(0)
                                                                     from cepc_bukrs
                                                                     where bukrs = o.bukrs) = 1
                                                                   then (select cepct.prctr
                                                                         from cepc_bukrs
                                                                                  join cepct on cepc_bukrs.prctr = cepct.prctr
                                                                         where bukrs = o.bukrs) end
                                                 when fbto.pay_company_id = o.bukrs
                                                     then case when ((select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) is null or (select count(0)
                                                                                                         from cepc_bukrs
                                                                                                         where bukrs = o.bukrs) = 0 or
                                                                     (select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) > 1)
                                                                   then case when (fbi.prctr != '' and fbi.prctr is not null and o.busi!='6000')
                                                                                 then fbi.prctr
                                                                             when ((select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                   (select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') != '')
                                                                                 then (select ru.profit_center_code
                                                                                       from fss_accounting_rule ru
                                                                                       where ru.organ_id = o.bukrs and type = '2')
                                                                             else rr.profit_center_code end
                                                               when (select count(0)
                                                                     from cepc_bukrs
                                                                     where bukrs = o.bukrs) = 1
                                                                   then (select cepct.prctr
                                                                         from cepc_bukrs
                                                                                  join cepct on cepc_bukrs.prctr = cepct.prctr
                                                                         where bukrs = o.bukrs) end
                                                 end as profit_center_code
                                      FROM fss_bill_info fbi
                                               join fss_bill_transfer_order_connect fbtoc5 on fbi.bill_id=fbtoc5.bill_id
                                               join fss_bill_transfer_order fbto
                                                    on fbtoc5.transfer_id = fbto.transfer_id
                                               JOIN v_organ o ON (fbto.get_company_id = o.bukrs or fbto.pay_company_id = o.bukrs)
                                               JOIN (select
                                                         r.*,
                                                         enum.code
                                                     from fss_accounting_rule r
                                                              left join sec_enum enum on enum.id = r.commercian_unit_id
                                                     where r.type = '1' and r.business_module = '应付票据' and
                                                         r.business_type in ('取消票据开承', '取消票据收承')) as rr
                                                    ON (((rr.organ_id is not null and rr.organ_id != '') and o.bukrs = rr.organ_id) or
                                                        ((rr.organ_id is null or rr.organ_id = '') and o.busi = rr.code))
                                      WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId}
                                        and o.bukrs = fbto.pay_company_id
                                      limit 1)
                            -- 当贷款方的公司id和公司id一致的情况下程序去判断对方的利润中心
                            when fbto.pay_company_id = o.bukrs
                                then (select case
                                                 when fbto.get_company_id = o.bukrs
                                                     then case when ((select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) is null or (select count(0)
                                                                                                         from cepc_bukrs
                                                                                                         where bukrs = o.bukrs) = 0 or
                                                                     (select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) > 1)
                                                                   then case when (fbi.prctr != '' and fbi.prctr is not null and o.busi!='6000')
                                                                                 then fbi.prctr
                                                                             when ((select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                   (select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') != '')
                                                                                 then
                                                                                 (select ru.profit_center_code
                                                                                  from fss_accounting_rule ru
                                                                                  where ru.organ_id = o.bukrs and type = '2')
                                                                             else rr.profit_center_code end
                                                               when (select count(0)
                                                                     from cepc_bukrs
                                                                     where bukrs = o.bukrs) = 1
                                                                   then (select cepct.prctr
                                                                         from cepc_bukrs
                                                                                  join cepct on cepc_bukrs.prctr = cepct.prctr
                                                                         where bukrs = o.bukrs) end
                                                 when fbto.pay_company_id = o.bukrs
                                                     then case when ((select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) is null or (select count(0)
                                                                                                         from cepc_bukrs
                                                                                                         where bukrs = o.bukrs) = 0 or
                                                                     (select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) > 1)
                                                                   then case when (fbi.prctr != '' and fbi.prctr is not null)
                                                                                 then fbi.prctr
                                                                             when ((select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                   (select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') != '')
                                                                                 then
                                                                                 (select ru.profit_center_code
                                                                                  from fss_accounting_rule ru
                                                                                  where ru.organ_id = o.bukrs and type = '2')
                                                                             else rr.profit_center_code end
                                                               when (select count(0)
                                                                     from cepc_bukrs
                                                                     where bukrs = o.bukrs) = 1
                                                                   then (select cepct.prctr
                                                                         from cepc_bukrs
                                                                                  join cepct on cepc_bukrs.prctr = cepct.prctr
                                                                         where bukrs = o.bukrs) end
                                                 end as profit_center_code
                                      FROM fss_bill_info fbi
                                               join fss_bill_transfer_order_connect fbtoc4 on fbi.bill_id=fbtoc4.bill_id
                                               join fss_bill_transfer_order fbto
                                                    on fbtoc4.transfer_id = fbto.transfer_id
                                               JOIN v_organ o ON fbto.get_company_id = o.bukrs
                                               JOIN (select
                                                         r.*,
                                                         enum.code
                                                     from fss_accounting_rule r
                                                              left join sec_enum enum on enum.id = r.commercian_unit_id
                                                     where r.type = '1' and r.business_module = '应付票据' and
                                                         r.business_type in ('取消票据开承', '取消票据收承')) as rr
                                                    ON (((rr.organ_id is not null and rr.organ_id != '') and o.bukrs = rr.organ_id) or
                                                        ((rr.organ_id is null or rr.organ_id = '') and o.busi = rr.code))
                                      WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId}
                                        and o.bukrs = fbto.get_company_id
                                      limit 1)
                            end                                              as opposite_profit_center_code,

                        --这个是判断对方利润中心名称
                        case
                        when fbto.get_company_id = o.bukrs
                        then (select case
                        when fbto.get_company_id = o.bukrs
                        then case when ((select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) is null or (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 0 or
                        (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) > 1)
                        then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                        then fbi.ltext
                        when ((select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') is not null and
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') != '')
                        then
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2')
                        else rr.profit_center end
                        when (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 1
                        then (select cepct.ltext
                        from cepc_bukrs
                        join cepct on cepc_bukrs.prctr = cepct.prctr
                        where bukrs = o.bukrs) end
                        when fbto.pay_company_id = o.bukrs
                        then case when ((select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) is null or (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 0 or
                        (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) > 1)
                        then case when (fbi.ltext != '' and fbi.ltext is not null)
                        then fbi.ltext
                        when ((select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') is not null and
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') != '')
                        then
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2')
                        else rr.profit_center end
                        when (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 1
                        then (select cepct.ltext
                        from cepc_bukrs
                        join cepct on cepc_bukrs.prctr = cepct.prctr
                        where bukrs = o.bukrs) end
                        end as profit_center

                        FROM fss_bill_info fbi
                        join fss_bill_transfer_order_connect fbtoc3 on fbi.bill_id=fbtoc3.bill_id
                        join fss_bill_transfer_order fbto   on fbtoc3.transfer_id = fbto.transfer_id
                        JOIN v_organ o ON (fbto.get_company_id = o.bukrs or fbto.pay_company_id = o.bukrs)
                        JOIN (select
                        r.*,
                        enum.code
                        from fss_accounting_rule r
                        left join sec_enum enum on enum.id = r.commercian_unit_id
                        where r.type = '1') as rr
                        ON rr.business_module = '应付票据' AND
                        (rr.business_type = '取消票据开承' or rr.business_type = '取消票据收承') AND
                        (o.busi = rr.code OR fbto.company_name_id = rr.organ_id)
                        WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId}
                        and o.bukrs = fbto.pay_company_id
                        limit 1)
                        when fbto.pay_company_id = o.bukrs
                        then (select case when fbto.get_company_id = o.bukrs
                        then case when ((select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) is null or (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 0 or (select count(0)
                        from cepc_bukrs
                        where
                        bukrs = o.bukrs)
                            > 1)
                        then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                        then fbi.ltext
                        when ((select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') is not null and
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') != '')
                        then
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2')
                        else rr.profit_center end
                        when (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 1
                        then (select cepct.ltext
                        from cepc_bukrs
                        join cepct on cepc_bukrs.prctr = cepct.prctr
                        where bukrs = o.bukrs) end
                        -- 判断对方利润中心名称  公司和付款公司一致的情况
                        when fbto.pay_company_id = o.bukrs
                        then case when ((select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) is null or (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 0 or
                        (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) > 1)
                        then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                        then fbi.ltext
                        when ((select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') is not null and
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') != '')
                        then
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2')
                        else rr.profit_center end
                        when (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 1
                        then (select cepct.ltext
                        from cepc_bukrs
                        join cepct on cepc_bukrs.prctr = cepct.prctr
                        where bukrs = o.bukrs) end
                        end as profit_center

                        FROM fss_bill_info fbi
                        join   fss_bill_transfer_order_connect fbtoc2 on fbi.bill_id =fbtoc2.bill_id
                        join fss_bill_transfer_order fbto    on fbtoc2.transfer_id = fbto.transfer_id
                        JOIN v_organ o ON (fbto.get_company_id = o.bukrs or fbto.pay_company_id = o.bukrs)
                        JOIN (select
                        r.*,
                        enum.code
                        from fss_accounting_rule r
                        left join sec_enum enum on enum.id = r.commercian_unit_id
                        where r.type = '1') as rr
                        ON rr.business_module = '应付票据' AND
                        (rr.business_type = '取消票据开承' or rr.business_type = '取消票据收承') AND
                        (o.busi = rr.code OR fbto.company_name_id = rr.organ_id)
                        WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId}
                        and o.bukrs = fbto.get_company_id
                        limit 1)
                        end                                              as opposite_profit_center,
                        rr.rule_id,
                        rr.commercian_unit_id,
                        rr.commercian_unit,
                        rr.business_module_id,
                        rr.business_module,
                        rr.business_type,
                        rr.loan_term,
                        rr.project_stage,
                        rr.borrow_loan,
                        rr.subject_type,
                        rr.project_code,
                        rr.project_name,
                        rr.cost_center_code,
                        rr.cost_center,
                        rr.wbs_element_code,
                        rr.wbs_element,
                        rr.reason_code,
                        rr.internal_order,
                        rr.is_clear,
                        rr.type,
                        rr.remarks,
                        rr.status,
                        fbi.bill_number,
                        rr.reserve,
                        rr.create_time,
                        rr.creator,
                        rr.update_time,
                        rr.updater,
                        rr.deleted,
                        rr.business_type_list,
                        rr.subject_type_list,
                        rr.tran_type,
                        o.bukrs                                          as organ_id,
                        o.full_name                                      as organ_name,
                        fbi.bill_id                                      as fw_id,
                        coalesce(fbi.drawer_amount, 0)                   as drawer_amount,
                        fbto.pay_company,
                        fbto.pay_company_id,
                        fbto.get_company,
                        fbto.get_company_id,
                        coalesce(fbto.money_small, 0)                    as money_start,
                        fbto.transfer_id                                 as sub_id,
                        case
                        when fbi.bill_class in ('纸质银行承兑汇票', '电子银行承兑汇票')
                        then '银行开承'
                        when fbi.bill_class in ('纸质商业承兑汇票', '电子商业承兑汇票')
                        then '商业开承' end                                as check_no,
                        fbi.payer_account                                   as payer_account,
                         case
                when rr.subject_type = '中转科目' then ''
                when  rr.subject_type = '应付票据' or rr.subject_type = '应收票据' then fbi.moneyorder_start::text
                else fbto.approval_time::text
                end  as contract_repayment_date,
                        fbto.approval_time                               as credit_date,
                        (select code from fss_base_currency where id=fbi.currency_id )as currency
                    FROM fss_bill_info fbi
                        left join fss_bill_transfer_order_connect fbtoc on fbi.bill_id = fbtoc.bill_id
                        join fss_bill_transfer_order fbto       on fbtoc.transfer_id = fbto.transfer_id
                        JOIN v_organ o ON (fbto.get_company_id = o.bukrs or fbto.pay_company_id = o.bukrs)
                        JOIN (select
                        r.*,
                        enum.code
                        from fss_accounting_rule r
                        left join sec_enum enum on enum.id = r.commercian_unit_id
                        where r.type = '1' and r.business_module = '应付票据' and r.business_type in ('取消票据开承', '取消票据收承')) as rr
                        ON (((rr.organ_id is not null and rr.organ_id != '') and o.bukrs = rr.organ_id) or
                        ((rr.organ_id is null or rr.organ_id = '') and o.busi = rr.code))
                    WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId} and ((rr.subject_type = '应付票据' and
                        ((fbi.bill_class in
                        ('纸质商业承兑汇票', '电子商业承兑汇票') and
                        rr.bill_form = '商业')
                        or (fbi.bill_class in
                        ('电子银行承兑汇票', '纸质银行承兑汇票') and
                        rr.bill_form = '银行'))
                        ) or rr.subject_type = '应收票据')
                        and ((fbto.get_company_id = o.bukrs and rr.business_type = '取消票据收承') or
                        (fbto.pay_company_id = o.bukrs and rr.business_type = '取消票据开承'))
                   ) as rule) as rru
        order by rru.business_type,rru.organ_name,rru.subject_type
    </select>
    <select id="queryBillAccountingRuleCacelTwo"  resultMap="BaseResultMapVO">
        select
            '未入账'                                     as entry_status,
            ''                                        as cost_center,
            (select t053s.txt40
             from t053s
             where t053s.bukrs = rru.organ_id
               and t053s.rstgr = rru.reason_code) as reason_code_text,

            rru.subject_type,
            rru.*
        from (select
                  ''            as cost_center_code,
                  rule.subject,
                  rule.subject_text,
                  rule.profit_center_code,
                  rule.profit_center,
                  rule.opposite_profit_center_code,
                  rule.opposite_profit_center,
                  case
                      when (select skb1.mitkz
                            from skb1
                            where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                           ('D', 'K')
                          then case when rule.organ_id = rule.pay_company_id
                                        then rule.get_company_id
                                    when rule.organ_id = rule.get_company_id
                                        then rule.pay_company_id
                                    else '' end
                      else '' end   as lifnr,
                  case
                      when (select skb1.mitkz
                            from skb1
                            where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                           ('D', 'K')
                          then case
                                   when rule.organ_id = rule.pay_company_id
                                       then rule.get_company
                                   when rule.organ_id = rule.get_company_id
                                       then rule.pay_company
                                   else '' end
                      else '' end   as lifnr_text,
                  case
                      when rule.subject_type = '应付票据' or rule.subject_type = '应收票据'
                          then coalesce(rule.drawer_amount, 0)
                      when rule.subject_type = '应付账款' or rule.subject_type = '应收账款' or rule.subject_type = '中转科目'
                          then coalesce(rule.money_start, 0)
                      else 0 end    as amount,
                  rule.rule_id,
                  rule.commercian_unit_id,
                  rule.commercian_unit,
                  rule.business_module_id,
                  rule.business_module,
                  rule.business_type,
                  rule.loan_term,
                  rule.project_stage,
                  rule.borrow_loan,
                  rule.subject_type,
                  rule.project_code,
                  rule.project_name,
                  rule.wbs_element_code,
                  rule.wbs_element,
                  rule.reason_code,
                  rule.internal_order,
                  rule.is_clear,
                  rule.type,
                  rule.remarks,
                  rule.status,
                  rule.reserve,
                  rule.create_time,
                  rule.creator,
                  rule.update_time,
                  rule.updater,
                  rule.deleted,
                  rule.business_type_list,
                  rule.subject_type_list,
                  rule.tran_type,
                  rule.organ_id,
                  rule.organ_name,
                  rule.fw_id,
                  rule.drawer_amount,
                  rule.pay_company,
                  rule.pay_company_id,
                  rule.get_company,
                  rule.get_company_id,
                  rule.money_start,
                  rule.sub_id,
                  case when rule.subject_type = '应收票据' and (select skb1.mitkz
                                                            from skb1
                                                            where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) not in
                                                           ('D', 'K')
                           then rule.bill_number
                       when rule.business_type = '取消票据开承'
                           then concat('向', rule.get_company, '开立承兑')
                       when rule.business_type = '取消票据收承'
                           then concat('收到', rule.pay_company, '承兑')
                      end           as summary,
                  rule.contract_repayment_date as expiry_date,
                     /*  case
                      when  (select skb1.mitkz
                             from skb1
                             where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject) not in
                            ('D', 'K') or rule.subject_type in('应收账款','应付账款')
                          then rule.contract_repayment_date
                      else null end as expiry_date,*/
                  rule.credit_date,
                  rule.currency,



                  case when (select skb1.mitkz
                             from skb1
                             where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                            ('D', 'K') and subject_type='应付票据'
                           then rule.payer_account
                       else '' end          as payer_account,
                  case when (select skb1.mitkz
                             from skb1
                             where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                            ('D', 'K') and subject_type='应付票据'
                           then rule.check_no
                       else '' end          as check_no,

                  case when (select skb1.mitkz
                             from skb1
                             where skb1.bukrs = rule.organ_id and skb1.saknr = rule.subject limit 1) in
                            ('D', 'K') and subject_type='应付票据'
                           then rule.bill_number
                       else '' end          as bill_number
              from (SELECT
                        rr.subject,
                        case
                            when (rr.subject = '' or rr.subject is null)
                                then ''
                            else (select skat.txt50
                                  from skat
                                           join t001 on t001.ktopl = skat.ktopl and skat.spras ='1'
                                  where skat.saknr = rr.subject
                                    and t001.bukrs = fbi.company_id) end as subject_text,
                        case --这个是判断利润中心编码
                            when fbto.get_company_id = o.bukrs --内部借款对应公司名称是收款方的
                                then case when ((select count(0)
                                                 from cepc_bukrs
                                                 where bukrs = o.bukrs) is null or (select count(0)
                                                                                    from cepc_bukrs
                                                                                    where bukrs = o.bukrs) = 0 or (select count(0)
                                                                                                                   from cepc_bukrs
                                                                                                                   where
                                                                                                                       bukrs = o.bukrs) >
                                                                                                                  1)
                                --这个是从项目中找
                                              then case when (fbi.prctr != '' and fbi.prctr is not null)
                                                            then fbi.prctr
                                                        else
                                                            -- 先从利润中心找
                                                            case when ((select ru.profit_center_code
                                                                        from fss_accounting_rule ru
                                                                        where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                -- 在自己配置  费用科目中配置
                                                                       (select ru.profit_center_code
                                                                        from fss_accounting_rule ru
                                                                        where ru.organ_id = o.bukrs and type = '2') != '')
                                                                     then
                                                                     (select ru.profit_center_code
                                                                      from fss_accounting_rule ru
                                                                      where ru.organ_id = o.bukrs and type = '2')
                                                                 else rr.profit_center_code end end
                                -- 查看会计规则中配置
                                          when (select count(0)
                                                from cepc_bukrs
                                                where bukrs = o.bukrs) = 1
                                              then (select cepct.prctr
                                                    from cepc_bukrs
                                                             join cepct on cepc_bukrs.prctr = cepct.prctr
                                                    where bukrs = o.bukrs) end
                            when fbto.pay_company_id = o.bukrs --内部借款对应公司名称是贷款方的
                                then case when ((select count(0)
                                                 from cepc_bukrs
                                                 where bukrs = o.bukrs) is null or (select count(0)
                                                                                    from cepc_bukrs
                                                                                    where bukrs = o.bukrs) = 0 or (select count(0)
                                                                                                                   from cepc_bukrs
                                                                                                                   where
                                                                                                                       bukrs = o.bukrs) >
                                                                                                                  1)
                                              then case when (fbi.prctr != '' and fbi.prctr is not null)
                                                            then fbi.prctr
                                                        else case when ((select ru.profit_center_code
                                                                         from fss_accounting_rule ru
                                                                         where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                        (select ru.profit_center_code
                                                                         from fss_accounting_rule ru
                                                                         where ru.organ_id = o.bukrs and type = '2') != '')
                                                                      then
                                                                      (select ru.profit_center_code
                                                                       from fss_accounting_rule ru
                                                                       where ru.organ_id = o.bukrs and type = '2')
                                                                  else rr.profit_center_code end end
                                          when (select count(0)
                                                from cepc_bukrs
                                                where bukrs = o.bukrs) = 1
                                              then (select cepct.prctr
                                                    from cepc_bukrs
                                                             join cepct on cepc_bukrs.prctr = cepct.prctr
                                                    where bukrs = o.bukrs) end
                            end                                              as profit_center_code,
                        case --这个是判断利润中心名称
                            when fbto.get_company_id = o.bukrs
                                then case when ((select count(0)
                                                 from cepc_bukrs
                                                 where bukrs = o.bukrs) is null or (select count(0)
                                                                                    from cepc_bukrs
                                                                                    where bukrs = o.bukrs) = 0 or (select count(0)
                                                                                                                   from cepc_bukrs
                                                                                                                   where
                                                                                                                       bukrs = o.bukrs) >
                                                                                                                  1)
                                              then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                                                            then fbi.ltext
                                                        else
                                                            case when ((select ru.profit_center_code
                                                                        from fss_accounting_rule ru
                                                                        where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                       (select ru.profit_center_code
                                                                        from fss_accounting_rule ru
                                                                        where ru.organ_id = o.bukrs and type = '2') != '')
                                                                     then
                                                                     (select ru.profit_center_code
                                                                      from fss_accounting_rule ru
                                                                      where ru.organ_id = o.bukrs and type = '2')
                                                                 else rr.profit_center end end
                                          when (select count(0)
                                                from cepc_bukrs
                                                where bukrs = o.bukrs) = 1
                                              then (select cepct.ltext
                                                    from cepc_bukrs
                                                             join cepct on cepc_bukrs.prctr = cepct.prctr
                                                    where bukrs = o.bukrs) end
                            when fbto.pay_company_id = o.bukrs
                                then case when ((select count(0)
                                                 from cepc_bukrs
                                                 where bukrs = o.bukrs) is null or (select count(0)
                                                                                    from cepc_bukrs
                                                                                    where bukrs = o.bukrs) = 0 or (select count(0)
                                                                                                                   from cepc_bukrs
                                                                                                                   where
                                                                                                                       bukrs = o.bukrs) >
                                                                                                                  1)
                                              then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                                                            then fbi.ltext
                                                        else case when ((select ru.profit_center_code
                                                                         from fss_accounting_rule ru
                                                                         where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                        (select ru.profit_center_code
                                                                         from fss_accounting_rule ru
                                                                         where ru.organ_id = o.bukrs and type = '2') != '')
                                                                      then
                                                                      (select ru.profit_center_code
                                                                       from fss_accounting_rule ru
                                                                       where ru.organ_id = o.bukrs and type = '2')
                                                                  else rr.profit_center end end
                                          when (select count(0)
                                                from cepc_bukrs
                                                where bukrs = o.bukrs) = 1
                                              then (select cepct.ltext
                                                    from cepc_bukrs
                                                             join cepct on cepc_bukrs.prctr = cepct.prctr
                                                    where bukrs = o.bukrs) end
                            end                                              as profit_center,
                        -- 这个是判断对方利润中心编码
                        case -- get_company_id 提款方  lender_company_id贷款方
                        -- 当提款方的公司id和公司id一致的情况下程序去判断对方的利润中心
                            when fbto.get_company_id = o.bukrs
                                then (select case
                                                 when fbto.get_company_id = o.bukrs
                                                     then case when ((select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) is null or (select count(0)
                                                                                                         from cepc_bukrs
                                                                                                         where bukrs = o.bukrs) = 0 or
                                                                     (select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) > 1)
                                                                   then case when (fbi.prctr != '' and fbi.prctr is not null and o.busi!='6000')
                                                                                 then fbi.prctr
                                                                             when ((select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                   (select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') != '')
                                                                                 then
                                                                                 (select ru.profit_center_code
                                                                                  from fss_accounting_rule ru
                                                                                  where ru.organ_id = o.bukrs and type = '2')
                                                                             else rr.profit_center_code end
                                                               when (select count(0)
                                                                     from cepc_bukrs
                                                                     where bukrs = o.bukrs) = 1
                                                                   then (select cepct.prctr
                                                                         from cepc_bukrs
                                                                                  join cepct on cepc_bukrs.prctr = cepct.prctr
                                                                         where bukrs = o.bukrs) end
                                                 when fbto.pay_company_id = o.bukrs
                                                     then case when ((select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) is null or (select count(0)
                                                                                                         from cepc_bukrs
                                                                                                         where bukrs = o.bukrs) = 0 or
                                                                     (select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) > 1)
                                                                   then case when (fbi.prctr != '' and fbi.prctr is not null and o.busi!='6000')
                                                                                 then fbi.prctr
                                                                             when ((select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                   (select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') != '')
                                                                                 then (select ru.profit_center_code
                                                                                       from fss_accounting_rule ru
                                                                                       where ru.organ_id = o.bukrs and type = '2')
                                                                             else rr.profit_center_code end
                                                               when (select count(0)
                                                                     from cepc_bukrs
                                                                     where bukrs = o.bukrs) = 1
                                                                   then (select cepct.prctr
                                                                         from cepc_bukrs
                                                                                  join cepct on cepc_bukrs.prctr = cepct.prctr
                                                                         where bukrs = o.bukrs) end
                                                 end as profit_center_code
                                      FROM fss_bill_info fbi
                                               join fss_bill_transfer_order_connect fbtoc5 on fbi.bill_id=fbtoc5.bill_id
                                               join fss_bill_transfer_order fbto
                                                    on fbtoc5.transfer_id = fbto.transfer_id
                                               JOIN v_organ o ON (fbto.get_company_id = o.bukrs or fbto.pay_company_id = o.bukrs)
                                               JOIN (select
                                                         r.*,
                                                         enum.code
                                                     from fss_accounting_rule r
                                                              left join sec_enum enum on enum.id = r.commercian_unit_id
                                                     where r.type = '1' and r.business_module = '应付票据' and
                                                         r.business_type in ('取消票据开承', '取消票据收承')) as rr
                                                    ON (((rr.organ_id is not null and rr.organ_id != '') and o.bukrs = rr.organ_id) or
                                                        ((rr.organ_id is null or rr.organ_id = '') and o.busi = rr.code))
                                      WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId}
                                        and o.bukrs = fbto.pay_company_id
                                      limit 1)
                            -- 当贷款方的公司id和公司id一致的情况下程序去判断对方的利润中心
                            when fbto.pay_company_id = o.bukrs
                                then (select case
                                                 when fbto.get_company_id = o.bukrs
                                                     then case when ((select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) is null or (select count(0)
                                                                                                         from cepc_bukrs
                                                                                                         where bukrs = o.bukrs) = 0 or
                                                                     (select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) > 1)
                                                                   then case when (fbi.prctr != '' and fbi.prctr is not null and o.busi!='6000')
                                                                                 then fbi.prctr
                                                                             when ((select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                   (select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') != '')
                                                                                 then
                                                                                 (select ru.profit_center_code
                                                                                  from fss_accounting_rule ru
                                                                                  where ru.organ_id = o.bukrs and type = '2')
                                                                             else rr.profit_center_code end
                                                               when (select count(0)
                                                                     from cepc_bukrs
                                                                     where bukrs = o.bukrs) = 1
                                                                   then (select cepct.prctr
                                                                         from cepc_bukrs
                                                                                  join cepct on cepc_bukrs.prctr = cepct.prctr
                                                                         where bukrs = o.bukrs) end
                                                 when fbto.pay_company_id = o.bukrs
                                                     then case when ((select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) is null or (select count(0)
                                                                                                         from cepc_bukrs
                                                                                                         where bukrs = o.bukrs) = 0 or
                                                                     (select count(0)
                                                                      from cepc_bukrs
                                                                      where bukrs = o.bukrs) > 1)
                                                                   then case when (fbi.prctr != '' and fbi.prctr is not null)
                                                                                 then fbi.prctr
                                                                             when ((select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') is not null and
                                                                                   (select ru.profit_center_code
                                                                                    from fss_accounting_rule ru
                                                                                    where ru.organ_id = o.bukrs and type = '2') != '')
                                                                                 then
                                                                                 (select ru.profit_center_code
                                                                                  from fss_accounting_rule ru
                                                                                  where ru.organ_id = o.bukrs and type = '2')
                                                                             else rr.profit_center_code end
                                                               when (select count(0)
                                                                     from cepc_bukrs
                                                                     where bukrs = o.bukrs) = 1
                                                                   then (select cepct.prctr
                                                                         from cepc_bukrs
                                                                                  join cepct on cepc_bukrs.prctr = cepct.prctr
                                                                         where bukrs = o.bukrs) end
                                                 end as profit_center_code
                                      FROM fss_bill_info fbi
                                               join fss_bill_transfer_order_connect fbtoc4 on fbi.bill_id=fbtoc4.bill_id
                                               join fss_bill_transfer_order fbto
                                                    on fbtoc4.transfer_id = fbto.transfer_id
                                               JOIN v_organ o ON fbto.get_company_id = o.bukrs
                                               JOIN (select
                                                         r.*,
                                                         enum.code
                                                     from fss_accounting_rule r
                                                              left join sec_enum enum on enum.id = r.commercian_unit_id
                                                     where r.type = '1' and r.business_module = '应付票据' and
                                                         r.business_type in ('取消票据开承', '取消票据收承')) as rr
                                                    ON (((rr.organ_id is not null and rr.organ_id != '') and o.bukrs = rr.organ_id) or
                                                        ((rr.organ_id is null or rr.organ_id = '') and o.busi = rr.code))
                                      WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId}
                                        and o.bukrs = fbto.get_company_id
                                      limit 1)
                            end                                              as opposite_profit_center_code,

                        --这个是判断对方利润中心名称
                        case
                        when fbto.get_company_id = o.bukrs
                        then (select case
                        when fbto.get_company_id = o.bukrs
                        then case when ((select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) is null or (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 0 or
                        (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) > 1)
                        then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                        then fbi.ltext
                        when ((select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') is not null and
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') != '')
                        then
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2')
                        else rr.profit_center end
                        when (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 1
                        then (select cepct.ltext
                        from cepc_bukrs
                        join cepct on cepc_bukrs.prctr = cepct.prctr
                        where bukrs = o.bukrs) end
                        when fbto.pay_company_id = o.bukrs
                        then case when ((select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) is null or (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 0 or
                        (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) > 1)
                        then case when (fbi.ltext != '' and fbi.ltext is not null)
                        then fbi.ltext
                        when ((select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') is not null and
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') != '')
                        then
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2')
                        else rr.profit_center end
                        when (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 1
                        then (select cepct.ltext
                        from cepc_bukrs
                        join cepct on cepc_bukrs.prctr = cepct.prctr
                        where bukrs = o.bukrs) end
                        end as profit_center

                        FROM fss_bill_info fbi
                        join fss_bill_transfer_order_connect fbtoc3 on fbi.bill_id=fbtoc3.bill_id
                        join fss_bill_transfer_order fbto   on fbtoc3.transfer_id = fbto.transfer_id
                        JOIN v_organ o ON (fbto.get_company_id = o.bukrs or fbto.pay_company_id = o.bukrs)
                        JOIN (select
                        r.*,
                        enum.code
                        from fss_accounting_rule r
                        left join sec_enum enum on enum.id = r.commercian_unit_id
                        where r.type = '1') as rr
                        ON rr.business_module = '应付票据' AND
                        (rr.business_type = '取消票据开承' or rr.business_type = '取消票据收承') AND
                        (o.busi = rr.code OR fbto.company_name_id = rr.organ_id)
                        WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId}
                        and o.bukrs = fbto.pay_company_id
                        limit 1)
                        when fbto.pay_company_id = o.bukrs
                        then (select case when fbto.get_company_id = o.bukrs
                        then case when ((select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) is null or (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 0 or (select count(0)
                        from cepc_bukrs
                        where
                        bukrs = o.bukrs)
                            > 1)
                        then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                        then fbi.ltext
                        when ((select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') is not null and
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') != '')
                        then
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2')
                        else rr.profit_center end
                        when (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 1
                        then (select cepct.ltext
                        from cepc_bukrs
                        join cepct on cepc_bukrs.prctr = cepct.prctr
                        where bukrs = o.bukrs) end
                        -- 判断对方利润中心名称  公司和付款公司一致的情况
                        when fbto.pay_company_id = o.bukrs
                        then case when ((select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) is null or (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 0 or
                        (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) > 1)
                        then case when (fbi.ltext != '' and fbi.ltext is not null and o.busi!='6000')
                        then fbi.ltext
                        when ((select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') is not null and
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2') != '')
                        then
                        (select ru.profit_center_code
                        from fss_accounting_rule ru
                        where ru.organ_id = o.bukrs and type = '2')
                        else rr.profit_center end
                        when (select count(0)
                        from cepc_bukrs
                        where bukrs = o.bukrs) = 1
                        then (select cepct.ltext
                        from cepc_bukrs
                        join cepct on cepc_bukrs.prctr = cepct.prctr
                        where bukrs = o.bukrs) end
                        end as profit_center

                        FROM fss_bill_info fbi
                        join   fss_bill_transfer_order_connect fbtoc2 on fbi.bill_id =fbtoc2.bill_id
                        join fss_bill_transfer_order fbto    on fbtoc2.transfer_id = fbto.transfer_id
                        JOIN v_organ o ON (fbto.get_company_id = o.bukrs or fbto.pay_company_id = o.bukrs)
                        JOIN (select
                        r.*,
                        enum.code
                        from fss_accounting_rule r
                        left join sec_enum enum on enum.id = r.commercian_unit_id
                        where r.type = '1') as rr
                        ON rr.business_module = '应付票据' AND
                        (rr.business_type = '取消票据开承' or rr.business_type = '取消票据收承') AND
                        (o.busi = rr.code OR fbto.company_name_id = rr.organ_id)
                        WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId}
                        and o.bukrs = fbto.get_company_id
                        limit 1)
                        end                                              as opposite_profit_center,
                        rr.rule_id,
                        rr.commercian_unit_id,
                        rr.commercian_unit,
                        rr.business_module_id,
                        rr.business_module,
                        rr.business_type,
                        rr.loan_term,
                        rr.project_stage,
                        rr.borrow_loan,
                        rr.subject_type,
                        rr.project_code,
                        rr.project_name,
                        rr.cost_center_code,
                        rr.cost_center,
                        rr.wbs_element_code,
                        rr.wbs_element,
                        rr.reason_code,
                        rr.internal_order,
                        rr.is_clear,
                        rr.type,
                        rr.remarks,
                        rr.status,
                        fbi.bill_number,
                        rr.reserve,
                        rr.create_time,
                        rr.creator,
                        rr.update_time,
                        rr.updater,
                        rr.deleted,
                        rr.business_type_list,
                        rr.subject_type_list,
                        rr.tran_type,
                        o.bukrs                                          as organ_id,
                        o.full_name                                      as organ_name,
                        fbi.bill_id                                      as fw_id,
                        coalesce(fbi.drawer_amount, 0)                   as drawer_amount,
                        fbto.pay_company,
                        fbto.pay_company_id,
                        fbto.get_company,
                        fbto.get_company_id,
                        coalesce(fbto.money_small, 0)                    as money_start,
                        fbto.transfer_id                                 as sub_id,
                        case
                        when fbi.bill_class in ('纸质银行承兑汇票', '电子银行承兑汇票')
                        then '银行开承'
                        when fbi.bill_class in ('纸质商业承兑汇票', '电子商业承兑汇票')
                        then '商业开承' end                                as check_no,
                        fbi.payer_account                                   as payer_account,
                         case
                when rr.subject_type = '中转科目' then ''
                when  rr.subject_type = '应付票据' or rr.subject_type = '应收票据' then fbi.moneyorder_start::text
                else fbto.approval_time::text
                end  as contract_repayment_date,
                        fbto.approval_time                               as credit_date,
                        (select code from fss_base_currency where id=fbi.currency_id )as currency
                    from fss_bill_transfer_order fbto
                        left join fss_bill_transfer_order_connect fbtoc on fbtoc.transfer_id = fbto.transfer_id
                        join  (select fbi2.*,fbtoc6.transfer_id from fss_bill_info fbi2 left join fss_bill_transfer_order_connect fbtoc6 on fbi2.bill_id=fbtoc6.bill_id
                        where fbtoc6.transfer_id=#{fssBillAccountingDocuments.subId} limit 1 )  as fbi on fbi.bill_id = fbtoc.bill_id
                        JOIN v_organ o ON (fbto.get_company_id = o.bukrs or fbto.pay_company_id = o.bukrs)
                        JOIN (select
                        r.*,
                        enum.code
                        from fss_accounting_rule r
                        left join sec_enum enum on enum.id = r.commercian_unit_id
                        where r.type = '1' and r.business_module = '应付票据' and r.business_type in ('取消票据开承', '取消票据收承')) as rr
                        ON (((rr.organ_id is not null and rr.organ_id != '') and o.bukrs = rr.organ_id) or
                        ((rr.organ_id is null or rr.organ_id = '') and o.busi = rr.code))
                    WHERE fbto.transfer_id =#{fssBillAccountingDocuments.subId} and rr.subject_type in ('应付账款','中转科目','应收账款')
                        and ((fbto.get_company_id = o.bukrs and rr.business_type = '取消票据收承') or
                        (fbto.pay_company_id = o.bukrs and rr.business_type = '取消票据开承'))
                   ) as rule) as rru
        order by  rru.business_type,rru.organ_name,rru.subject_type
    </select>
    <select id="selectBankByAccou" resultType="java.lang.String">
        select bankl from fclm_bam_amd where acc_num=#{accou} limit 1;
    </select>

    <select id="queryReversalByGroupNo" resultMap="BaseResultMap">
        select * from fss_bill_accounting_documents
        <where>
            <if test="fssInnerLoanAccountingDocuments.groupNo != null and fssInnerLoanAccountingDocuments.groupNo != ''">
                group_no=#{fssInnerLoanAccountingDocuments.groupNo}
            </if>
            <if test="fssInnerLoanAccountingDocuments.subId != null and fssInnerLoanAccountingDocuments.subId != ''">
                and sub_id=#{fssInnerLoanAccountingDocuments.subId}
            </if>
            <if test="fssInnerLoanAccountingDocuments.entryStatus != null and fssInnerLoanAccountingDocuments.entryStatus != ''">
                and entry_status=#{fssInnerLoanAccountingDocuments.entryStatus}
            </if>
            <if test="fssInnerLoanAccountingDocuments.type != null and fssInnerLoanAccountingDocuments.type != ''">
                and entry_status=#{fssInnerLoanAccountingDocuments.entryStatus}
            </if>
            <if test="fssInnerLoanAccountingDocuments.reversalStatus != null and fssInnerLoanAccountingDocuments.reversalStatus != ''">
                and typ =#{fssInnerLoanAccountingDocuments.type}
            </if>
            <if test="fssInnerLoanAccountingDocuments.reversalStatus == null or fssInnerLoanAccountingDocuments.reversalStatus == ''">
                and (reversal_status is null or reversal_status='' or reversal_status = '未冲销')
            </if>
            <if test="nos != null and nos.size &gt; 0">
                and document_no in
                <foreach collection="nos" item="no" separator="," open="(" close=")">#{no}</foreach>
            </if>
        </where>
    </select>

    <select id="queryEntryNumberBySapNo" resultType="java.lang.String">
        select entry_number from fss_bill_accounting_documents where document_no=#{documentNo} limit 1
    </select>
    <delete id="delFssBillAccountingDocuments">
       delete from fss_bill_accounting_documents  where sub_id=#{subId} and entry_status='未入账'  and entry_type=#{entryType}
    </delete>
</mapper>
